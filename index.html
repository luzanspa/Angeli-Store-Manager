<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angeli - Controle de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #ff69b4;
            --primary-dark: #d13a83;
            --primary-light: #f8f0f4;
            --secondary: #6c757d;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --radius: 10px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --card-bg: #ffffff;
            --bg-color: #f8f0f4;
            --text-color: #333333;
        }

        /* Tema Azul Profissional */
        .theme-blue {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --primary-light: #eaf2f8;
            --bg-color: #f0f7ff;
            --card-bg: #ffffff;
        }

        /* Tema Verde Natureza */
        .theme-green {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --primary-light: #eafaf1;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
        }

        /* Tema Escuro */
        .theme-dark {
            --primary: #9b59b6;
            --primary-dark: #8e44ad;
            --primary-light: #2c3e50;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --secondary: #bdc3c7;
            --light: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 2rem;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .slide-in {
            animation: slideIn 0.4s ease forwards;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.2rem 0.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }

        header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            padding: 0 0.5rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 50px;
            margin: 0.5rem 0.5rem 0;
            font-size: 0.75rem;
        }

        #lastBackup {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 0.8rem;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .card h3 {
            color: var(--primary-dark);
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 0.3rem 0;
        }

        .stat-desc {
            color: var(--secondary);
            font-size: 0.75rem;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Action Buttons */
        .angeli-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            padding: 0.8rem 0.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            background: var(--card-bg);
            color: var(--primary-dark);
            box-shadow: var(--shadow);
            font-size: 0.85rem;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 0.8rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 3px solid transparent;
            font-size: 0.85rem;
            min-width: 80px;
        }

        .tab.active {
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            background: var(--primary-light);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 105, 180, 0.1);
        }

        /* Content Sections */
        .section {
            display: none;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .section-header h2 {
            color: var(--primary-dark);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-filter-bar {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            flex-wrap: wrap;
        }

        .search-filter-bar input,
        .search-filter-bar select {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            flex-grow: 1;
            font-family: 'Inter', sans-serif;
            background: var(--card-bg);
            color: var(--text-color);
            min-width: 120px; /* Adjust as needed */
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            background: var(--card-bg);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .product-image {
            height: 140px;
            background: linear-gradient(135deg, var(--primary-light), #ffddee);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .product-info {
            padding: 0.8rem;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--text-color);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-sku {
            color: var(--secondary);
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .product-price {
            color: var(--success);
        }

        .product-stock {
            color: var(--info);
        }

        .product-stock.low {
            color: var(--danger);
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            border-top: 1px solid #eee;
            padding-top: 0.8rem;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 0.3rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.8rem;
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .btn-edit {
            color: var(--info);
        }

        .btn-delete {
            color: var(--danger);
        }

        /* Sales Table */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .sales-table th,
        .sales-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .sales-table th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .sales-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-paid {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.15);
            color: var(--warning);
        }

        .status-overdue {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(30px);
            opacity: 0;
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 1.2rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .modal-footer {
            padding: 1rem;
            background: var(--primary-light);
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        /* Sale Items */
        .sale-items {
            margin: 1rem 0;
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            background: var(--card-bg);
        }

        .sale-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
        }

        .sale-item:last-child {
            border-bottom: none;
        }

        .sale-item-info {
            flex: 1;
        }

        .sale-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
        }

        /* Charts */
        .chart-container {
            height: 250px;
            margin-top: 1.2rem;
        }

        /* File Input */
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 1.5rem;
            border: 2px dashed #ddd;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-color);
        }

        .file-input-label:hover {
            border-color: var(--primary);
        }

        .file-input-label i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        /* Installment Table */
        .installment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .installment-table th,
        .installment-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .installment-table th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
        }

        .installment-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .tabs {
                flex-direction: row;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 0.6rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-filter-bar {
                width: 100%;
                flex-direction: column; /* Stack filters vertically on small screens */
            }
            .search-filter-bar input,
            .search-filter-bar select {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .product-image {
                height: 120px;
            }
            
            .modal-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .angeli-actions {
                grid-template-columns: 1fr;
            }
            
            .product-card {
                max-width: 100%;
            }
        }

        /* Message Box */
        #messageBox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 300px;
        }

        .message {
            padding: 0.8rem 1.2rem;
            border-radius: var(--radius);
            margin-bottom: 0.8rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transform: translateX(120%);
            opacity: 0;
            transition: var(--transition);
            animation: slideIn 0.5s ease forwards;
            font-size: 0.9rem;
        }

        .message.show {
            transform: translateX(0);
            opacity: 1;
        }

        .message.success {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .message.error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .message.warning {
            background: rgba(255, 193, 7, 0.9);
            color: white;
        }

        .message.info {
            background: rgba(23, 162, 184, 0.9);
            color: white;
        }

        /* Empty state styles */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        /* Confirmation Modal */
        #confirmationModal .modal {
            max-width: 400px;
            text-align: center;
        }
        #confirmationModal .modal-body {
            padding-bottom: 0.5rem;
        }
        #confirmationModal .modal-body i {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 1rem;
        }
        #confirmationModal .modal-body p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }
        #confirmationModal .modal-footer {
            justify-content: center;
            padding-top: 0;
            background: none;
        }
    </style>
</head>
<body class="theme-pink">
    <!-- Header -->
    <header>
        <h1><i class="fas fa-boxes"></i> Angeli - Controle de Estoque</h1>
        <div class="status-bar">
            <div id="lastBackup"><i class="fas fa-cloud"></i> Último backup: <span id="backupTime">N/A</span></div>
            <div id="storageStatus"><i class="fas fa-database"></i> <span id="storageUsage">0MB</span> / 5MB usado</div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard -->
        <div class="dashboard fade-in">
            <div class="card">
                <h3><i class="fas fa-box-open"></i> Total de Produtos</h3>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-desc"><span class="trend-up" id="productsTrend">+0%</span> no último mês</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-shopping-cart"></i> Vendas do Mês</h3>
                <div class="stat-value" id="monthSales">R$ 0,00</div>
                <div class="stat-desc"><span class="trend-up" id="salesTrend">+0%</span> em relação ao mês passado</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-exclamation-triangle"></i> Produtos com Baixo Estoque</h3>
                <div class="stat-value" id="lowStock">0</div>
                <div class="stat-desc">Reabastecimento necessário</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-file-invoice-dollar"></i> Receita Pendente</h3>
                <div class="stat-value" id="pendingRevenue">R$ 0,00</div>
                <div class="stat-desc">Vendas parceladas em aberto</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="angeli-actions">
            <button class="btn btn-primary fade-in" onclick="openProductModal()">
                <i class="fas fa-plus-circle"></i> Adicionar Produto
            </button>
            <button class="btn btn-success fade-in" onclick="openSaleModal()">
                <i class="fas fa-cash-register"></i> Registrar Venda
            </button>
            <button class="btn btn-info fade-in" onclick="openBackupModal()">
                <i class="fas fa-cloud-upload-alt"></i> Backup
            </button>
            <button class="btn btn-warning fade-in" onclick="generateReport()">
                <i class="fas fa-chart-bar"></i> Relatório
            </button>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" data-target="productsSection">Produtos</div>
            <div class="tab" data-target="salesSection">Vendas</div>
            <div class="tab" data-target="reportsSection">Relatórios</div>
            <div class="tab" data-target="settingsSection">Configurações</div>
        </div>

        <!-- Products Section -->
        <section id="productsSection" class="section active">
            <div class="section-header">
                <h2><i class="fas fa-boxes"></i> Seus Produtos</h2>
                <div class="search-filter-bar">
                    <input type="text" id="productSearch" class="form-control" placeholder="Pesquisar produtos..." oninput="filterProducts()">
                    <select id="productCategoryFilter" class="form-control" onchange="filterProducts()">
                        <option value="">Todas as Categorias</option>
                        <option>Vestuário</option>
                        <option>Eletrônicos</option>
                        <option>Acessórios</option>
                        <option>Livros</option>
                        <option>Outros</option>
                    </select>
                    <select id="productStockFilter" class="form-control" onchange="filterProducts()">
                        <option value="">Todo Estoque</option>
                        <option value="low">Baixo Estoque</option>
                    </select>
                </div>
            </div>

            <div class="products-grid" id="productsList">
                <!-- Products will be loaded dynamically -->
            </div>
            <div class="empty-state" id="productsEmptyState" style="display: none;">
                <i class="fas fa-box-open"></i>
                <p>Nenhum produto cadastrado ainda.</p>
                <button class="btn btn-primary" onclick="openProductModal()">Adicionar Primeiro Produto</button>
            </div>
        </section>

        <!-- Sales Section -->
        <section id="salesSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Histórico de Vendas</h2>
                <div class="search-filter-bar">
                    <input type="text" id="saleSearch" class="form-control" placeholder="Pesquisar vendas..." oninput="filterSales()">
                    <input type="date" id="saleDateFilterStart" class="form-control" onchange="filterSales()">
                    <input type="date" id="saleDateFilterEnd" class="form-control" onchange="filterSales()">
                    <select id="saleStatusFilter" class="form-control" onchange="filterSales()">
                        <option value="">Todos os Status</option>
                        <option value="paid">Pago</option>
                        <option value="pending">Pendente</option>
                        <option value="overdue">Atrasado</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3>Últimas Vendas</h3>
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- Sales will be loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="empty-state" id="salesEmptyState" style="display: none;">
                        <i class="fas fa-cash-register"></i>
                        <p>Nenhuma venda registrada ainda.</p>
                        <button class="btn btn-success" onclick="openSaleModal()">Registrar Primeira Venda</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reportsSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Relatórios e Análises</h2>
                <div>
                    <button class="btn btn-primary" onclick="exportPDF()" id="exportPdfBtn">
                        <i class="fas fa-file-export"></i> Exportar PDF
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>Desempenho de Vendas - Últimos 6 Meses</h3>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem;">
                <div class="card">
                    <h3>Produtos Mais Vendidos</h3>
                    <div class="chart-container">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Vendas por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settingsSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-cog"></i> Configurações</h2>
            </div>

            <div class="card">
                <h3>Backup em Nuvem (Simulado)</h3>
                <div class="form-group">
                    <label for="backupFrequency">Frequência de Backup Automático</label>
                    <select id="backupFrequency" class="form-control">
                        <option>Diariamente</option>
                        <option selected>Semanalmente</option>
                        <option>Mensalmente</option>
                        <option>Desativado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cloudService">Serviço de Nuvem</label>
                    <select id="cloudService" class="form-control">
                        <option>Google Drive</option>
                        <option selected>Dropbox</option>
                        <option>OneDrive</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="performBackup()"><i class="fas fa-cloud-upload-alt"></i> Fazer Backup Agora</button>
            </div>

            <div class="card" style="margin-top: 1rem;">
                <h3>Personalização</h3>
                <div class="form-group">
                    <label for="appTheme">Tema do Aplicativo</label>
                    <select id="appTheme" class="form-control" onchange="changeTheme(this.value)">
                        <option value="pink">Rosa (Padrão)</option>
                        <option value="blue">Azul Profissional</option>
                        <option value="green">Verde Natureza</option>
                        <option value="dark">Modo Escuro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notificações</label>
                    <div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="stockAlerts" checked> Alertas de estoque baixo
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="paymentReminders" checked> Lembretes de pagamento parcelado
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="updates"> Novidades e atualizações
                        </label>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="productModalTitle"><i class="fas fa-plus-circle"></i> Adicionar Novo Produto</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="productName">Nome do Produto</label>
                    <input type="text" id="productName" class="form-control" placeholder="Ex: Camiseta Básica Branca">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productSku">SKU (Código do Produto)</label>
                        <input type="text" id="productSku" class="form-control" placeholder="Ex: CAM-BRA-001">
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Categoria</label>
                        <select id="productCategory" class="form-control">
                            <option value="">Selecione uma categoria</option>
                            <option>Vestuário</option>
                            <option>Eletrônicos</option>
                            <option>Acessórios</option>
                            <option>Livros</option>
                            <option>Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Preço (R$)</label>
                        <input type="number" id="productPrice" class="form-control" placeholder="0,00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Quantidade em Estoque</label>
                        <input type="number" id="productStock" class="form-control" placeholder="0" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Descrição do Produto</label>
                    <textarea id="productDescription" class="form-control" rows="3" placeholder="Descrição detalhada do produto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productImage">Imagem do Produto</label>
                    <div class="file-input-container">
                        <input type="file" id="productImage" accept="image/*" onchange="handleImageUpload(event)">
                        <label class="file-input-label" for="productImage">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Clique para selecionar uma imagem</p>
                            <p class="text-sm" style="margin-top: 0.5rem; color: var(--secondary);">Formatos: JPG, PNG (Máx. 5MB)</p>
                        </label>
                    </div>
                    <div id="imagePreview" style="margin-top: 1rem; text-align: center;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">Salvar Produto</button>
            </div>
        </div>
    </div>

    <!-- Sale Modal -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-cash-register"></i> Registrar Nova Venda</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="saleCustomer">Cliente</label>
                    <input type="text" id="saleCustomer" class="form-control" placeholder="Nome do cliente">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="saleProduct">Produto</label>
                        <select id="saleProduct" class="form-control">
                            <option value="">Selecione um produto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="saleQuantity">Quantidade</label>
                        <input type="number" id="saleQuantity" class="form-control" value="1" min="1">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addSaleItem()"><i class="fas fa-plus"></i> Adicionar Item</button>
                
                <div class="sale-items" id="saleItemsContainer">
                    <h4>Itens da Venda</h4>
                    <div id="saleItemsList"></div>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Forma de Pagamento</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">À Vista</option>
                        <option value="credit">Crédito</option>
                        <option value="installment">Parcelado</option>
                    </select>
                </div>
                
                <div id="installmentFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="installmentCount">Número de Parcelas</label>
                            <input type="number" id="installmentCount" class="form-control" value="2" min="2" max="12">
                        </div>
                        <div class="form-group">
                            <label for="installmentInterest">Juros (%)</label>
                            <input type="number" id="installmentInterest" class="form-control" value="0" min="0" max="20" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Total da Venda</label>
                            <div class="stat-value">R$ <span id="saleTotal">0.00</span></div>
                        </div>
                        <div class="form-group">
                            <label>Valor por Parcela</label>
                            <div class="stat-value">R$ <span id="installmentValue">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-success" onclick="finalizeSale()"><i class="fas fa-check"></i> Finalizar Venda</button>
            </div>
        </div>
    </div>

    <!-- Installment Modal -->
    <div class="modal-overlay" id="installmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Gerenciar Parcelas</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Venda:</label>
                    <div id="saleDetails"></div>
                </div>
                
                <div class="form-group">
                    <h4>Parcelas</h4>
                    <table class="installment-table">
                        <thead>
                            <tr>
                                <th>Parcela</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="installmentList">
                            <!-- Parcelas serão carregadas aqui -->
                        </tbody>
                    </table>
                </div>
                
                <div class="form-group">
                    <h4>Histórico de Pagamentos</h4>
                    <div id="paymentHistory" style="margin-top: 1rem;">
                        <!-- Histórico será carregado aqui -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal-overlay" id="backupModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> Backup em Nuvem</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="backupService">Serviço de Nuvem</label>
                    <select id="backupService" class="form-control">
                        <option>Google Drive</option>
                        <option selected>Dropbox</option>
                        <option>OneDrive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="backupFreq">Frequência de Backup</label>
                    <select id="backupFreq" class="form-control">
                        <option>Diariamente</option>
                        <option selected>Semanalmente</option>
                        <option>Mensalmente</option>
                    </select>
                </div>
                
                <div class="card">
                    <h3>Últimos Backups</h3>
                    <ul id="backupHistory" style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>Nenhum backup registrado ainda.</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Fechar</button>
                <button class="btn btn-primary" onclick="performBackup()"><i class="fas fa-cloud-upload-alt"></i> Fazer Backup Agora</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Confirmação</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <i class="fas fa-question-circle"></i>
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" aria-live="polite"></div>

    <script>
        // Dados do aplicativo
        const appData = {
            products: [],
            sales: [],
            currentSale: {
                items: [],
                customer: '',
                paymentMethod: 'cash',
                installments: 1,
                interest: 0
            },
            editingProductId: null,
            uploadedImage: null,
            currentInstallmentSale: null,
            backupHistory: []
        };

        // Configuração do IndexedDB
        const DB_NAME = 'AngeliDB';
        const DB_VERSION = 1;
        let db;

        // --- Funções do IndexedDB ---
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('sales')) {
                        db.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('appSettings')) {
                        db.createObjectStore('appSettings', { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains('backupHistory')) {
                        db.createObjectStore('backupHistory', { keyPath: 'id', autoIncrement: true });
                    }
                    console.log('IndexedDB upgrade complete.');
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    showMessage('error', 'Erro ao abrir o banco de dados local. Os dados podem não ser salvos.');
                    reject(event.target.errorCode);
                };
            });
        }

async function saveDataToIndexedDB(storeName, data) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot save data.');
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                let request;
                if (storeName === 'appSettings') {
                    // Para appSettings, sempre usar put para evitar ConstraintError
                    request = store.put(data);
                } else {
                    request = data.id ? store.put(data) : store.add(data); // Usa put para atualizar/adicionar, add para novo
                }

                request.onsuccess = (event) => {
                    resolve(event.target.result); // Retorna o ID para operações de adição
                };

                request.onerror = (event) => {
                    const error = event.target.error || event.target.errorCode || 'Unknown error';
                    console.error(`Error saving to ${storeName}:`, error);
                    reject(error);
                };
            });
        }

        async function deleteDataFromIndexedDB(storeName, id) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot delete data.');
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Error deleting from ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function loadDataFromIndexedDB(storeName) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot load data.');
                return [];
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error(`Error loading from ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function getNextId(storeName) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot get next ID.');
                return 1;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor(null, 'prev');
                let maxId = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        maxId = cursor.value.id;
                    }
                    resolve(maxId + 1);
                };

                request.onerror = (event) => {
                    console.error(`Error getting next ID for ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

async function loadAppSettings() {
            try {
                const settings = await loadDataFromIndexedDB('appSettings');
                const themeSetting = settings.find(s => s.key === 'theme');
                if (themeSetting) {
                    document.getElementById('appTheme').value = themeSetting.value;
                    changeTheme(themeSetting.value, false); // Não mostra mensagem ao carregar
                }

                const backupHistorySetting = await loadDataFromIndexedDB('backupHistory');
                if (backupHistorySetting) {
                    appData.backupHistory = backupHistorySetting;
                    updateBackupHistoryDisplay();
                }

            } catch (error) {
                console.error('Falha ao carregar configurações do aplicativo:', error);
            }
        }

        async function saveAppSetting(key, value) {
            if (!db) return;
            try {
                await saveDataToIndexedDB('appSettings', { key, value });
            } catch (error) {
                console.error(`Falha ao salvar configuração ${key}:`, error);
            }
        }

        async function loadAllDataAndRender() {
            try {
                appData.products = await loadDataFromIndexedDB('products');
                appData.sales = await loadDataFromIndexedDB('sales');

                if (appData.products.length === 0 && appData.sales.length === 0) {
                    initializeSampleData();
                    // Salva dados de exemplo iniciais no DB
                    for (const product of appData.products) {
                        await saveDataToIndexedDB('products', product);
                    }
                    for (const sale of appData.sales) {
                        await saveDataToIndexedDB('sales', sale);
                    }
                }

                renderProducts();
                renderSales();
                initCharts();
                updateDashboard();
                loadAppSettings(); // Carrega outras configurações como tema e histórico de backup

                // Mensagem inicial após o carregamento dos dados
                setTimeout(() => {
                    showMessage('success', 'Aplicativo Angeli carregado com sucesso!');
                }, 1000);

            } catch (error) {
                console.error('Erro ao carregar dados do IndexedDB:', error);
                showMessage('error', 'Não foi possível carregar os dados. Use o modo anônimo se o problema persistir.');
            }
        }

        // --- Funcionalidade das Abas ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                
                const target = tab.getAttribute('data-target');
                document.getElementById(target).classList.add('active');
            });
        });

        // --- Funcionalidade do Modal ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            resetSaleForm();
            resetProductForm();
        }

        // Fecha o modal ao clicar no botão de fechar ou fora do modal
        document.querySelectorAll('.close-modal, .modal-overlay').forEach(element => {
            if (element.classList.contains('close-modal')) {
                element.addEventListener('click', closeModal);
            } else { // Clica fora do modal, mas apenas se for o overlay
                element.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        closeModal();
                    }
                });
            }
        });

        // Impede que o modal feche ao clicar dentro dele
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => e.stopPropagation());
        });

        // --- Caixa de Mensagens ---
        function showMessage(type, text) {
            const messageBox = document.getElementById('messageBox');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.setAttribute('role', 'alert');
            message.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <div>${text}</div>
            `;
            messageBox.appendChild(message);
            
            setTimeout(() => {
                message.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => {
                    message.remove();
                }, 500);
            }, 5000);
        }

        // --- Gerenciamento de Tema ---
        function changeTheme(theme, showMsg = true) {
            document.body.className = `theme-${theme}`;
            saveAppSetting('theme', theme);
            if (showMsg) {
                showMessage('success', `Tema alterado para ${theme === 'pink' ? 'Rosa' : theme === 'blue' ? 'Azul' : theme === 'green' ? 'Verde' : 'Escuro'}.`);
            }
        }

        // --- Upload de Imagem ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) { // Máximo 5MB
                showMessage('error', 'A imagem é muito grande! Máximo 5MB.');
                document.getElementById('productImage').value = ''; // Limpa o input de arquivo
                document.getElementById('imagePreview').innerHTML = '';
                appData.uploadedImage = null;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px;">`;
                appData.uploadedImage = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Dados de Exemplo (Usado apenas se o DB estiver vazio) ---
        function initializeSampleData() {
            appData.products = [
                { id: 1, name: "Camiseta Básica Branca", sku: "CAM-BRA-001", category: "Vestuário", price: 29.90, stock: 42, description: "Camiseta básica de algodão 100%", image: '' },
                { id: 2, name: "Smartphone X Pro", sku: "SMP-XP-2023", category: "Eletrônicos", price: 2499.00, stock: 3, description: "Smartphone de última geração", image: '' },
                { id: 3, name: "Livro: A Arte da Guerra", sku: "LIV-ART-077", category: "Livros", price: 39.90, stock: 15, description: "Clássico da literatura estratégica", image: '' },
                { id: 4, name: "Fones Bluetooth", sku: "FON-BT-045", category: "Acessórios", price: 149.90, stock: 28, description: "Fones sem fio com cancelamento de ruído", image: '' }
            ];

            appData.sales = [
                { 
                    id: 1, 
                    date: "2024-06-30", // Formato ISO para fácil manipulação
                    customer: "Maria Silva", 
                    amount: 389.90, 
                    payment: "Parcelado (3x)", 
                    paymentMethod: "installment",
                    installments: 3,
                    interest: 5,
                    status: "pending", 
                    items: [
                        { productId: 1, name: "Camiseta Básica Branca", quantity: 3, price: 29.90 },
                        { productId: 4, name: "Fones Bluetooth", quantity: 1, price: 149.90 }
                    ],
                    installmentList: [ // Exemplo de parcelas pré-definidas para dados de exemplo
                        { number: 1, dueDate: "30/07/2024", amount: (389.90 * 1.05) / 3, status: 'paid', paymentDate: "29/07/2024" },
                        { number: 2, dueDate: "30/08/2024", amount: (389.90 * 1.05) / 3, status: 'pending', paymentDate: null },
                        { number: 3, dueDate: "30/09/2024", amount: (389.90 * 1.05) / 3, status: 'pending', paymentDate: null }
                    ]
                },
                { 
                    id: 2, 
                    date: "2024-07-29", // Formato ISO
                    customer: "Carlos Oliveira", 
                    amount: 2499.00, 
                    payment: "À Vista", 
                    paymentMethod: "cash",
                    status: "paid", 
                    items: [
                        { productId: 2, name: "Smartphone X Pro", quantity: 1, price: 2499.00 }
                    ]
                },
                { 
                    id: 3, 
                    date: "2024-07-28", // Formato ISO
                    customer: "Loja Central", 
                    amount: 1280.50, 
                    payment: "Crédito", 
                    paymentMethod: "credit",
                    status: "paid", 
                    items: [
                        { productId: 1, name: "Camiseta Básica Branca", quantity: 10, price: 29.90 },
                        { productId: 3, name: "Livro: A Arte da Guerra", quantity: 15, price: 39.90 }
                    ]
                }
            ];
            showMessage('info', 'Dados de exemplo carregados pois o banco de dados estava vazio.');
        }

        // --- Gerenciamento de Produtos ---
        function renderProducts() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            
            const filteredProducts = applyProductFilters(appData.products);

            const productsEmptyState = document.getElementById('productsEmptyState');
            if (filteredProducts.length === 0) {
                productsEmptyState.style.display = 'block';
                return;
            } else {
                productsEmptyState.style.display = 'none';
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card fade-in';
                productCard.innerHTML = `
                    <div class="product-image">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.name}">` : 
                            `<i class="${getProductIcon(product.category)}"></i>`
                        }
                        <div class="upload-icon" onclick="openProductModal(${product.id})">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="product-info">
                        <div class="product-title" title="${product.name}">${product.name}</div>
                        <div class="product-sku" title="SKU: ${product.sku}">SKU: ${product.sku}</div>
                        <div>Categoria: ${product.category}</div>
                        <div class="product-meta">
                            <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                            <div class="product-stock ${product.stock < 5 ? 'low' : ''}">Estoque: ${product.stock}</div>
                        </div>
                        <div class="product-actions">
                            <button class="action-btn btn-edit" onclick="openProductModal(${product.id})" aria-label="Editar ${product.name}"><i class="fas fa-edit"></i> Editar</button>
                            <button class="action-btn btn-delete" onclick="confirmDeleteProduct(${product.id}, '${product.name}')" aria-label="Excluir ${product.name}"><i class="fas fa-trash"></i> Excluir</button>
                        </div>
                    </div>
                `;
                productsList.appendChild(productCard);
            });
            
            updateDashboard();
        }

        function getProductIcon(category) {
            switch(category) {
                case 'Vestuário': return 'fas fa-tshirt';
                case 'Eletrônicos': return 'fas fa-mobile-alt';
                case 'Livros': return 'fas fa-book';
                case 'Acessórios': return 'fas fa-headphones';
                default: return 'fas fa-box';
            }
        }

        function applyProductFilters(products) {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('productCategoryFilter').value;
            const stockFilter = document.getElementById('productStockFilter').value;

            return products.filter(product => {
                const name = product.name.toLowerCase();
                const sku = product.sku.toLowerCase();
                const category = product.category.toLowerCase();
                
                const matchesSearch = name.includes(searchTerm) || sku.includes(searchTerm) || category.includes(searchTerm);
                const matchesCategory = categoryFilter === '' || category === categoryFilter.toLowerCase();
                const matchesStock = stockFilter === '' || (stockFilter === 'low' && product.stock < 5);

                return matchesSearch && matchesCategory && matchesStock;
            });
        }

        function filterProducts() {
            renderProducts(); // Renderiza novamente com os filtros aplicados
        }

        function openProductModal(editId = null) {
            resetProductForm(); // Sempre reseta antes de abrir
            if (editId !== null) {
                const product = appData.products.find(p => p.id === editId);
                if (product) {
                    document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Produto';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productSku').value = product.sku;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('saveProductBtn').innerText = 'Atualizar Produto';
                    appData.editingProductId = editId;
                    
                    if (product.image) {
                        const preview = document.getElementById('imagePreview');
                        preview.innerHTML = `<img src="${product.image}" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px;">`;
                        appData.uploadedImage = product.image;
                    }
                }
            } else {
                document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Novo Produto';
                document.getElementById('saveProductBtn').innerText = 'Salvar Produto';
                appData.editingProductId = null;
            }
            openModal('productModal');
        }

        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const sku = document.getElementById('productSku').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value.trim();
            
            if (!name || !sku || !category || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios com valores válidos.');
                return;
            }

            // Verifica se o SKU já existe
            const isSkuTaken = appData.products.some(p => p.sku === sku && p.id !== appData.editingProductId);
            if (isSkuTaken) {
                showMessage('error', 'O SKU inserido já existe para outro produto. Por favor, use um SKU único.');
                return;
            }
            
            let productToSave;
            if (appData.editingProductId) {
                const index = appData.products.findIndex(p => p.id === appData.editingProductId);
                if (index !== -1) {
                    productToSave = {
                        ...appData.products[index],
                        name,
                        sku,
                        category,
                        price,
                        stock,
                        description,
                        image: appData.uploadedImage || appData.products[index].image // Mantém a existente se não houver novo upload
                    };
                    appData.products[index] = productToSave;
                    await saveDataToIndexedDB('products', productToSave);
                    showMessage('success', 'Produto atualizado com sucesso!');
                }
            } else {
                const newId = await getNextId('products'); // Obtém o próximo ID disponível do IndexedDB
                productToSave = {
                    id: newId,
                    name,
                    sku,
                    category,
                    price,
                    stock,
                    description,
                    image: appData.uploadedImage
                };
                const addedId = await saveDataToIndexedDB('products', productToSave);
                productToSave.id = addedId; // Atualiza o ID com o ID gerado pelo IndexedDB
                appData.products.push(productToSave);
                showMessage('success', 'Produto adicionado com sucesso!');
            }
            
            renderProducts();
            closeModal();
        }

        function confirmDeleteProduct(id, name) {
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').textContent = `Tem certeza que deseja excluir o produto "${name}"? Esta ação não pode ser desfeita.`;
            document.getElementById('confirmActionBtn').onclick = () => deleteProduct(id);
        }

        async function deleteProduct(id) {
            appData.products = appData.products.filter(product => product.id !== id);
            await deleteDataFromIndexedDB('products', id);
            showMessage('success', 'Produto excluído com sucesso!');
            closeModal(); // Fecha o modal de confirmação
            renderProducts();
        }

        function resetProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productSku').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productImage').value = '';
            appData.uploadedImage = null;
        }

        // --- Gerenciamento de Vendas ---
        function renderSales() {
            const salesTableBody = document.getElementById('salesTableBody');
            salesTableBody.innerHTML = '';
            
            const filteredSales = applySaleFilters(appData.sales);

            if (filteredSales.length === 0) {
                document.getElementById('salesEmptyState').style.display = 'block';
                return;
            } else {
                document.getElementById('salesEmptyState').style.display = 'none';
            }

            filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                const row = document.createElement('tr');
                
                let statusBadge;
                // Atualiza o status para pagamentos atrasados
                if (sale.paymentMethod === 'installment' && sale.status === 'pending') {
                    const hasOverdue = sale.installmentList.some(inst => inst.status === 'pending' && new Date(inst.dueDate.split('/').reverse().join('-')) < new Date());
                    if (hasOverdue) {
                        sale.status = 'overdue';
                        // Opcionalmente, salva o status atualizado no DB imediatamente
                        saveDataToIndexedDB('sales', sale);
                    }
                }

                switch(sale.status) {
                    case 'paid': statusBadge = '<span class="status-badge status-paid">Pago</span>'; break;
                    case 'pending': statusBadge = '<span class="status-badge status-pending">Pendente</span>'; break;
                    case 'overdue': statusBadge = '<span class="status-badge status-overdue">Atrasado</span>'; break;
                    default: statusBadge = '<span class="status-badge">Desconhecido</span>';
                }
                
                row.innerHTML = `
                    <td>#V${sale.id.toString().padStart(4, '0')}</td>
                    <td>${new Date(sale.date).toLocaleDateString('pt-BR')}</td>
                    <td>${sale.customer}</td>
                    <td>R$ ${sale.amount.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${sale.paymentMethod === 'installment' ? 
                            `<button class="action-btn btn-info" onclick="openInstallmentModal(${sale.id})" aria-label="Gerenciar parcelas da venda ${sale.id}">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </button>` : ''
                        }
                        <button class="action-btn btn-delete" onclick="confirmDeleteSale(${sale.id})" aria-label="Excluir venda ${sale.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
            
            updateDashboard();
        }

        function applySaleFilters(sales) {
            const searchTerm = document.getElementById('saleSearch').value.toLowerCase();
            const startDate = document.getElementById('saleDateFilterStart').value;
            const endDate = document.getElementById('saleDateFilterEnd').value;
            const statusFilter = document.getElementById('saleStatusFilter').value;

            return sales.filter(sale => {
                const customer = sale.customer.toLowerCase();
                const id = `#v${sale.id.toString().padStart(4, '0')}`.toLowerCase();
                const saleDate = new Date(sale.date);
                
                const matchesSearch = customer.includes(searchTerm) || id.includes(searchTerm);
                const matchesDate = (!startDate || saleDate >= new Date(startDate)) && (!endDate || saleDate <= new Date(endDate));
                const matchesStatus = statusFilter === '' || sale.status === statusFilter;

                return matchesSearch && matchesDate && matchesStatus;
            });
        }

        function filterSales() {
            renderSales();
        }

        function openSaleModal() {
            resetSaleForm();
            populateProductDropdown();
            openModal('saleModal');
        }

        function confirmDeleteSale(id) {
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').textContent = `Tem certeza que deseja excluir a venda #V${id.toString().padStart(4, '0')}? Esta ação não pode ser desfeita e o estoque não será restaurado.`;
            document.getElementById('confirmActionBtn').onclick = () => deleteSale(id);
        }

        async function deleteSale(id) {
            const saleToDelete = appData.sales.find(s => s.id === id);
            if (saleToDelete) {
                // Opcionalmente, restaura o estoque se desejado, mas por padrão não o faremos agora
                // saleToDelete.items.forEach(item => {
                //     const product = appData.products.find(p => p.id === item.productId);
                //     if (product) {
                //         product.stock += item.quantity;
                //         saveDataToIndexedDB('products', product); // Atualiza o estoque no DB
                //     }
                // });
            }

            appData.sales = appData.sales.filter(sale => sale.id !== id);
            await deleteDataFromIndexedDB('sales', id);
            showMessage('success', 'Venda excluída com sucesso!');
            closeModal(); // Fecha o modal de confirmação
            renderSales();
            renderProducts(); // Atualiza a lista de produtos para refletir possíveis mudanças no estoque
        }

        function populateProductDropdown() {
            const select = document.getElementById('saleProduct');
            select.innerHTML = '<option value="">Selecione um produto</option>';
            
            appData.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - R$ ${product.price.toFixed(2)} (Estoque: ${product.stock})`;
                select.appendChild(option);
            });
        }

        function addSaleItem() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            
            if (!productId || isNaN(quantity) || quantity <= 0) {
                showMessage('error', 'Selecione um produto e informe uma quantidade válida!');
                return;
            }
            
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            if (product.stock < quantity) {
                showMessage('error', `Estoque insuficiente! Disponível: ${product.stock}`);
                return;
            }

            // Verifica se o item já existe na venda atual, se sim, atualiza a quantidade
            const existingItem = appData.currentSale.items.find(item => item.productId === productId);
            if (existingItem) {
                if (product.stock < (existingItem.quantity + quantity)) {
                    showMessage('error', `Estoque insuficiente para adicionar mais! Disponível: ${product.stock - existingItem.quantity}`);
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                appData.currentSale.items.push({
                    productId: product.id,
                    name: product.name,
                    quantity: quantity,
                    price: product.price
                });
            }
            
            renderSaleItems();
            updateSaleTotal();
        }

        function renderSaleItems() {
            const saleItemsList = document.getElementById('saleItemsList');
            saleItemsList.innerHTML = '';
            
            if (appData.currentSale.items.length === 0) {
                saleItemsList.innerHTML = '<p style="text-align: center; color: var(--secondary); padding: 1rem;">Nenhum item adicionado</p>';
                return;
            }
            
            appData.currentSale.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sale-item';
                itemDiv.innerHTML = `
                    <div class="sale-item-info">
                        <div>${item.name}</div>
                        <div style="font-size: 0.85rem; color: var(--secondary);">${item.quantity} x R$ ${item.price.toFixed(2)}</div>
                    </div>
                    <div class="sale-item-actions">
                        <button class="action-btn btn-danger" onclick="removeSaleItem(${index})" aria-label="Remover item ${item.name}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                saleItemsList.appendChild(itemDiv);
            });
        }

        function removeSaleItem(index) {
            appData.currentSale.items.splice(index, 1);
            renderSaleItems();
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const total = appData.currentSale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            if (paymentMethod === 'installment') {
                const count = parseInt(document.getElementById('installmentCount').value) || 1;
                const interest = parseFloat(document.getElementById('installmentInterest').value) || 0;
                
                const interestFactor = 1 + (interest / 100);
                const installmentValue = (total * interestFactor) / count;
                document.getElementById('installmentValue').textContent = installmentValue.toFixed(2);
            } else {
                document.getElementById('installmentValue').textContent = '0.00';
            }
        }

        document.getElementById('paymentMethod').addEventListener('change', function() {
            const installmentFields = document.getElementById('installmentFields');
            if (this.value === 'installment') {
                installmentFields.style.display = 'block';
            } else {
                installmentFields.style.display = 'none';
            }
            updateSaleTotal();
        });

        document.getElementById('installmentCount').addEventListener('change', updateSaleTotal);
        document.getElementById('installmentInterest').addEventListener('change', updateSaleTotal);

        async function finalizeSale() {
            const customer = document.getElementById('saleCustomer').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;
            const installmentCount = parseInt(document.getElementById('installmentCount').value) || 1;
            const interest = parseFloat(document.getElementById('installmentInterest').value) || 0;
            
            if (appData.currentSale.items.length === 0) {
                showMessage('error', 'Adicione pelo menos um item à venda!');
                return;
            }
            
            if (!customer) {
                showMessage('error', 'Informe o nome do cliente!');
                return;
            }
            
            const total = appData.currentSale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalWithInterest = paymentMethod === 'installment' ? total * (1 + interest/100) : total;
            
            // Atualiza o estoque e salva no DB
            for (const item of appData.currentSale.items) {
                const product = appData.products.find(p => p.id === item.productId);
                if (product) {
                    product.stock -= item.quantity;
                    await saveDataToIndexedDB('products', product);
                }
            }
            
            let newSale = {};
            if (appData.currentSale.id) { // Editando venda existente
                newSale = appData.sales.find(s => s.id === appData.currentSale.id);
                if (newSale) {
                    newSale = {
                        ...newSale,
                        customer: customer,
                        amount: totalWithInterest,
                        payment: paymentMethod === 'cash' ? 'À Vista' : 
                                 paymentMethod === 'credit' ? 'Crédito' : 
                                 `Parcelado (${installmentCount}x)`,
                        paymentMethod: paymentMethod,
                        installments: installmentCount,
                        interest: interest,
                        status: paymentMethod === 'cash' || paymentMethod === 'credit' ? 'paid' : 'pending',
                        items: [...appData.currentSale.items]
                    };
                    // Atualiza a venda existente
                    const index = appData.sales.findIndex(s => s.id === newSale.id);
                    if (index !== -1) appData.sales[index] = newSale;
                }
            } else { // Nova venda
                const newId = await getNextId('sales');
                newSale = {
                    id: newId,
                    date: new Date().toISOString().split('T')[0], // Armazena como string ISO
                    customer: customer,
                    amount: totalWithInterest,
                    payment: paymentMethod === 'cash' ? 'À Vista' : 
                             paymentMethod === 'credit' ? 'Crédito' : 
                             `Parcelado (${installmentCount}x)`,
                    paymentMethod: paymentMethod,
                    installments: installmentCount,
                    interest: interest,
                    status: paymentMethod === 'cash' || paymentMethod === 'credit' ? 'paid' : 'pending',
                    items: [...appData.currentSale.items]
                };
                appData.sales.push(newSale);
            }

            // Gera a lista de parcelas se o pagamento for parcelado e ainda não gerado
            if (newSale.paymentMethod === 'installment' && !newSale.installmentList) {
                newSale.installmentList = [];
                const today = new Date();
                const installmentValue = newSale.amount / newSale.installments;
                
                for (let i = 1; i <= newSale.installments; i++) {
                    const dueDate = new Date(today); // Clona a data para evitar mutação
                    dueDate.setMonth(today.getMonth() + i);
                    
                    newSale.installmentList.push({
                        number: i,
                        dueDate: dueDate.toLocaleDateString('pt-BR'), // Formato de exibição
                        amount: installmentValue,
                        status: 'pending',
                        paymentDate: null
                    });
                }
            }
            
            await saveDataToIndexedDB('sales', newSale); // Salva a nova/atualizada venda no DB
            showMessage('success', 'Venda registrada com sucesso!');
            closeModal();
            renderProducts(); // Renderiza novamente os produtos para mostrar o estoque atualizado
            renderSales();
        }

        function resetSaleForm() {
            appData.currentSale = {
                items: [],
                customer: '',
                paymentMethod: 'cash',
                installments: 1,
                interest: 0
            };
            
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('installmentCount').value = '2';
            document.getElementById('installmentInterest').value = '0';
            document.getElementById('saleTotal').textContent = '0.00';
            document.getElementById('installmentValue').textContent = '0.00';
            
            document.getElementById('installmentFields').style.display = 'none';
            renderSaleItems();
        }

        async function openInstallmentModal(saleId) {
            // Recarrega as vendas do IndexedDB para garantir dados atualizados
            appData.sales = await loadDataFromIndexedDB('sales');
            const sale = appData.sales.find(s => s.id === saleId);
            if (!sale) return;
            
            appData.currentInstallmentSale = sale;
            
            document.getElementById('saleDetails').innerHTML = `
                <div><strong>ID:</strong> #V${sale.id.toString().padStart(4, '0')}</div>
                <div><strong>Cliente:</strong> ${sale.customer}</div>
                <div><strong>Total:</strong> R$ ${sale.amount.toFixed(2)}</div>
                <div><strong>Forma de Pagamento:</strong> ${sale.payment}</div>
            `;
            
            // Garante que installmentList exista e esteja atualizada com os detalhes da venda atual
            if (!sale.installmentList || sale.installmentList.length !== sale.installments || 
                sale.installmentList.reduce((sum, inst) => sum + inst.amount, 0).toFixed(2) !== sale.amount.toFixed(2)) {
                
                sale.installmentList = [];
                const saleDate = new Date(sale.date); // Usa a data da venda para o cálculo da parcela
                const installmentValue = (sale.amount * (1 + (sale.interest / 100))) / sale.installments;
                
                for (let i = 1; i <= sale.installments; i++) {
                    const dueDate = new Date(saleDate); // Começa da data da venda
                    dueDate.setMonth(saleDate.getMonth() + i);
                    
                    sale.installmentList.push({
                        number: i,
                        dueDate: dueDate.toLocaleDateString('pt-BR'),
                        amount: installmentValue,
                        status: 'pending',
                        paymentDate: null
                    });
                }
                await saveDataToIndexedDB('sales', sale); // Salva a lista de parcelas recém-gerada
            }
            
            renderInstallments();
            openModal('installmentModal');
        }

        function renderInstallments() {
            const installmentListEl = document.getElementById('installmentList');
            installmentListEl.innerHTML = '';
            
            const sale = appData.currentInstallmentSale;
            if (!sale || !sale.installmentList) return;

            const today = new Date();
            let allInstallmentsPaid = true;

            sale.installmentList.forEach((installment, index) => {
                const row = document.createElement('tr');
                
                let statusBadge;
                let actualStatus = installment.status;

                // Verifica o status de atraso
                if (actualStatus === 'pending' && new Date(installment.dueDate.split('/').reverse().join('-')) < today) {
                    actualStatus = 'overdue';
                }

                if (actualStatus !== 'paid') {
                    allInstallmentsPaid = false;
                }

                switch(actualStatus) {
                    case 'paid': statusBadge = '<span class="status-badge status-paid">Pago</span>'; break;
                    case 'pending': statusBadge = '<span class="status-badge status-pending">Pendente</span>'; break;
                    case 'overdue': statusBadge = '<span class="status-badge status-overdue">Atrasado</span>'; break;
                    default: statusBadge = '<span class="status-badge">Desconhecido</span>';
                }
                
                row.innerHTML = `
                    <td>${installment.number}</td>
                    <td>${installment.dueDate}</td>
                    <td>R$ ${installment.amount.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${installment.status === 'pending' ? 
                            `<button class="action-btn btn-success" onclick="payInstallment(${index})" aria-label="Pagar parcela ${installment.number}">
                                <i class="fas fa-check"></i> Pagar
                            </button>` : 
                            `<span>Pago em ${installment.paymentDate}</span>`
                        }
                    </td>
                `;
                installmentListEl.appendChild(row);
            });

            // Atualiza o status da venda principal se todas as parcelas estiverem pagas
            if (allInstallmentsPaid && sale.status !== 'paid') {
                sale.status = 'paid';

                // Atualiza a venda no array appData.sales para manter a consistência
                const saleIndex = appData.sales.findIndex(s => s.id === sale.id);
                if (saleIndex !== -1) {
                    appData.sales[saleIndex] = { ...sale };
                }

                saveDataToIndexedDB('sales', sale);
                renderSales(); // Renderiza novamente a tabela de vendas principal para mostrar o status atualizado
            } else if (!allInstallmentsPaid && sale.status === 'paid') {
                // Este cenário lida se uma parcela paga for de alguma forma "despaga", embora a UI atual não permita
                sale.status = 'pending';

                // Atualiza a venda no array appData.sales para manter a consistência
                const saleIndex = appData.sales.findIndex(s => s.id === sale.id);
                if (saleIndex !== -1) {
                    appData.sales[saleIndex] = { ...sale };
                }

                saveDataToIndexedDB('sales', sale);
                renderSales();
            }
            
            renderPaymentHistory();
        }

        async function payInstallment(installmentIndex) {
            if (!appData.currentInstallmentSale) return;
            
            const today = new Date();
            const paymentDate = today.toLocaleDateString('pt-BR');
            
            appData.currentInstallmentSale.installmentList[installmentIndex].status = 'paid';
            appData.currentInstallmentSale.installmentList[installmentIndex].paymentDate = paymentDate;

            // Atualiza a venda correspondente no array appData.sales para manter a consistência
            const saleIndex = appData.sales.findIndex(sale => sale.id === appData.currentInstallmentSale.id);
            if (saleIndex !== -1) {
                appData.sales[saleIndex] = { ...appData.currentInstallmentSale };
            }
            
            await saveDataToIndexedDB('sales', appData.currentInstallmentSale);

            // Recarrega as vendas do IndexedDB para garantir sincronização
            appData.sales = await loadDataFromIndexedDB('sales');
            // Atualiza a venda atual com a versão recarregada
            appData.currentInstallmentSale = appData.sales.find(sale => sale.id === appData.currentInstallmentSale.id);

            // Atualiza o histórico de pagamento para refletir a alteração
            renderPaymentHistory();

            showMessage('success', `Parcela ${installmentIndex + 1} marcada como paga!`);
            renderInstallments(); // Renderiza novamente as parcelas para atualizar o status
            
            // Adicionado: Atualiza o dashboard para recalcular a receita pendente
            updateDashboard();

            // Adicionado log para debug
            console.log('Receita Pendente atualizada após pagamento de parcela.');
        }

        function renderPaymentHistory() {
            const paymentHistory = document.getElementById('paymentHistory');
            paymentHistory.innerHTML = '';
            
            const sale = appData.currentInstallmentSale;
            if (!sale || !sale.installmentList) {
                paymentHistory.innerHTML = '<p>Nenhum histórico de pagamento disponível.</p>';
                return;
            }

            const payments = sale.installmentList.filter(i => i.status === 'paid');
            
            if (payments.length === 0) {
                paymentHistory.innerHTML = '<p style="text-align: center; color: var(--secondary); padding: 1rem;">Nenhum pagamento registrado ainda.</p>';
            } else {
                payments.forEach(payment => {
                    const paymentDiv = document.createElement('div');
                    paymentDiv.className = 'sale-item';
                    paymentDiv.innerHTML = `
                        <div><strong>Parcela ${payment.number}:</strong> R$ ${payment.amount.toFixed(2)}</div>
                        <div><strong>Data de pagamento:</strong> ${payment.paymentDate}</div>
                    `;
                    paymentHistory.appendChild(paymentDiv);
                });
            }
        }

        // --- Backup (Simulado) ---
        function openBackupModal() {
            updateBackupHistoryDisplay();
            openModal('backupModal');
        }

        async function performBackup() {
            const now = new Date();
            const backupTime = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const service = document.getElementById('backupService').value;

            // Simula o cálculo do tamanho (estimativa muito aproximada)
            const dataSize = JSON.stringify(appData.products).length + JSON.stringify(appData.sales).length;
            const sizeMB = (dataSize / (1024 * 1024)).toFixed(2);

            const backupRecord = {
                id: appData.backupHistory.length > 0 ? Math.max(...appData.backupHistory.map(b => b.id)) + 1 : 1,
                date: backupTime,
                size: sizeMB + 'MB',
                service: service
            };
            appData.backupHistory.push(backupRecord);
            await saveDataToIndexedDB('backupHistory', backupRecord);

            document.getElementById('backupTime').textContent = backupTime;
            document.getElementById('storageUsage').textContent = `${sizeMB}MB`;
            
            showMessage('success', 'Backup realizado com sucesso!');
            updateBackupHistoryDisplay();
            closeModal();
        }

        function updateBackupHistoryDisplay() {
            const backupHistoryList = document.getElementById('backupHistory');
            backupHistoryList.innerHTML = '';
            if (appData.backupHistory.length === 0) {
                backupHistoryList.innerHTML = '<li>Nenhum backup registrado ainda.</li>';
            } else {
                appData.backupHistory.sort((a, b) => new Date(b.date.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00')) - new Date(a.date.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'))).forEach(backup => {
                    const li = document.createElement('li');
                    li.textContent = `${backup.date} - ${backup.size} (${backup.service})`;
                    backupHistoryList.appendChild(li);
                });
            }
        }


        // --- Geração de Relatórios ---
        function generateReport() {
            showMessage('info', 'Gerando relatório... Isso pode levar alguns segundos.');
            initCharts(); // Garante que os gráficos sejam atualizados com os dados mais recentes
            // Em um aplicativo real, isso pode acionar um relatório do lado do servidor ou uma agregação mais complexa do lado do cliente
            setTimeout(() => {
                showMessage('success', 'Relatório gerado com sucesso!');
            }, 1000); // Simula algum tempo de processamento
        }

        async function exportPDF() {
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            exportPdfBtn.innerHTML = '<span class="spinner"></span> Gerando...';
            exportPdfBtn.disabled = true;

            const reportsSection = document.getElementById('reportsSection');
            
            try {
                const canvas = await html2canvas(reportsSection, { scale: 2 }); // Escala maior para melhor qualidade
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 297; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`relatorio-angeli-${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('success', 'PDF gerado e salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showMessage('error', 'Erro ao gerar o PDF. Tente novamente.');
            } finally {
                exportPdfBtn.innerHTML = '<i class="fas fa-file-export"></i> Exportar PDF';
                exportPdfBtn.disabled = false;
            }
        }

        // --- Atualização do Painel ---
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = appData.products.length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthSales = appData.sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + sale.amount, 0);
            document.getElementById('monthSales').textContent = `R$ ${monthSales.toFixed(2)}`;
            
            const lowStock = appData.products.filter(p => p.stock < 5).length;
            document.getElementById('lowStock').textContent = lowStock;
            
            // Calcula a receita pendente somando apenas as parcelas *não pagas* de vendas parceladas
            const pendingRevenue = appData.sales
                .filter(sale => sale.paymentMethod === 'installment') // Apenas vendas parceladas
                .reduce((totalPending, sale) => {
                    // Soma o valor das parcelas que ainda estão 'pending' ou 'overdue'
                    const salePendingAmount = sale.installmentList.reduce((sum, installment) => {
                        if (installment.status !== 'paid') {
                            return sum + installment.amount;
                        }
                        return sum;
                    }, 0);
                    return totalPending + salePendingAmount;
                }, 0);

            document.getElementById('pendingRevenue').textContent = `R$ ${pendingRevenue.toFixed(2)}`;
            
            const lastMonthSales = appData.sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    const prevMonth = new Date();
                    prevMonth.setMonth(currentMonth - 1); // Obtém a data do mês anterior
                    return saleDate.getMonth() === prevMonth.getMonth() && saleDate.getFullYear() === prevMonth.getFullYear();
                })
                .reduce((sum, sale) => sum + sale.amount, 0);
            
            let salesTrend = 0;
            if (lastMonthSales > 0) {
                salesTrend = Math.round(((monthSales - lastMonthSales) / lastMonthSales) * 100);
            } else if (monthSales > 0) {
                salesTrend = 100; // Se o mês passado foi zero, mas o mês atual tem vendas, é um aumento de 100%
            }
                
            document.getElementById('salesTrend').textContent = `${salesTrend >= 0 ? '+' : ''}${salesTrend}%`;
            document.getElementById('salesTrend').className = salesTrend >= 0 ? 'trend-up' : 'trend-down';
        }

        // --- Inicialização de Gráficos ---
        let salesChart, topProductsChart, categoryChart; // Variáveis globais de gráficos para destruir os existentes

        function initCharts() {
            // Obtém dados de vendas por mês
            const salesByMonth = Array(6).fill(0);
            const monthLabels = Array.from({length: 6}, (_, i) => {
                const month = new Date();
                month.setMonth(month.getMonth() - (5 - i));
                return month.toLocaleString('pt-BR', { month: 'short' });
            });
            const currentDate = new Date();
            
            appData.sales.forEach(sale => {
                const saleDate = new Date(sale.date);
                const monthDiff = (currentDate.getFullYear() - saleDate.getFullYear()) * 12 + 
                                (currentDate.getMonth() - saleDate.getMonth());
                
                if (monthDiff >= 0 && monthDiff < 6) {
                    salesByMonth[5 - monthDiff] += sale.amount;
                }
            });
            
            // Obtém os produtos mais vendidos
            const productSales = {};
            appData.sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = 0;
                    }
                    productSales[item.name] += item.quantity;
                });
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topProductNames = sortedProducts.map(p => p[0]);
            const topProductSales = sortedProducts.map(p => p[1]);
            
            // Obtém vendas por categoria
            const salesByCategory = {};
            // Inicializa com todas as categorias existentes dos produtos
            const allCategories = [...new Set(appData.products.map(p => p.category))];
            allCategories.forEach(cat => salesByCategory[cat] = 0);

            appData.sales.forEach(sale => {
                sale.items.forEach(item => {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product && salesByCategory[product.category] !== undefined) {
                        salesByCategory[product.category] += item.quantity * item.price;
                    }
                });
            });
            
            const categories = Object.keys(salesByCategory).filter(cat => salesByCategory[cat] > 0);
            const categorySales = categories.map(cat => salesByCategory[cat]);

            // Gráfico de Vendas
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) salesChart.destroy();
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: salesByMonth,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });

            // Gráfico dos Produtos Mais Vendidos
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            if (topProductsChart) topProductsChart.destroy();
            topProductsChart = new Chart(topProductsCtx, {
                type: 'bar',
                data: {
                    labels: topProductNames,
                    datasets: [{
                        label: 'Unidades Vendidas',
                        data: topProductSales,
                        backgroundColor: Array(topProductNames.length).fill(getComputedStyle(document.body).getPropertyValue('--primary').replace(')', ', 0.7)')),
                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-dark'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        y: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });

            // Gráfico por Categoria
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Vendas por Categoria',
                        data: categorySales,
                        backgroundColor: categories.map((_, i) => 
                            `hsl(${i * 360 / categories.length}, 70%, 60%)`
                        ),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', async function() {
            await openIndexedDB();
            await loadAllDataAndRender(); // Carrega os dados do DB e então renderiza a UI
            
            // Define a data atual para os filtros de data
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDateFilterEnd').value = today;
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            document.getElementById('saleDateFilterStart').value = sixMonthsAgo.toISOString().split('T')[0];
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Angeli - Controle de Estoque</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Importa a fonte Inter do Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Define a fonte padrão para o corpo do documento */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Cores personalizadas conforme o prompt */
        .bg-angeli-primary {
            background-color: #ff69b4; /* Rosa principal */
        }

        .bg-angeli-background {
            background-color: #f8f0f4; /* Fundo claro */
        }

        .text-angeli-darkpink {
            color: #d13a83; /* Rosa mais escuro para títulos e ícones */
        }

        /* Estilo base para botões, aplicando utilitários Tailwind */
        .angeli-btn {
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem;
            padding-top: 0.75rem; /* py-3 */
            padding-bottom: 0.75rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition-property: all;
            transition-duration: 200ms;
            transition-timing-function: ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); /* shadow-md */
            /* Melhorias para tornar o botão clicável em toda a área */
            display: flex; /* Garante que o flexbox seja aplicado */
            align-items: center; /* Alinha itens verticalmente ao centro */
            justify-content: center; /* Alinha itens horizontalmente ao centro */
            cursor: pointer; /* Indica que o elemento é clicável */
            width: 100%; /* Garante que o botão ocupe a largura total disponível */
        }

        /* Reduz o tamanho do seletor de idioma em 50% */
        #languageSelector {
            width: 50% !important;
            height: 50% !important;
            font-size: 0.5rem !important;
            padding: 0.25rem !important;
            line-height: 1 !important;
            box-sizing: border-box !important;
        }

        /* Estilo para botões primários */
        .angeli-btn-primary {
            background-color: #ff69b4; /* bg-angeli-primary */
            color: white;
        }
        .angeli-btn-primary:hover {
            background-color: #f687b3; /* hover:bg-pink-400 */
        }
        .angeli-btn-primary:active {
            background-color: #b91c6b; /* active:bg-pink-700 */
        }

        /* Estilo para botões secundários */
        .angeli-btn-secondary {
            background-color: white;
            color: #4a5568; /* text-gray-700 */
            border: 1px solid #d2d6dc; /* border-gray-300 */
        }
        .angeli-btn-secondary:hover {
            background-color: #f7fafc; /* hover:bg-gray-100 */
        }
        .angeli-btn-secondary:active {
            background-color: #e5e7eb; /* active:bg-gray-200 */
        }

        /* Estilo para campos de entrada de texto e seleção */
        .angeli-input {
            width: 100%;
            padding: 0.75rem; /* p-3 */
            border: 1px solid #d2d6dc; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            outline: none;
        }
        .angeli-input:focus {
            outline: 2px solid #ff69b4; /* focus:ring-2 focus:ring-angeli-primary */
            outline-offset: 0;
        }

        /* Estilo para os cartões de produto */
        .product-card {
            background-color: white;
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); /* shadow-md */
            display: flex;
            flex-direction: column;
        }

        /* Estilo para as imagens dentro dos cartões de produto */
        .product-card-img {
            width: 100%;
            height: 10rem; /* h-40 */
            object-fit: cover;
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 0.75rem; /* mb-3 */
        }

        /* Garante que o conteúdo de informação do cartão ocupe o espaço restante */
        .product-card-info {
            flex-grow: 1;
        }

        /* Estilo para a área de ações dentro do cartão de produto */
        .product-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 1rem; /* mt-4 */
        }

        /* Estilo para os botões de ação (editar/excluir) dentro dos cartões */
        .product-card-action-btn {
            padding-left: 0.75rem; /* px-3 */
            padding-right: 0.75rem;
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.375rem; /* rounded-md */
            transition-property: background-color;
            transition-duration: 200ms;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Indica que o elemento é clicável */
        }
        .product-card-action-btn:hover {
            background-color: #f7fafc; /* hover:bg-gray-100 */
            transition-timing-function: ease-in-out;
        }

        /* Estilos gerais para modais (pop-ups) */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5); /* bg-black bg-opacity-50 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* p-4 */
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 300ms;
        }

        /* Ativação do modal (torná-lo visível e interativo) */
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Conteúdo do modal */
        .modal-content {
            background-color: white;
            padding: 2rem; /* p-8 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); /* shadow-xl */
            max-width: 32rem; /* max-w-lg */
            width: 100%;
            transform: translateY(-1rem);
            opacity: 0;
            transition: all 300ms;
        }

        /* Animação de entrada do conteúdo do modal */
        .modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Estilo para a mensagem de feedback */
        #messageBox.active {
            opacity: 1;
        }

        /* Estilos para status de parcelamento */
        .status-overdue {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }
        .status-on-time {
            color: #22c55e; /* green-500 */
            font-weight: 600;
        }
        .status-completed {
            color: #6b7280; /* gray-500 */
        }
        .card-overdue {
            border: 2px solid #ef4444; /* red-500 */
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3), 0 2px 4px -2px rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body class="bg-angeli-background font-inter text-gray-800 antialiased min-h-screen flex flex-col">
    <header class="bg-angeli-primary p-4 shadow-md flex justify-between items-center flex-wrap">
        <h1 class="text-white text-2xl font-bold flex items-center" data-i18n="appTitle">
            Angeli - Controle de Estoque
        </h1>
        <div class="flex items-center mt-2 md:mt-0">
            <div id="statusMessage" class="text-white text-sm mr-4"></div>
            <button id="settingsBtn" class="text-white p-2 rounded-md hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-white" title="Configurações">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            </button>
        </div>

    <!-- Modal de Configurações -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <h3 class="text-angeli-darkpink text-xl font-semibold mb-4">Configurações</h3>
            <div class="mb-4">
                <label for="modalLanguageSelector" class="block text-sm font-medium text-gray-700 mb-2">Idioma</label>
                <select id="modalLanguageSelector" class="angeli-input">
                    <option value="pt" data-i18n="lang_pt">Português</option>
                    <option value="en" data-i18n="lang_en">English</option>
                </select>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="closeSettingsBtn" class="angeli-btn angeli-btn-secondary">Fechar</button>
            </div>
        </div>
    </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <section class="angeli-actions grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <button id="addProductBtn" class="angeli-btn angeli-btn-primary" data-i18n="addProduct">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <span>Adicionar Produto</span>
            </button>
            <button id="registerSaleBtn" class="angeli-btn angeli-btn-primary" data-i18n="registerSale">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25v2.25m-3-3.75h3.75m3-3.75h-3.75m0 0-3-3.75M12 15.75h3.75m-3.75 3.75h3.75m3-3.75h-3.75M6.75 7.5l3 4.5-3 4.5m7.5-9l3 4.5-3 4.5m-7.5 0h-.008v.008H12v-.008h-.008m0 0H12.75" />
                </svg>
                <span>Registrar Venda</span>
            </button>
            <button id="viewSalesHistoryBtn" class="angeli-btn angeli-btn-secondary" data-i18n="salesHistory">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <span>Histórico de Vendas</span>
            </button>
            <button id="viewInstallmentControlBtn" class="angeli-btn angeli-btn-secondary" data-i18n="installmentControl">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 18V5.625c0-.621.504-1.125 1.125-1.125H9.75a3 3 0 0 1 3-3z" />
                </svg>
                <span>Controlo de Parcelamentos</span>
            </button>
            <button id="viewTotalStockBtn" class="angeli-btn angeli-btn-secondary" data-i18n="totalStock">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l3.75 4.5 3-3L21.75 6" />
                </svg>
                <span>Visualizar Estoque</span>
            </button>
            <button id="generateReportBtn" class="angeli-btn angeli-btn-secondary" data-i18n="generateReport">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 10.5 3.75h-1.5A1.125 1.125 0 0 1 7.875 2.25v-1.5A3.375 3.375 0 0 0 4.5 0v16.5a3.375 3.375 0 0 0 3.375 3.375h12.75a3.375 3.375 0 0 0 3.375-3.375V14.25m-9-2.25h.75a.375.375 0 0 1 .375.375v3a.375.375 0 0 1-.375.375h-.75a.375.375 0 0 1-.375-.375v-3a.375.375 0 0 1 .375-.375z" />
                </svg>
                <span>Gerar Relatório</span>
            </button>
            <button id="exportDataBtn" class="angeli-btn angeli-btn-secondary" data-i18n="exportData">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M7.5 7.5h9" />
                </svg>
                <span>Exportar Dados</span>
            </button>
            <input type="file" id="importDataInput" class="hidden" accept=".json">
            <button id="importDataBtn" class="angeli-btn angeli-btn-secondary" data-i18n="importData">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M7.5 7.5h9" />
                </svg>
                <span>Importar Dados</span>
            </button>
        </section>

        <section id="productsSection" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-angeli-darkpink text-2xl font-semibold mb-4 flex items-center" data-i18n="yourProducts">
                Seus Produtos
            </h2>
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Pesquisar produtos por nome, SKU, cor ou tamanho..." class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-angeli-primary" data-i18n="searchPlaceholder">
            </div>
            <div id="loadingProducts" class="text-center text-gray-500 hidden" data-i18n="loading">Carregando produtos...</div>
            <div id="productsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            <div id="noProductsFound" class="text-center text-gray-500 mt-4 hidden" data-i18n="noProducts">Nenhum produto encontrado.</div>
        </section>

        <section id="salesHistorySection" class="bg-white p-6 rounded-lg shadow-lg hidden">
            <h2 class="text-angeli-darkpink text-2xl font-semibold mb-4 flex items-center" data-i18n="salesHistoryTitle">
                Histórico de Vendas
                <button id="backToProductsBtn" class="ml-auto angeli-btn angeli-btn-secondary text-sm px-3 py-1 flex items-center" data-i18n="backToProducts">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M7 13h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2z" />
                    </svg>
                    <span>Voltar aos Produtos</span>
                </button>
            </h2>
            <div id="loadingSales" class="text-center text-gray-500 hidden" data-i18n="loadingSales">Carregando histórico de vendas...</div>
            <div id="salesList" class="space-y-6">
                </div>
            <div id="noSalesFound" class="text-center text-gray-500 mt-4 hidden" data-i18n="noSales">Nenhuma venda registrada.</div>
        </section>

        <section id="installmentControlSection" class="bg-white p-6 rounded-lg shadow-lg hidden">
            <h2 class="text-angeli-darkpink text-2xl font-semibold mb-4 flex items-center" data-i18n="installmentControlTitle">
                Controlo de Parcelamentos
                <button id="backToProductsFromInstallmentsBtn" class="ml-auto angeli-btn angeli-btn-secondary text-sm px-3 py-1 flex items-center" data-i18n="backToProducts">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M7 13h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2z" />
                    </svg>
                    <span>Voltar aos Produtos</span>
                </button>
            </h2>
            <div class="mb-4 p-3 bg-angeli-background rounded-md flex justify-between items-center">
                <span class="text-gray-700 font-semibold" data-i18n="totalAmountToReceiveLabel">Total a Receber:</span>
                <span id="totalAmountToReceive" class="text-angeli-darkpink text-xl font-bold">R$ 0,00</span>
            </div>
            <div id="loadingInstallments" class="text-center text-gray-500 hidden" data-i18n="loading">Carregando parcelamentos...</div>
            <div id="installmentSalesList" class="space-y-6">
                <!-- Lista de vendas parceladas será renderizada aqui -->
            </div>
            <div id="noInstallmentsFound" class="text-center text-gray-500 mt-4 hidden" data-i18n="noInstallments">Nenhuma venda parcelada encontrada.</div>
        </section>
    </main>

    <footer class="p-4 text-center text-gray-600 text-sm mt-auto" data-i18n="footer">
        Angeli - Store Manager © 2025. Todos os direitos reservados.
    </footer>

    <div id="productModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="productModalTitle" class="text-angeli-darkpink text-2xl font-semibold mb-6" data-i18n="addProductTitle">Adicionar Novo Produto</h3>
            <form id="productForm" class="space-y-4">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700" data-i18n="productNameLabel">Nome do Produto <span class="text-red-500">*</span></label>
                    <input type="text" id="productName" required class="angeli-input" placeholder="Ex: Vestido Floral">
                </div>
                <div>
                    <label for="productColor" class="block text-sm font-medium text-gray-700" data-i18n="colorLabel">Cor <span class="text-red-500">*</span></label>
                    <input type="text" id="productColor" required class="angeli-input" placeholder="Ex: Vermelho">
                </div>
                <div>
                    <label for="productSize" class="block text-sm font-medium text-gray-700" data-i18n="sizeLabel">Tamanho <span class="text-red-500">*</span></label>
                    <input type="text" id="productSize" required class="angeli-input" placeholder="Ex: P, M, G">
                </div>
                <div>
                    <label for="productSKU" class="block text-sm font-medium text-gray-700" data-i18n="skuLabel">SKU <span class="text-red-500">*</span></label>
                    <input type="text" id="productSKU" required class="angeli-input" placeholder="Ex: PROD-123">
                </div>
                <div>
                    <label for="productQuantity" class="block text-sm font-medium text-gray-700" data-i18n="quantityLabel">Quantidade <span class="text-red-500">*</span></label>
                    <input type="number" id="productQuantity" min="0" required class="angeli-input" placeholder="Ex: 10">
                </div>
                <div>
                    <label for="productPrice" class="block text-sm font-medium text-gray-700" data-i18n="priceLabel">Preço (R$) <span class="text-red-500">*</span></label>
                    <input type="number" id="productPrice" min="0" step="0.01" required class="angeli-input" placeholder="Ex: 49.90">
                </div>
                <div>
                    <label for="productImage" class="block text-sm font-medium text-gray-700" data-i18n="imageUploadLabel">Imagem do Produto (opcional)</label>
                    <input type="file" id="productImage" accept="image/*" class="angeli-input">
                    <img id="productImagePreview" class="mt-2 hidden w-24 h-24 object-cover rounded-md border border-gray-300" src="" alt="Pré-visualização da Imagem">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelProductBtn" class="angeli-btn angeli-btn-secondary" data-i18n="cancel">Cancelar</button>
                    <button type="submit" class="angeli-btn angeli-btn-primary" data-i18n="saveProduct">Salvar Produto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="saleModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-angeli-darkpink text-2xl font-semibold mb-6" data-i18n="registerSaleTitle">Registrar Nova Venda</h3>
            <form id="saleForm" class="space-y-4">
                <div>
                    <label for="saleProductSearchInput" class="block text-sm font-medium text-gray-700" data-i18n="searchProductLabel">Pesquisar Produto</label>
                    <input type="text" id="saleProductSearchInput" class="angeli-input mb-2" placeholder="Pesquisar produto por nome ou SKU...">
                </div>
                <div>
                    <label for="saleProductSelect" class="block text-sm font-medium text-gray-700" data-i18n="selectProductLabel">Selecionar Produto <span class="text-red-500">*</span></label>
                    <select id="saleProductSelect" class="angeli-input">
                        <option value="" data-i18n="selectOption">Selecione um produto</option>
                    </select>
                </div>
                <div>
                    <label for="saleQuantity" class="block text-sm font-medium text-gray-700" data-i18n="quantityLabel">Quantidade <span class="text-red-500">*</span></label>
                    <input type="number" id="saleQuantity" min="1" value="1" class="angeli-input" placeholder="Ex: 1">
                </div>
                <button type="button" id="addItemToSaleBtn" class="angeli-btn angeli-btn-primary" data-i18n="addItemToSale">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    <span>Adicionar Item</span>
                </button>

                <div class="mt-6">
                    <h4 class="text-lg font-medium text-gray-700 mb-2" data-i18n="saleItems">Itens na Venda:</h4>
                    <div id="saleItemList" class="border border-gray-200 rounded-md p-3 max-h-48 overflow-y-auto space-y-2">
                        <p id="noSaleItems" class="text-gray-500 text-sm" data-i18n="noSaleItems">Nenhum item adicionado ainda.</p>
                    </div>
                    <div class="flex justify-between items-center mt-4 p-2 bg-angeli-background rounded-md">
                        <span class="text-gray-700 font-semibold" data-i18n="totalSale">Total da Venda:</span>
                        <span id="totalSaleAmount" class="text-angeli-darkpink text-xl font-bold">R$ 0,00</span>
                    </div>
                </div>

                <hr class="my-6">

                <div>
                    <label for="paymentType" class="block text-sm font-medium text-gray-700" data-i18n="paymentTypeLabel">Tipo de Pagamento <span class="text-red-500">*</span></label>
                    <select id="paymentType" required class="angeli-input">
                        <option value="À Vista" data-i18n="cash">À Vista</option>
                        <option value="Crédito" data-i18n="credit">Crédito</option>
                        <option value="Parcelado" data-i18n="installment">Parcelado</option>
                    </select>
                </div>
                <div id="installmentDetails" class="space-y-4 hidden">
                    <div>
                        <label for="numInstallments" class="block text-sm font-medium text-gray-700" data-i18n="installmentsNumber">Número de Parcelas <span class="text-red-500">*</span></label>
                        <input type="number" id="numInstallments" min="2" value="2" class="angeli-input" placeholder="Ex: 3">
                    </div>
                    <div>
                        <label for="interestPercentage" class="block text-sm font-medium text-gray-700" data-i18n="interestPercentageLabel">Juros (%)</label>
                        <input type="number" id="interestPercentage" min="0" step="0.01" value="0" class="angeli-input" placeholder="Ex: 5">
                    </div>
                    <div>
                        <label for="installmentValue" class="block text-sm font-medium text-gray-700" data-i18n="installmentValue">Valor por Parcela</label>
                        <input type="text" id="installmentValue" readonly class="angeli-input bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700" data-i18n="customerNameLabel">Nome do Cliente (opcional)</label>
                    <input type="text" id="customerName" class="angeli-input" placeholder="Ex: Ana Silva">
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelSaleBtn" class="angeli-btn angeli-btn-secondary" data-i18n="cancel">Cancelar</button>
                    <button type="submit" id="finalizeSaleBtn" class="angeli-btn angeli-btn-primary" data-i18n="finalizeSale">
                        <svg id="finalizeSaleSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.062 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Finalizar Venda</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <h3 id="confirmModalTitle" class="text-angeli-darkpink text-xl font-semibold mb-4" data-i18n="confirmation">Confirmação</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelConfirmBtn" class="angeli-btn angeli-btn-secondary" data-i18n="cancel">Cancelar</button>
                <button type="button" id="confirmActionBtn" class="angeli-btn angeli-btn-primary" data-i18n="confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Variáveis Globais ---
            let allProducts = [];
            let allSales = [];
            let editingProductId = null; // Armazena o ID do produto que está sendo editado
            let currentSaleItems = []; // Array temporário para os itens da venda atual
            let currentLanguage = 'pt'; // Idioma padrão

            const PRODUCT_STORAGE_KEY = 'angeli_products';
            const SALE_STORAGE_KEY = 'angeli_sales';
            const LANGUAGE_STORAGE_KEY = 'angeli_language';

            // --- Elementos do DOM (obtidos uma vez para melhor performance) ---
            const statusMessage = document.getElementById('statusMessage');
            const productsSection = document.getElementById('productsSection');
            const salesHistorySection = document.getElementById('salesHistorySection');
            const installmentControlSection = document.getElementById('installmentControlSection'); // Novo elemento

            // Botões de Ação Principais
            const addProductBtn = document.getElementById('addProductBtn');
            const registerSaleBtn = document.getElementById('registerSaleBtn');
            const viewSalesHistoryBtn = document.getElementById('viewSalesHistoryBtn');
            const viewInstallmentControlBtn = document.getElementById('viewInstallmentControlBtn'); // Novo elemento
            const viewTotalStockBtn = document.getElementById('viewTotalStockBtn');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importDataBtn = document.getElementById('importDataBtn');
            const importDataInput = document.getElementById('importDataInput');
            const backToProductsBtn = document.getElementById('backToProductsBtn');
            const backToProductsFromInstallmentsBtn = document.getElementById('backToProductsFromInstallmentsBtn'); // Novo elemento
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const modalLanguageSelector = document.getElementById('modalLanguageSelector');

            // Elementos da Seção de Produtos
            const searchInput = document.getElementById('searchInput');
            const productsList = document.getElementById('productsList');
            const loadingProducts = document.getElementById('loadingProducts');
            const noProductsFound = document.getElementById('noProductsFound');

            // Elementos da Seção de Histórico de Vendas
            const salesList = document.getElementById('salesList');
            const loadingSales = document.getElementById('loadingSales');
            const noSalesFound = document.getElementById('noSalesFound');

            // Elementos da Seção de Controlo de Parcelamentos
            const totalAmountToReceive = document.getElementById('totalAmountToReceive'); // Novo elemento
            const installmentSalesList = document.getElementById('installmentSalesList'); // Novo elemento
            const loadingInstallments = document.getElementById('loadingInstallments'); // Novo elemento
            const noInstallmentsFound = document.getElementById('noInstallmentsFound'); // Novo elemento

            // Modais e seus elementos
            const productModal = document.getElementById('productModal');
            const productModalTitle = document.getElementById('productModalTitle');
            const productForm = document.getElementById('productForm');
            const cancelProductBtn = document.getElementById('cancelProductBtn');
            const productName = document.getElementById('productName');
            const productColor = document.getElementById('productColor');
            const productSize = document.getElementById('productSize');
            const productSKU = document.getElementById('productSKU');
            const productQuantity = document.getElementById('productQuantity');
            const productPrice = document.getElementById('productPrice');
            const productImage = document.getElementById('productImage');
            const productImagePreview = document.getElementById('productImagePreview'); // Novo elemento

            const saleModal = document.getElementById('saleModal');
            const saleForm = document.getElementById('saleForm');
            const cancelSaleBtn = document.getElementById('cancelSaleBtn');
            const saleProductSelect = document.getElementById('saleProductSelect');
            const saleQuantity = document.getElementById('saleQuantity');
            const addItemToSaleBtn = document.getElementById('addItemToSaleBtn');
            const saleItemList = document.getElementById('saleItemList');
            const noSaleItems = document.getElementById('noSaleItems');
            const totalSaleAmount = document.getElementById('totalSaleAmount');
            const paymentType = document.getElementById('paymentType');
            const installmentDetails = document.getElementById('installmentDetails');
            const numInstallments = document.getElementById('numInstallments');
            const interestPercentage = document.getElementById('interestPercentage'); // Novo elemento
            const installmentValue = document.getElementById('installmentValue');
            const customerName = document.getElementById('customerName');
            const saleProductSearchInput = document.getElementById('saleProductSearchInput'); // Novo elemento
            const finalizeSaleBtn = document.getElementById('finalizeSaleBtn'); // Novo elemento
            const finalizeSaleSpinner = document.getElementById('finalizeSaleSpinner'); // Novo elemento

            const confirmModal = document.getElementById('confirmModal');
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');

            const messageBox = document.getElementById('messageBox');

            // --- Objeto de Traduções ---
            const translations = {
                pt: {
                    appTitle: "Angeli - Controle de Estoque",
                    lang_pt: "Português",
                    lang_en: "English",
                    statusLoaded: "Aplicativo Carregado (Armazenamento Local)",
                    statusSaved: "Dados salvos localmente.",
                    addProduct: "Adicionar Produto",
                    registerSale: "Registrar Venda",
                    salesHistory: "Histórico de Vendas",
                    installmentControl: "Controlo de Parcelamentos", // Nova tradução
                    totalStock: "Visualizar Estoque",
                    generateReport: "Gerar Relatório",
                    exportData: "Exportar Dados",
                    importData: "Importar Dados",
                    yourProducts: "Seus Produtos",
                    searchPlaceholder: "Pesquisar produtos por nome, SKU, cor ou tamanho...",
                    loading: "Carregando...",
                    noProducts: "Nenhum produto encontrado.",
                    salesHistoryTitle: "Histórico de Vendas",
                    backToProducts: "Voltar aos Produtos",
                    loadingSales: "Carregando histórico de vendas...",
                    noSales: "Nenhuma venda registrada.",
                    installmentControlTitle: "Controlo de Parcelamentos", // Nova tradução
                    totalAmountToReceiveLabel: "Total a Receber:", // Nova tradução
                    loadingInstallments: "Carregando parcelamentos...", // Nova tradução
                    noInstallments: "Nenhuma venda parcelada encontrada.", // Nova tradução
                    footer: "Angeli - Store Manager © 2025. Todos os direitos reservados.",
                    addProductTitle: "Adicionar Novo Produto",
                    editProductTitle: "Editar Produto",
                    productNameLabel: "Nome do Produto",
                    colorLabel: "Cor",
                    sizeLabel: "Tamanho",
                    skuLabel: "SKU",
                    quantityLabel: "Quantidade",
                    priceLabel: "Preço (R$)",
                    imageUploadLabel: "Imagem do Produto (opcional)", // Chave de tradução atualizada
                    cancel: "Cancelar",
                    saveProduct: "Salvar Produto",
                    selectOption: "Selecione um produto",
                    addItemToSale: "Adicionar Item",
                    saleItems: "Itens na Venda:",
                    noSaleItems: "Nenhum item adicionado ainda.",
                    totalSale: "Total da Venda:",
                    paymentTypeLabel: "Tipo de Pagamento",
                    cash: "À Vista",
                    credit: "Crédito",
                    installment: "Parcelado",
                    installmentsNumber: "Número de Parcelas",
                    interestPercentageLabel: "Juros (%)", // Nova tradução
                    installmentValue: "Valor por Parcela",
                    customerNameLabel: "Nome do Cliente (opcional)",
                    finalizeSale: "Finalizar Venda",
                    confirmation: "Confirmação",
                    confirm: "Confirmar",
                    productAddedSuccess: "Produto adicionado com sucesso!",
                    productUpdatedSuccess: "Produto atualizado com sucesso!",
                    productNotFoundEdit: "Produto não encontrado para edição.",
                    productDeleteConfirm: "Tem certeza que deseja excluir o produto \"<strong>{productName}</strong>\"? Esta ação é irreversível.",
                    productDeleteSuccess: "Produto excluído com sucesso!",
                    productNotFoundDelete: "Produto não encontrado para exclusão.",
                    selectProductWarning: "Por favor, selecione um produto.",
                    quantityPositiveWarning: "A quantidade deve ser um número positivo.",
                    productNotFoundSale: "Produto não encontrado.",
                    insufficientStock: "Quantidade em estoque insuficiente para {productName}. Disponível: {availableQuantity}",
                    exceedsStock: "Adicionar {quantity} unidades de {productName} excederia o estoque. Disponível: {availableQuantity} para esta adição.",
                    quantityUpdatedSale: "Quantidade de {productName} atualizada na venda.",
                    itemAddedSale: "{quantity}x {productName} adicionado à venda.",
                    itemRemovedSale: "Item removido da venda.",
                    saleEmptyWarning: "Adicione pelo menos um item à venda para finalizar.",
                    invalidInstallments: "Número de parcelas inválido para pagamento parcelado.",
                    saleRegisteredSuccess: "Venda registrada com sucesso!",
                    totalStockMessage: "Estoque Total: {totalUnits} unidades. Valor Total do Estoque: {totalValue}",
                    reportSummary: "Resumo Angeli:<br>Valor Total do Estoque Atual: <strong class=\"text-angeli-darkpink\">{totalStockValue}</strong><br>Valor Total das Vendas Registradas: <strong class=\"text-angeli-darkpink\">{totalSalesValue}</strong>",
                    dataExportSuccess: "Dados exportados com sucesso!",
                    importConfirm: "Tem certeza que deseja importar dados? Isso <strong>substituirá todos os seus dados atuais</strong> de produtos e vendas.",
                    dataImportSuccess: "Dados importados com sucesso! O aplicativo foi atualizado.",
                    invalidJsonFormat: "Formato de arquivo JSON inválido. Esperado \"products\" e \"sales\" arrays.",
                    fileReadError: "Erro ao ler o arquivo.",
                    saveDataError: "Erro ao salvar dados localmente.",
                    loadDataError: "Erro ao carregar dados localmente. Os dados podem estar corrompidos.",
                    productNameRequired: "O nome do produto é obrigatório.",
                    colorRequired: "A cor é obrigatória.",
                    sizeRequired: "O tamanho é obrigatória.",
                    skuRequired: "O SKU é obrigatório.",
                    quantityInvalid: "A quantidade deve ser um número não negativo.",
                    priceInvalid: "O preço deve ser um número não negativo.",
                    notInformed: "Não Informado",
                    editButton: "Editar",
                    deleteButton: "Excluir",
                    searchProductLabel: "Pesquisar Produto", // Nova tradução
                    nextPaymentDateLabel: "Próx. Pagamento", // Nova tradução
                    markAsPaid: "Marcar como Pago", // Nova tradução
                    paymentDue: "Vencimento:", // Nova tradução
                    installmentsPaid: "Parcelas Pagas:", // Nova tradução
                    remainingAmount: "Valor Restante:", // Nova tradução
                    status: "Estado:", // Nova tradução
                    status_overdue: "Atrasado", // Nova tradução
                    status_on_time: "Em Dia", // Nova tradução
                    status_completed: "Concluído", // Nova tradução
                    installmentPaidSuccess: "Parcela marcada como paga com sucesso!", // Nova tradução
                    allInstallmentsPaid: "Todas as parcelas foram pagas para esta venda.", // Nova tradução
                    installmentAlreadyPaid: "Esta parcela já foi marcada como paga.", // Nova tradução
                    paymentDateUpdated: "Data do próximo pagamento atualizada.", // Nova tradução
                    currentInstallmentLabel: "Parcela Atual" // Nova tradução
                },
                en: {
                    appTitle: "Angeli - Stock Control",
                    lang_pt: "Portuguese",
                    lang_en: "English",
                    statusLoaded: "Application Loaded (Local Storage)",
                    statusSaved: "Data saved locally.",
                    addProduct: "Add Product",
                    registerSale: "Register Sale",
                    salesHistory: "Sales History",
                    installmentControl: "Installment Control", // New translation
                    totalStock: "View Total Stock",
                    generateReport: "Generate Report",
                    exportData: "Export Data",
                    importData: "Import Data",
                    yourProducts: "Your Products",
                    searchPlaceholder: "Search products by name, SKU, color, or size...",
                    loading: "Loading...",
                    noProducts: "No products found.",
                    salesHistoryTitle: "Sales History",
                    backToProducts: "Back to Products",
                    loadingSales: "Loading sales history...",
                    noSales: "No sales registered.",
                    installmentControlTitle: "Installment Control", // New translation
                    totalAmountToReceiveLabel: "Total to Receive:", // New translation
                    loadingInstallments: "Loading installments...", // New translation
                    noInstallments: "No installment sales found.", // New translation
                    footer: "Angeli - Stock Control © 2025. All rights reserved.",
                    addProductTitle: "Add New Product",
                    editProductTitle: "Edit Product",
                    productNameLabel: "Product Name",
                    colorLabel: "Color",
                    sizeLabel: "Size",
                    skuLabel: "SKU",
                    quantityLabel: "Quantity",
                    priceLabel: "Price ($)",
                    imageUploadLabel: "Product Image (optional)", // Updated translation key
                    cancel: "Cancel",
                    saveProduct: "Save Product",
                    selectOption: "Select a product",
                    addItemToSale: "Add Item",
                    saleItems: "Items in Sale:",
                    noSaleItems: "No items added yet.",
                    totalSale: "Total Sale:",
                    paymentTypeLabel: "Payment Type",
                    cash: "Cash",
                    credit: "Credit Card",
                    installment: "Installment",
                    installmentsNumber: "Number of Installments",
                    interestPercentageLabel: "Interest (%)", // New translation
                    installmentValue: "Installment Value",
                    customerNameLabel: "Customer Name (optional)",
                    finalizeSale: "Finalize Sale",
                    confirmation: "Confirmation",
                    confirm: "Confirm",
                    productAddedSuccess: "Product added successfully!",
                    productUpdatedSuccess: "Product updated successfully!",
                    productNotFoundEdit: "Product not found for editing.",
                    productDeleteConfirm: "Are you sure you want to delete the product \"<strong>{productName}</strong>\"? This action is irreversible.",
                    productDeleteSuccess: "Product deleted successfully!",
                    productNotFoundDelete: "Product not found for deletion.",
                    selectProductWarning: "Please select a product.",
                    quantityPositiveWarning: "Quantity must be a positive number.",
                    productNotFoundSale: "Product not found.",
                    insufficientStock: "Insufficient stock for {productName}. Available: {availableQuantity}",
                    exceedsStock: "Adding {quantity} units of {productName} would exceed stock. Available: {availableQuantity} for this addition.",
                    quantityUpdatedSale: "Quantity of {productName} updated in sale.",
                    itemAddedSale: "{quantity}x {productName} added to sale.",
                    itemRemovedSale: "Item removed from sale.",
                    saleEmptyWarning: "Add at least one item to finalize the sale.",
                    invalidInstallments: "Invalid number of installments for installment payment.",
                    saleRegisteredSuccess: "Sale registered successfully!",
                    totalStockMessage: "Total Stock: {totalUnits} units. Total Stock Value: {totalValue}",
                    reportSummary: "Angeli Summary:<br>Current Total Stock Value: <strong class=\"text-angeli-darkpink\">{totalStockValue}</strong><br>Total Sales Value Recorded: <strong class=\"text-angeli-darkpink\">{totalSalesValue}</strong>",
                    dataExportSuccess: "Data exported successfully!",
                    importConfirm: "Are you sure you want to import data? This will <strong>overwrite all your current</strong> product and sales data.",
                    dataImportSuccess: "Data imported successfully! The application has been updated.",
                    invalidJsonFormat: "Invalid JSON file format. Expected \"products\" and \"sales\" arrays.",
                    fileReadError: "Error reading file.",
                    saveDataError: "Error saving data locally.",
                    loadDataError: "Error loading data locally. Data might be corrupted.",
                    productNameRequired: "Product name is required.",
                    colorRequired: "Color is required.",
                    sizeRequired: "Size is required.",
                    skuRequired: "SKU is required.",
                    quantityInvalid: "Quantity must be a non-negative number.",
                    priceInvalid: "Price must be a non-negative number.",
                    notInformed: "Not Informed",
                    editButton: "Edit",
                    deleteButton: "Delete",
                    searchProductLabel: "Search Product", // New translation
                    nextPaymentDateLabel: "Next Payment", // New translation
                    markAsPaid: "Mark as Paid", // New translation
                    paymentDue: "Payment Due:", // New translation
                    installmentsPaid: "Installments Paid:", // New translation
                    remainingAmount: "Remaining Amount:", // New translation
                    status: "Status:", // New translation
                    status_overdue: "Overdue", // New translation
                    status_on_time: "On Time", // New translation
                    status_completed: "Completed", // New translation
                    installmentPaidSuccess: "Installment marked as paid successfully!", // New translation
                    allInstallmentsPaid: "All installments have been paid for this sale.", // New translation
                    installmentAlreadyPaid: "This installment has already been marked as paid.", // New translation
                    paymentDateUpdated: "Next payment date updated.", // New translation
                    currentInstallmentLabel: "Current Installment" // New translation
                }
            };

            /**
             * Função debounce para limitar a frequência de execução de uma função.
             * @param {Function} func - A função a ser "debouced".
             * @param {number} delay - O tempo de atraso em milissegundos.
             * @returns {Function} A função "debouced".
             */
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            /**
             * Aplica as traduções aos elementos do DOM com o atributo data-i18n.
             */
            function applyTranslations() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (translations[currentLanguage] && translations[currentLanguage][key]) {
                        if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                            element.setAttribute('placeholder', translations[currentLanguage][key]);
                        } else {
                            element.textContent = translations[currentLanguage][key];
                        }
                    }
                });
                // Atualiza o título da página
                document.title = translations[currentLanguage].appTitle;
            }

            /**
             * Formata um valor numérico para o formato de moeda brasileira (R$).
             * @param {number} value - O valor a ser formatado.
             * @returns {string} O valor formatado como R$.
             */
            function formatCurrency(value) {
                return new Intl.NumberFormat(currentLanguage === 'pt' ? 'pt-BR' : 'en-US', {
                    style: 'currency',
                    currency: 'BRL' // Moeda permanece BRL, apenas a formatação muda
                }).format(value);
            }

            /**
             * Exibe uma mensagem ao usuário na messageBox.
             * @param {string} messageKey - A chave da mensagem no objeto de traduções.
             * @param {string} type - Tipo da mensagem ('success', 'error', 'warning', 'info'). Controla a cor de fundo.
             * @param {object} [placeholders={}] - Objeto com pares chave-valor para substituir no texto da mensagem.
             */
            function showMessage(messageKey, type = 'info', placeholders = {}) {
                let message = translations[currentLanguage][messageKey] || messageKey; // Fallback para a chave se não houver tradução

                // Substituir placeholders
                for (const key in placeholders) {
                    message = message.replace(`{${key}}`, placeholders[key]);
                }

                messageBox.innerHTML = message; // Usar innerHTML para permitir tags HTML como <strong>
                messageBox.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50';

                switch (type) {
                    case 'success':
                        messageBox.classList.add('bg-green-600', 'text-white');
                        break;
                    case 'error':
                        messageBox.classList.add('bg-red-600', 'text-white');
                        break;
                    case 'warning':
                        messageBox.classList.add('bg-yellow-500', 'text-gray-900');
                        break;
                    case 'info':
                    default:
                        messageBox.classList.add('bg-gray-800', 'text-white');
                        break;
                }

                messageBox.classList.add('active', 'opacity-100');
                setTimeout(() => {
                    messageBox.classList.remove('opacity-100');
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => {
                        messageBox.classList.remove('active');
                    }, 300); // Espera a transição de opacidade terminar
                }, 3000); // Mensagem visível por 3 segundos
            }

            /**
             * Abre um modal específico.
             * @param {HTMLElement} modalElement - O elemento do modal a ser aberto.
             */
            function openModal(modalElement) {
                modalElement.classList.add('active');
                // Adiciona um listener para fechar o modal ao clicar fora
                setTimeout(() => { // Pequeno delay para evitar clique acidental no overlay
                    modalElement.addEventListener('click', closeOnOverlayClick);
                }, 50);
            }

            /**
             * Fecha um modal específico.
             * @param {HTMLElement} modalElement - O elemento do modal a ser fechado.
             */
            function closeModal(modalElement) {
                modalElement.classList.remove('active');
                modalElement.removeEventListener('click', closeOnOverlayClick);
            }

            /**
             * Fecha o modal se o clique for no overlay (fora do conteúdo).
             * @param {Event} event - O evento de clique.
             */
            function closeOnOverlayClick(event) {
                if (event.target === this) { // 'this' refere-se ao modalElement no addEventListener
                    closeModal(this);
                }
            }

            /**
             * Gera um ID único baseado em timestamp e string aleatória.
             * @returns {string} ID único.
             */
            function generateUniqueId() {
                return `id-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            }

            // --- Funções de Armazenamento Local ---

            /**
             * Salva os dados no localStorage.
             */
            function saveData() {
                try {
                    localStorage.setItem(PRODUCT_STORAGE_KEY, JSON.stringify(allProducts));
                    localStorage.setItem(SALE_STORAGE_KEY, JSON.stringify(allSales));
                    localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLanguage); // Salva o idioma
                    statusMessage.textContent = translations[currentLanguage].statusSaved;
                } catch (error) {
                    console.error('Erro ao salvar dados no localStorage:', error);
                    showMessage('saveDataError', 'error');
                }
            }

            /**
             * Carrega os dados do localStorage.
             */
            function loadData() {
                try {
                    const storedProducts = localStorage.getItem(PRODUCT_STORAGE_KEY);
                    const storedSales = localStorage.getItem(SALE_STORAGE_KEY);
                    const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY);

                    allProducts = storedProducts ? JSON.parse(storedProducts) : [];
                    allSales = storedSales ? JSON.parse(storedSales) : [];
                    currentLanguage = storedLanguage || 'pt'; // Define o idioma carregado ou 'pt' como padrão

                    // Garante que as vendas antigas tenham as novas propriedades de parcelamento
                    allSales.forEach(sale => {
                        if (sale.paymentType === 'Parcelado' && !sale.installmentDetails.paymentsMade) {
                            sale.installmentDetails.paymentsMade = [];
                            sale.installmentDetails.currentInstallment = 1;
                            // Se nextPaymentDate não existir, define-o para 30 dias após a venda original
                            if (!sale.nextPaymentDate) {
                                const saleDate = new Date(sale.timestamp);
                                saleDate.setDate(saleDate.getDate() + 30);
                                sale.nextPaymentDate = saleDate.getTime();
                            }
                        }
                        // Define o status da venda parcelada
                        if (sale.paymentType === 'Parcelado') {
                            updateInstallmentStatus(sale);
                        }
                    });


                    if (modalLanguageSelector) {
                        modalLanguageSelector.value = currentLanguage; // Atualiza o seletor do modal
                    }
                    applyTranslations(); // Aplica as traduções
                    statusMessage.textContent = translations[currentLanguage].statusLoaded;
                    renderProducts();
                } catch (error) {
                    console.error('Erro ao carregar dados do localStorage:', error);
                    showMessage('loadDataError', 'error');
                    // Opcionalmente, limpa dados corrompidos para prevenir problemas futuros
                    localStorage.removeItem(PRODUCT_STORAGE_KEY);
                    localStorage.removeItem(SALE_STORAGE_KEY);
                    allProducts = [];
                    allSales = [];
                }
            }

            // --- Funções de Gestão de Produtos ---

            /**
             * Valida os campos do formulário de produto.
             * @param {object} product - Objeto contendo os dados do produto.
             * @returns {string|null} Chave da mensagem de erro se a validação falhar, ou null se for bem-sucedida.
             */
            function validateProductForm(product) {
                if (!product.name.trim()) return 'productNameRequired';
                if (!product.color.trim()) return 'colorRequired';
                if (!product.size.trim()) return 'sizeRequired';
                if (!product.sku.trim()) return 'skuRequired';
                if (isNaN(product.quantity) || product.quantity < 0) return 'quantityInvalid';
                if (isNaN(product.price) || product.price < 0) return 'priceInvalid';
                return null;
            }

            /**
             * Renderiza a lista de produtos na interface.
             */
            function renderProducts() {
                loadingProducts.classList.add('hidden');
                productsList.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();

                const filteredProducts = allProducts.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.sku.toLowerCase().includes(searchTerm) ||
                    product.color.toLowerCase().includes(searchTerm) ||
                    product.size.toLowerCase().includes(searchTerm)
                );

                if (filteredProducts.length === 0) {
                    noProductsFound.classList.remove('hidden');
                } else {
                    noProductsFound.classList.add('hidden');
                    filteredProducts.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        // Usa product.imageData para a imagem do card
                        productCard.innerHTML = `
                            <img src="${product.imageData || 'https://via.placeholder.com/150x150?text=Sem+Imagem'}" alt="${product.name}" class="product-card-img">
                            <div class="product-card-info">
                                <h3 class="text-lg font-semibold text-gray-800">${product.name}</h3>
                                <p class="text-sm text-gray-600">${translations[currentLanguage].colorLabel}: ${product.color} | ${translations[currentLanguage].sizeLabel}: ${product.size}</p>
                                <p class="text-sm text-gray-600">SKU: ${product.sku}</p>
                                <p class="text-xl font-bold text-angeli-darkpink mt-2">${translations[currentLanguage].quantityLabel}: ${product.quantity}</p>
                                <p class="text-md font-medium text-gray-700">${formatCurrency(product.price)}</p>
                            </div>
                            <div class="product-card-actions">
                                <button class="product-card-action-btn edit-product-btn" data-id="${product.id}" title="${translations[currentLanguage].editButton}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.72a.75.75 0 0 1-.942-.942l.72-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                                    </svg>
                                    <span>${translations[currentLanguage].editButton}</span>
                                </button>
                                <button class="product-card-action-btn delete-product-btn" data-id="${product.id}" title="${translations[currentLanguage].deleteButton}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.925a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165 1.104 1.637-.659 2.115m9.462-2.115c-.141-.01-.282-.02-.423-.03M7.5 7.5c.414-.414 1.125-1.029 1.956-1.029M12 5.25v1.5m-3.956-1.029C8.385 5.293 7.5 5.584 7.5 7.5c0 1.914.885 2.204 1.956 2.204" />
                                    </svg>
                                    <span>${translations[currentLanguage].deleteButton}</span>
                                </button>
                            </div>
                        `;
                        productsList.appendChild(productCard);
                    });

                    // Adicionar event listeners aos botões de editar e excluir
                    document.querySelectorAll('.edit-product-btn').forEach(button => {
                        button.addEventListener('click', (event) => editProduct(event.currentTarget.dataset.id));
                    });
                    document.querySelectorAll('.delete-product-btn').forEach(button => {
                        button.addEventListener('click', (event) => deleteProduct(event.currentTarget.dataset.id));
                    });
                }
            }

            /**
             * Abre o modal de produto para adicionar um novo produto.
             */
            function openAddProductModal() {
                productForm.reset(); // Limpa o formulário
                editingProductId = null; // Reinicia o ID de edição
                productModalTitle.textContent = translations[currentLanguage].addProductTitle;
                productImagePreview.classList.add('hidden'); // Esconde a pré-visualização
                productImagePreview.src = ''; // Limpa a imagem de pré-visualização
                openModal(productModal);
            }

            /**
             * Preenche o formulário de produto com os dados do produto para edição.
             * @param {string} id - O ID do produto a ser editado.
             */
            function editProduct(id) {
                const productToEdit = allProducts.find(p => p.id === id);
                if (productToEdit) {
                    editingProductId = id;
                    productModalTitle.textContent = translations[currentLanguage].editProductTitle;
                    productName.value = productToEdit.name;
                    productColor.value = productToEdit.color;
                    productSize.value = productToEdit.size;
                    productSKU.value = productToEdit.sku;
                    productQuantity.value = productToEdit.quantity;
                    productPrice.value = productToEdit.price;
                    productImage.value = ''; // Limpa o input de arquivo por segurança
                    if (productToEdit.imageData) {
                        productImagePreview.src = productToEdit.imageData;
                        productImagePreview.classList.remove('hidden');
                    } else {
                        productImagePreview.src = '';
                        productImagePreview.classList.add('hidden');
                    }
                    openModal(productModal);
                } else {
                    showMessage('productNotFoundEdit', 'error');
                }
            }

            /**
             * Lida com o envio do formulário de produto (adicionar/editar).
             * @param {Event} event - O evento de envio do formulário.
             */
            async function handleProductFormSubmit(event) { // Tornar a função assíncrona
                event.preventDefault();

                let imageData = '';
                if (productImage.files && productImage.files[0]) {
                    // Se um novo arquivo foi selecionado, lê-o
                    imageData = await readFileAsDataURL(productImage.files[0]);
                } else if (editingProductId) {
                    // Se estiver editando e nenhum novo arquivo foi selecionado, mantém a imagem existente
                    const existingProduct = allProducts.find(p => p.id === editingProductId);
                    if (existingProduct) {
                        imageData = existingProduct.imageData || '';
                    }
                }

                const newProduct = {
                    name: productName.value.trim(),
                    color: productColor.value.trim(),
                    size: productSize.value.trim(),
                    sku: productSKU.value.trim(),
                    quantity: parseInt(productQuantity.value, 10),
                    price: parseFloat(productPrice.value),
                    imageData: imageData, // Armazena a imagem em base64
                };

                const validationErrorKey = validateProductForm(newProduct);
                if (validationErrorKey) {
                    showMessage(validationErrorKey, 'warning');
                    return;
                }

                if (editingProductId) {
                    // Edita produto existente
                    const productIndex = allProducts.findIndex(p => p.id === editingProductId);
                    if (productIndex !== -1) {
                        allProducts[productIndex] = { ...allProducts[productIndex], ...newProduct };
                        showMessage('productUpdatedSuccess', 'success');
                    } else {
                        showMessage('productNotFoundEdit', 'error'); // Caso o produto desapareça misteriosamente
                    }
                } else {
                    // Adiciona novo produto
                    newProduct.id = generateUniqueId();
                    newProduct.createdAt = Date.now();
                    allProducts.push(newProduct);
                    showMessage('productAddedSuccess', 'success');
                }

                saveData();
                renderProducts();
                closeModal(productModal);
            }

            /**
             * Lê um arquivo como Data URL (Base64).
             * @param {File} file - O objeto File a ser lido.
             * @returns {Promise<string>} Uma Promise que resolve com a Data URL do arquivo.
             */
            function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            /**
             * Solicita confirmação antes de excluir um produto.
             * @param {string} id - O ID do produto a ser excluído.
             */
            function deleteProduct(id) {
                const productToDelete = allProducts.find(p => p.id === id);
                if (!productToDelete) {
                    showMessage('productNotFoundDelete', 'error');
                    return;
                }

                confirmModalTitle.textContent = translations[currentLanguage].confirmation;
                confirmModalMessage.innerHTML = translations[currentLanguage].productDeleteConfirm.replace('{productName}', productToDelete.name);
                openModal(confirmModal);

                // Define a ação de confirmação para o botão do modal
                confirmActionBtn.onclick = () => {
                    allProducts = allProducts.filter(p => p.id !== id);
                    saveData();
                    renderProducts();
                    showMessage('productDeleteSuccess', 'success');
                    closeModal(confirmModal);
                };
            }

            // --- Funções de Registro de Vendas ---

            /**
             * Preenche o dropdown de seleção de produtos no modal de venda.
             * @param {string} [searchTerm=''] - Termo de pesquisa para filtrar os produtos.
             */
            function populateSaleProductSelect(searchTerm = '') {
                saleProductSelect.innerHTML = `<option value="">${translations[currentLanguage].selectOption}</option>`;
                const lowerCaseSearchTerm = searchTerm.toLowerCase();

                const availableProducts = allProducts.filter(product =>
                    product.quantity > 0 &&
                    (product.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                     product.sku.toLowerCase().includes(lowerCaseSearchTerm))
                );

                if (availableProducts.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = translations[currentLanguage].noProducts;
                    option.disabled = true;
                    saleProductSelect.appendChild(option);
                    addItemToSaleBtn.disabled = true;
                } else {
                    availableProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.sku}) - ${translations[currentLanguage].quantityLabel}: ${product.quantity}`;
                        saleProductSelect.appendChild(option);
                    });
                    addItemToSaleBtn.disabled = false;
                }
            }

            /**
             * Abre o modal de registro de venda e reinicia seus campos.
             */
            function openRegisterSaleModal() {
                saleForm.reset();
                currentSaleItems = [];
                renderSaleItems();
                calculateTotalSaleAmount();
                paymentType.value = 'À Vista';
                installmentDetails.classList.add('hidden');
                numInstallments.removeAttribute('required'); // Garante que não é obrigatório ao abrir
                interestPercentage.value = 0; // Reseta juros
                customerName.value = '';
                saleProductSearchInput.value = ''; // Limpa o campo de pesquisa
                populateSaleProductSelect(); // Popula com todos os produtos disponíveis
                openModal(saleModal);
            }

            /**
             * Adiciona um item selecionado à lista temporária da venda.
             */
            function addItemToSale() {
                const productId = saleProductSelect.value;
                const quantity = parseInt(saleQuantity.value, 10);

                if (!productId) {
                    showMessage('selectProductWarning', 'warning');
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    showMessage('quantityPositiveWarning', 'warning');
                    return;
                }

                const product = allProducts.find(p => p.id === productId);
                if (!product) {
                    showMessage('productNotFoundSale', 'error');
                    return;
                }

                if (quantity > product.quantity) {
                    showMessage('insufficientStock', 'warning', { productName: product.name, availableQuantity: product.quantity });
                    return;
                }

                const existingItemIndex = currentSaleItems.findIndex(item => item.productId === productId);

                if (existingItemIndex !== -1) {
                    // Se o item já existe, atualiza a quantidade
                    const currentItem = currentSaleItems[existingItemIndex];
                    if (currentItem.quantity + quantity > product.quantity) {
                        showMessage('exceedsStock', 'warning', { quantity: quantity, productName: product.name, availableQuantity: product.quantity - currentItem.quantity });
                        return;
                    }
                    currentItem.quantity += quantity;
                    showMessage('quantityUpdatedSale', 'info', { productName: product.name });
                } else {
                    // Adiciona novo item
                    currentSaleItems.push({
                        productId: product.id,
                        name: product.name,
                        sku: product.sku,
                        unitPrice: product.price,
                        quantity: quantity
                    });
                    showMessage('itemAddedSale', 'success', { quantity: quantity, productName: product.name });
                }

                renderSaleItems();
                calculateTotalSaleAmount();
                saleQuantity.value = 1; // Reseta a quantidade para 1 após adicionar
                saleProductSelect.value = ''; // Limpa a seleção do produto
                saleProductSearchInput.value = ''; // Limpa o campo de pesquisa
                populateSaleProductSelect(); // Re-popula para refletir o estoque atualizado e limpar a pesquisa
            }

            /**
             * Remove um item da lista temporária da venda.
             * @param {string} productId - O ID do produto a ser removido da venda.
             */
            function removeSaleItem(productId) {
                currentSaleItems = currentSaleItems.filter(item => item.productId !== productId);
                renderSaleItems();
                calculateTotalSaleAmount();
                showMessage('itemRemovedSale', 'info');
                populateSaleProductSelect(saleProductSearchInput.value); // Atualiza a lista de seleção de produtos
            }

            /**
             * Renderiza os itens adicionados à venda no modal.
             */
            function renderSaleItems() {
                saleItemList.innerHTML = '';
                if (currentSaleItems.length === 0) {
                    noSaleItems.classList.remove('hidden');
                    noSaleItems.textContent = translations[currentLanguage].noSaleItems;
                } else {
                    noSaleItems.classList.add('hidden');
                    currentSaleItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                        itemDiv.innerHTML = `
                            <span>${item.quantity}x ${item.name} (${item.sku}) - ${formatCurrency(item.unitPrice)}/${translations[currentLanguage].unitShort || 'un'}</span>
                            <span class="font-semibold">${formatCurrency(item.quantity * item.unitPrice)}</span>
                            <button type="button" class="text-red-500 hover:text-red-700 ml-2 remove-sale-item-btn" data-product-id="${item.productId}">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.925a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165 1.104 1.637-.659 2.115m9.462-2.115c-.141-.01-.282-.02-.423-.03M7.5 7.5c.414-.414 1.125-1.029 1.956-1.029M12 5.25v1.5m-3.956-1.029C8.385 5.293 7.5 5.584 7.5 7.5c0 1.914.885 2.204 1.956 2.204" />
                                </svg>
                            </button>
                        `;
                        saleItemList.appendChild(itemDiv);
                    });

                    document.querySelectorAll('.remove-sale-item-btn').forEach(button => {
                        button.addEventListener('click', (event) => removeSaleItem(event.currentTarget.dataset.productId));
                    });
                }
            }

            /**
             * Calcula e exibe o valor total da venda.
             */
            function calculateTotalSaleAmount() {
                let total = currentSaleItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);

                // Aplica juros se for pagamento parcelado
                if (paymentType.value === 'Parcelado') {
                    const interest = parseFloat(interestPercentage.value);
                    if (!isNaN(interest) && interest > 0) {
                        total *= (1 + interest / 100);
                    }
                }

                totalSaleAmount.textContent = formatCurrency(total);

                // Atualiza o valor da parcela se o tipo de pagamento for 'Parcelado'
                if (paymentType.value === 'Parcelado' && numInstallments.value > 0) {
                    const installments = parseInt(numInstallments.value, 10);
                    if (!isNaN(installments) && installments > 0) {
                        installmentValue.value = formatCurrency(total / installments);
                    } else {
                        installmentValue.value = formatCurrency(0);
                    }
                } else {
                    installmentValue.value = formatCurrency(0); // Limpa se não for parcelado
                }
            }

            /**
             * Lida com a finalização da venda.
             * @param {Event} event - O evento de envio do formulário.
             */
            function handleSaleFormSubmit(event) {
                event.preventDefault();
                console.log("Attempting to finalize sale...");

                finalizeSaleBtn.disabled = true; // Desabilita o botão
                finalizeSaleSpinner.classList.remove('hidden'); // Mostra o spinner

                if (currentSaleItems.length === 0) {
                    showMessage('saleEmptyWarning', 'warning');
                    console.log("Sale empty, not finalizing.");
                    finalizeSaleBtn.disabled = false;
                    finalizeSaleSpinner.classList.add('hidden');
                    return;
                }

                let saleTotal = currentSaleItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
                const selectedPaymentType = paymentType.value;
                let saleInstallmentDetails = null;
                let nextPaymentDate = null;

                if (selectedPaymentType === 'Parcelado') {
                    const installments = parseInt(numInstallments.value, 10);
                    const interest = parseFloat(interestPercentage.value);

                    if (isNaN(installments) || installments <= 1) {
                        showMessage('invalidInstallments', 'warning');
                        console.log("Invalid number of installments.");
                        finalizeSaleBtn.disabled = false;
                        finalizeSaleSpinner.classList.add('hidden');
                        return;
                    }

                    // Aplica juros ao total da venda
                    if (!isNaN(interest) && interest > 0) {
                        saleTotal *= (1 + interest / 100);
                    }

                    saleInstallmentDetails = {
                        numInstallments: installments,
                        interestPercentage: interest,
                        valuePerInstallment: saleTotal / installments,
                        paymentsMade: [], // Inicializa array de pagamentos feitos
                        currentInstallment: 1 // Inicializa a parcela atual
                    };

                    // Calcula a próxima data de pagamento (ex: 30 dias após a venda)
                    const today = new Date();
                    today.setDate(today.getDate() + 30);
                    nextPaymentDate = today.getTime(); // Armazena como timestamp
                }

                // Deduz as quantidades do estoque
                let stockUpdateSuccess = true;
                currentSaleItems.forEach(saleItem => {
                    const productIndex = allProducts.findIndex(p => p.id === saleItem.productId);
                    if (productIndex !== -1) {
                        if (allProducts[productIndex].quantity >= saleItem.quantity) {
                            allProducts[productIndex].quantity -= saleItem.quantity;
                            console.log(`Deducted ${saleItem.quantity} from product ${saleItem.name}. New quantity: ${allProducts[productIndex].quantity}`);
                        } else {
                            showMessage('insufficientStock', 'error', { productName: saleItem.name, availableQuantity: allProducts[productIndex].quantity });
                            stockUpdateSuccess = false;
                            console.log(`Insufficient stock for ${saleItem.name}. Available: ${allProducts[productIndex].quantity}`);
                            return; // Sai do forEach se encontrar um problema
                        }
                    }
                });

                if (!stockUpdateSuccess) {
                    console.log("Stock update failed, sale not finalized.");
                    finalizeSaleBtn.disabled = false;
                    finalizeSaleSpinner.classList.add('hidden');
                    return; // Interrompe se houve um problema com o estoque
                }

                // Cria o novo objeto de venda
                const newSale = {
                    id: generateUniqueId(),
                    timestamp: Date.now(),
                    items: currentSaleItems.map(item => ({
                        productId: item.productId,
                        name: item.name,
                        sku: item.sku,
                        unitPrice: item.unitPrice,
                        quantity: item.quantity
                    })),
                    totalAmount: saleTotal,
                    paymentType: selectedPaymentType,
                    installmentDetails: saleInstallmentDetails,
                    customerName: customerName.value.trim() || translations[currentLanguage].notInformed,
                    status: 'completed', // Status inicial da venda (não da parcela)
                    nextPaymentDate: nextPaymentDate // Adiciona a data do próximo pagamento
                };
                
                // Atualiza o status da venda parcelada recém-criada
                if (newSale.paymentType === 'Parcelado') {
                    updateInstallmentStatus(newSale);
                }

                allSales.unshift(newSale); // Adiciona ao início da lista para que as mais recentes apareçam primeiro
                console.log("New sale added:", newSale);

                saveData();
                renderProducts(); // Atualiza a lista de produtos para refletir as novas quantidades
                showMessage('saleRegisteredSuccess', 'success');
                console.log("Sale finalized successfully!");
                closeModal(saleModal);

                finalizeSaleBtn.disabled = false; // Reabilita o botão
                finalizeSaleSpinner.classList.add('hidden'); // Esconde o spinner
            }

            /**
             * Renderiza o histórico de vendas.
             */
            function renderSalesHistory() {
                loadingSales.classList.add('hidden');
                salesList.innerHTML = '';

                if (allSales.length === 0) {
                    noSalesFound.classList.remove('hidden');
                    noSalesFound.textContent = translations[currentLanguage].noSales;
                } else {
                    noSalesFound.classList.add('hidden');
                    allSales.forEach(sale => {
                        const saleCard = document.createElement('div');
                        saleCard.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                        const saleDate = new Date(sale.timestamp).toLocaleString(currentLanguage === 'pt' ? 'pt-BR' : 'en-US');
                        let installmentInfo = '';
                        let nextPaymentInfo = '';
                        let statusInfo = '';

                        if (sale.paymentType === 'Parcelado' && sale.installmentDetails) {
                            installmentInfo = `(${sale.installmentDetails.numInstallments}x de ${formatCurrency(sale.installmentDetails.valuePerInstallment)}`;
                            if (sale.installmentDetails.interestPercentage > 0) {
                                installmentInfo += ` com ${sale.installmentDetails.interestPercentage}% de juros`;
                            }
                            installmentInfo += `)`;

                            if (sale.nextPaymentDate) {
                                const nextPayDate = new Date(sale.nextPaymentDate).toLocaleDateString(currentLanguage === 'pt' ? 'pt-BR' : 'en-US');
                                nextPaymentInfo = `<p class="text-sm text-gray-700">${translations[currentLanguage].nextPaymentDateLabel}: ${nextPayDate}</p>`;
                            }
                            const statusClass = `status-${sale.installmentDetails.status.replace('_', '-')}`;
                            statusInfo = `<p class="text-sm ${statusClass}">${translations[currentLanguage].status}: ${translations[currentLanguage]['status_' + sale.installmentDetails.status]}</p>`;
                        }

                        saleCard.innerHTML = `
                            <p class="text-sm text-gray-500 mb-2">Venda ID: ${sale.id}</p>
                            <h4 class="text-lg font-semibold text-angeli-darkpink">${formatCurrency(sale.totalAmount)}</h4>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].dateLabel || 'Data'}: ${saleDate}</p>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].customerLabel || 'Cliente'}: ${sale.customerName}</p>
                            <p class="text-sm text-gray-700 mb-3">${translations[currentLanguage].paymentLabel || 'Pagamento'}: ${translations[currentLanguage][sale.paymentType.toLowerCase().replace(' ', '')] || sale.paymentType} ${installmentInfo}</p>
                            ${nextPaymentInfo}
                            ${statusInfo}
                            <h5 class="font-medium text-gray-700 mb-1">${translations[currentLanguage].saleItems}:</h5>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                ${sale.items.map(item => `
                                    <li>${item.quantity}x ${item.name} (${item.sku}) - ${formatCurrency(item.unitPrice)}/${translations[currentLanguage].unitShort || 'un'} = ${formatCurrency(item.quantity * item.unitPrice)}</li>
                                `).join('')}
                            </ul>
                        `;
                        salesList.appendChild(saleCard);
                    });
                }
            }

            /**
             * Atualiza o status de uma venda parcelada.
             * @param {object} sale - O objeto de venda.
             */
            function updateInstallmentStatus(sale) {
                if (sale.paymentType !== 'Parcelado' || !sale.installmentDetails) return;

                const now = Date.now();
                const paidCount = sale.installmentDetails.paymentsMade.length;
                const totalInstallments = sale.installmentDetails.numInstallments;

                if (paidCount >= totalInstallments) {
                    sale.installmentDetails.status = 'completed';
                } else if (sale.nextPaymentDate && now > sale.nextPaymentDate) {
                    sale.installmentDetails.status = 'overdue';
                } else {
                    sale.installmentDetails.status = 'on_time';
                }
            }

            /**
             * Renderiza a secção de controlo de parcelamentos.
             */
            function renderInstallmentControl() {
                loadingInstallments.classList.add('hidden');
                installmentSalesList.innerHTML = '';

                let totalReceivable = 0;
                const installmentSales = allSales.filter(sale => sale.paymentType === 'Parcelado');

                if (installmentSales.length === 0) {
                    noInstallmentsFound.classList.remove('hidden');
                    noInstallmentsFound.textContent = translations[currentLanguage].noInstallments;
                } else {
                    noInstallmentsFound.classList.add('hidden');
                    installmentSales.forEach(sale => {
                        updateInstallmentStatus(sale); // Garante que o status esteja atualizado
                        
                        const paidCount = sale.installmentDetails.paymentsMade.length;
                        const totalInstallments = sale.installmentDetails.numInstallments;
                        const remainingInstallments = totalInstallments - paidCount;
                        const remainingAmount = remainingInstallments * sale.installmentDetails.valuePerInstallment;
                        totalReceivable += remainingAmount;

                        const saleCard = document.createElement('div');
                        let cardClass = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                        if (sale.installmentDetails.status === 'overdue') {
                            cardClass += ' card-overdue'; // Adiciona a classe para borda vermelha
                        }
                        saleCard.className = cardClass;

                        const saleDate = new Date(sale.timestamp).toLocaleDateString(currentLanguage === 'pt' ? 'pt-BR' : 'en-US');
                        const nextPayDate = sale.nextPaymentDate ? new Date(sale.nextPaymentDate).toLocaleDateString(currentLanguage === 'pt' ? 'pt-BR' : 'en-US') : translations[currentLanguage].notInformed;
                        
                        const statusClass = `status-${sale.installmentDetails.status.replace('_', '-')}`;
                        const statusText = translations[currentLanguage]['status_' + sale.installmentDetails.status];

                        saleCard.innerHTML = `
                            <p class="text-sm text-gray-500 mb-2">Venda ID: ${sale.id}</p>
                            <h4 class="text-lg font-semibold text-angeli-darkpink">${translations[currentLanguage].customerNameLabel}: ${sale.customerName}</h4>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].totalSale}: ${formatCurrency(sale.totalAmount)}</p>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].installmentsPaid}: ${paidCount}/${totalInstallments} (${translations[currentLanguage].currentInstallmentLabel}: ${paidCount + 1})</p>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].installmentValue}: ${formatCurrency(sale.installmentDetails.valuePerInstallment)}</p>
                            <p class="text-sm text-gray-700">${translations[currentLanguage].interestPercentageLabel}: ${sale.installmentDetails.interestPercentage || 0}%</p>
                            <p class="text-sm text-gray-700 ${statusClass}">${translations[currentLanguage].status}: ${statusText}</p>
                            <p class="text-sm text-gray-700 ${sale.installmentDetails.status === 'overdue' ? 'text-red-500 font-semibold' : ''}">${translations[currentLanguage].paymentDue}: ${nextPayDate}</p>
                            <p class="text-lg font-bold text-gray-800 mt-2">${translations[currentLanguage].remainingAmount}: ${formatCurrency(remainingAmount)}</p>
                            <div class="mt-4 flex justify-end">
                                ${sale.installmentDetails.status !== 'completed' ? `
                                <button class="angeli-btn angeli-btn-primary text-sm px-4 py-2 mark-as-paid-btn" data-id="${sale.id}">
                                    ${translations[currentLanguage].markAsPaid}
                                </button>
                                ` : ''}
                            </div>
                        `;
                        installmentSalesList.appendChild(saleCard);
                    });

                    document.querySelectorAll('.mark-as-paid-btn').forEach(button => {
                        button.addEventListener('click', (event) => markInstallmentAsPaid(event.currentTarget.dataset.id));
                    });
                }
                totalAmountToReceive.textContent = formatCurrency(totalReceivable);
                saveData(); // Salva o status atualizado
            }

            /**
             * Marca uma parcela como paga e atualiza a venda.
             * @param {string} saleId - O ID da venda.
             */
            function markInstallmentAsPaid(saleId) {
                const saleIndex = allSales.findIndex(s => s.id === saleId);
                if (saleIndex === -1) return;

                const sale = allSales[saleIndex];
                if (sale.paymentType !== 'Parcelado' || !sale.installmentDetails) return;

                const paidCount = sale.installmentDetails.paymentsMade.length;
                const totalInstallments = sale.installmentDetails.numInstallments;

                if (paidCount >= totalInstallments) {
                    showMessage('allInstallmentsPaid', 'info');
                    return;
                }

                // Adiciona o pagamento atual
                sale.installmentDetails.paymentsMade.push({
                    installmentNumber: paidCount + 1,
                    paymentDate: Date.now(),
                    amount: sale.installmentDetails.valuePerInstallment
                });

                // Atualiza a próxima data de pagamento
                if (sale.installmentDetails.paymentsMade.length < totalInstallments) {
                    // Se já existe uma nextPaymentDate, usa-a como base, senão usa o timestamp da venda
                    const baseDate = sale.nextPaymentDate ? new Date(sale.nextPaymentDate) : new Date(sale.timestamp);
                    baseDate.setDate(baseDate.getDate() + 30); // Adiciona 30 dias para a próxima parcela
                    sale.nextPaymentDate = baseDate.getTime();
                    showMessage('paymentDateUpdated', 'info');
                } else {
                    sale.nextPaymentDate = null; // Todas as parcelas pagas
                }
                
                updateInstallmentStatus(sale); // Atualiza o status da venda
                saveData();
                renderInstallmentControl();
                showMessage('installmentPaidSuccess', 'success');
            }


            // --- Funções de Relatórios e Visualizações ---

            /**
             * Exibe o total de unidades em estoque e o valor total do estoque.
             */
            function showTotalStock() {
                const totalUnits = allProducts.reduce((sum, product) => sum + product.quantity, 0);
                const totalStockValue = allProducts.reduce((sum, product) => sum + (product.quantity * product.price), 0);
                showMessage('totalStockMessage', 'info', { totalUnits: totalUnits, totalValue: formatCurrency(totalStockValue) });
            }

            /**
             * Gera um resumo do estoque e das vendas.
             */
            function generateReport() {
                const totalStockValue = allProducts.reduce((sum, product) => sum + (product.quantity * product.price), 0);
                const totalSalesValue = allSales.reduce((sum, sale) => sum + sale.totalAmount, 0);

                showMessage('reportSummary', 'info', { totalStockValue: formatCurrency(totalStockValue), totalSalesValue: formatCurrency(totalSalesValue) });
            }

            // --- Funções de Backup e Restauração ---

            /**
             * Exporta os dados atuais como um arquivo JSON.
             */
            function exportData() {
                const dataToExport = {
                    products: allProducts,
                    sales: allSales
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `angeli_data_backup_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('dataExportSuccess', 'success');
            }

            /**
             * Permite ao usuário importar dados de um arquivo JSON.
             */
            function importData() {
                importDataInput.click(); // Aciona o clique no input de arquivo escondido
            }

            /**
             * Lida com a seleção e leitura do arquivo JSON para importação.
             * @param {Event} event - O evento de mudança do input de arquivo.
             */
            function handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.products || !importedData.sales) {
                            throw new Error(translations[currentLanguage].invalidJsonFormat);
                        }

                        confirmModalTitle.textContent = translations[currentLanguage].confirmation;
                        confirmModalMessage.innerHTML = translations[currentLanguage].importConfirm;
                        openModal(confirmModal);

                        confirmActionBtn.onclick = () => {
                            allProducts = importedData.products;
                            allSales = importedData.sales;
                            saveData();
                            renderProducts();
                            showMessage('dataImportSuccess', 'success');
                            closeModal(confirmModal);
                            // Reseta o input de arquivo para permitir importar o mesmo arquivo novamente se necessário
                            importDataInput.value = '';
                        };
                    } catch (error) {
                        console.error('Erro ao importar dados:', error);
                        showMessage('fileReadError', 'error', { message: error.message });
                        importDataInput.value = ''; // Reseta o input em caso de erro
                    }
                };
                reader.onerror = () => {
                    showMessage('fileReadError', 'error');
                    importDataInput.value = ''; // Reseta o input em caso de erro
                };
                reader.readAsText(file);
            }


            // --- Inicialização e Event Listeners ---

            // Carrega os dados e o idioma ao carregar a página
            loadData();

            // --- Event Listeners Globais ---
            addProductBtn.addEventListener('click', openAddProductModal);
            registerSaleBtn.addEventListener('click', openRegisterSaleModal);
            
            viewSalesHistoryBtn.addEventListener('click', () => {
                productsSection.classList.add('hidden');
                installmentControlSection.classList.add('hidden'); // Esconde a nova seção
                salesHistorySection.classList.remove('hidden');
                renderSalesHistory();
            });

            viewInstallmentControlBtn.addEventListener('click', () => {
                productsSection.classList.add('hidden');
                salesHistorySection.classList.add('hidden');
                installmentControlSection.classList.remove('hidden'); // Mostra a nova seção
                renderInstallmentControl();
            });

            // Correção para o botão "Voltar aos Produtos"
            backToProductsBtn.addEventListener('click', () => {
                salesHistorySection.classList.add('hidden');
                installmentControlSection.classList.add('hidden'); // Esconde a nova seção
                productsSection.classList.remove('hidden');
                renderProducts(); // Garante que a lista de produtos seja renderizada novamente
            });

            backToProductsFromInstallmentsBtn.addEventListener('click', () => {
                salesHistorySection.classList.add('hidden');
                installmentControlSection.classList.add('hidden'); // Esconde a nova seção
                productsSection.classList.remove('hidden');
                renderProducts(); // Garante que a lista de produtos seja renderizada novamente
            });

            viewTotalStockBtn.addEventListener('click', showTotalStock);
            generateReportBtn.addEventListener('click', generateReport);
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', importData);
            importDataInput.addEventListener('change', handleFileImport);
            searchInput.addEventListener('input', renderProducts); // Pesquisa em tempo real

            // Abrir modal de configurações ao clicar no botão
            settingsBtn.addEventListener('click', () => {
                modalLanguageSelector.value = currentLanguage; // sincroniza valor atual
                openModal(settingsModal);
            });

            // Fechar modal de configurações
            closeSettingsBtn.addEventListener('click', () => {
                closeModal(settingsModal);
            });

            // Trocar idioma pelo seletor no modal
            modalLanguageSelector.addEventListener('change', (event) => {
                currentLanguage = event.target.value;
                saveData();
                applyTranslations();
            });

            // Event Listener para a pré-visualização da imagem do produto
            productImage.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        productImagePreview.src = e.target.result;
                        productImagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    productImagePreview.src = '';
                    productImagePreview.classList.add('hidden');
                }
            });

            // Event Listeners do Modal de Produto
            productForm.addEventListener('submit', handleProductFormSubmit);
            cancelProductBtn.addEventListener('click', () => closeModal(productModal));

            // Event Listeners do Modal de Venda
            addItemToSaleBtn.addEventListener('click', addItemToSale);
            saleForm.addEventListener('submit', handleSaleFormSubmit);
            cancelSaleBtn.addEventListener('click', () => closeModal(saleModal));
            paymentType.addEventListener('change', (event) => {
                if (event.target.value === 'Parcelado') {
                    installmentDetails.classList.remove('hidden');
                    numInstallments.setAttribute('required', 'true');
                    interestPercentage.setAttribute('required', 'true'); // Juros também se torna obrigatório
                } else {
                    installmentDetails.classList.add('hidden');
                    numInstallments.removeAttribute('required');
                    interestPercentage.removeAttribute('required');
                }
                calculateTotalSaleAmount(); // Recalcula se o total mudar com o tipo de parcela
            });
            numInstallments.addEventListener('input', calculateTotalSaleAmount);
            interestPercentage.addEventListener('input', calculateTotalSaleAmount); // Novo event listener para juros
            // Novo event listener para o campo de pesquisa de produtos na venda, com debounce
            saleProductSearchInput.addEventListener('input', debounce((event) => {
                populateSaleProductSelect(event.target.value);
            }, 300)); // 300ms de atraso

            // Event Listeners do Modal de Confirmação
            cancelConfirmBtn.addEventListener('click', () => closeModal(confirmModal));
        });
    </script>
</body>
</html>

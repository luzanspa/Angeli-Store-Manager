<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angeli - Vendas & Estoque</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"> <!-- Linha adicionada para o favicon -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Adicionado para exportação de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Adicionado para exportação ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #ff69b4;
            --primary-dark: #d13a83;
            --primary-light: #f8f0f4;
            --secondary: #6c757d;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --radius: 10px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --card-bg: #ffffff;
            --bg-color: #f8f0f4;
            --text-color: #333333;
        }

        /* Tema Azul Profissional */
        .theme-blue {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --primary-light: #eaf2f8;
            --bg-color: #f0f7ff;
            --card-bg: #ffffff;
        }

        /* Tema Verde Natureza */
        .theme-green {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --primary-light: #eafaf1;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
        }

        /* Tema Escuro */
        .theme-dark {
            --primary: #9b59b6;
            --primary-dark: #8e44ad;
            --primary-light: #2c3e50;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --secondary: #bdc3c7;
            --light: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 2rem;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .slide-in {
            animation: slideIn 0.4s ease forwards;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.2rem 0.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }

        header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            padding: 0 0.5rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 50px;
            margin: 0.5rem 0.5rem 0;
            font-size: 0.75rem;
        }

        #lastBackup {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 0.8rem;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }

        .card h3 {
            color: var(--primary-dark);
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 0.3rem 0;
        }

        .stat-desc {
            color: var(--secondary);
            font-size: 0.75rem;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Action Buttons */
        .angeli-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            padding: 0.8rem 0.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            background: var(--card-bg);
            color: var(--primary-dark);
            box-shadow: var(--shadow);
            font-size: 0.85rem;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 0.8rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 3px solid transparent;
            font-size: 0.85rem;
            min-width: 80px;
        }

        .tab.active {
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            background: var(--primary-light);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 105, 180, 0.1);
        }

        /* Content Sections */
        .section {
            display: none;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .section-header h2 {
            color: var(--primary-dark);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-filter-bar {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            flex-wrap: wrap;
        }

        .search-filter-bar input,
        .search-filter-bar select {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            flex-grow: 1;
            font-family: 'Inter', sans-serif;
            background: var(--card-bg);
            color: var(--text-color);
            min-width: 120px; /* Adjust as needed */
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            background: var(--card-bg);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .product-image {
            height: 140px;
            background: linear-gradient(135deg, var(--primary-light), #ffddee);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .product-info {
            padding: 0.8rem;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--text-color);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-sku {
            color: var(--secondary);
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .product-price {
            color: var(--success);
        }

        .product-stock {
            color: var(--info);
        }

        .product-stock.low {
            color: var(--danger);
        }

        .product-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.8rem;
            border-top: 1px solid #eee;
            padding-top: 0.8rem;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 0.3rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.8rem;
        }

        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .btn-edit {
            color: var(--info);
        }

        .btn-delete {
            color: var(--danger);
        }

        /* Sales Table */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .sales-table th,
        .sales-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .sales-table th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .sales-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.3em 0.6em;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.75em;
            color: white; /* Cor do texto padrão para os badges */
            text-align: center;
        }

        .status-paid {
            background-color: var(--success); /* Verde para Pago */
        }

        .status-pending {
            background-color: var(--warning); /* Amarelo para Pendente */
            color: var(--dark); /* Texto escuro para melhor contraste no amarelo */
        }

        .status-overdue {
            background-color: var(--danger); /* Vermelho para Atrasado */
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(30px);
            opacity: 0;
            transition: var(--transition);
        }

        /* Modais mais largos no desktop */
        @media (min-width: 768px) {
            #productModal .modal,
            #saleModal .modal {
                max-width: 800px;
            }
        }

        /* Galeria de imagens */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .image-item {
            position: relative;
            border: 2px dashed #ddd;
            border-radius: var(--radius);
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .image-item:hover {
            border-color: var(--primary);
        }
        .image-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        .image-item .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .image-placeholder {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            font-size: 0.8rem;
        }
        .variation-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            padding: 1.2rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .modal-footer {
            padding: 1rem;
            background: var(--primary-light);
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        /* Sale Items */
        .sale-items {
            margin: 1rem 0;
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            background: var(--card-bg);
        }

        .sale-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
        }

        .sale-item:last-child {
            border-bottom: none;
        }

        .sale-item-info {
            flex: 1;
        }

        .sale-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
        }

        /* Charts */
        .chart-container {
            height: 250px;
            margin-top: 1.2rem;
        }

        /* File Input */
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 1.5rem;
            border: 2px dashed #ddd;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-color);
        }

        .file-input-label:hover {
            border-color: var(--primary);
        }

        .file-input-label i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        /* Installment Table */
        .installment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .installment-table th,
        .installment-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .installment-table th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
        }

        .installment-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .tabs {
                flex-direction: row;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 0.6rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-filter-bar {
                width: 100%;
                flex-direction: column; /* Stack filters vertically on small screens */
            }
            .search-filter-bar input,
            .search-filter-bar select {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .product-image {
                height: 120px;
            }
            
            .modal-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .angeli-actions {
                grid-template-columns: 1fr;
            }
            
            .product-card {
                max-width: 100%;
            }
        }

        /* Message Box */
        #messageBox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 300px;
        }

        .message {
            padding: 0.8rem 1.2rem;
            border-radius: var(--radius);
            margin-bottom: 0.8rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transform: translateX(120%);
            opacity: 0;
            transition: var(--transition);
            animation: slideIn 0.5s ease forwards;
            font-size: 0.9rem;
        }

        .message.show {
            transform: translateX(0);
            opacity: 1;
        }

        .message.success {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .message.error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .message.warning {
            background: rgba(255, 193, 7, 0.9);
            color: var(--dark);
        }

        .message.info {
            background: rgba(23, 162, 184, 0.9);
            color: white;
        }

        /* Empty state styles */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        /* Confirmation Modal */
        #confirmationModal .modal {
            max-width: 400px;
            text-align: center;
        }
        #confirmationModal .modal-body {
            padding-bottom: 0.5rem;
        }
        #confirmationModal .modal-body i {
            font-size: 3rem;
            color: var(--warning);
            margin-bottom: 1rem;
        }
        #confirmationModal .modal-body p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }
        #confirmationModal .modal-footer {
            justify-content: center;
            padding-top: 0;
            background: none;
        }

        /* Category Management */
        .category-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: var(--radius);
            margin-top: 1rem;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid #f5f5f5;
        }
        .category-item:last-child {
            border-bottom: none;
        }

        /* Product Variations */
        .variations-container {
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 1rem;
            margin-top: 1rem;
            background: var(--card-bg);
        }
        .color-section {
            border: 1px solid #ddd;
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(0,0,0,0.02);
        }
        .size-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 60px auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border-radius: 5px;
        }
        .variation-summary {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-top: 0.5rem;
        }
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }

        /* Modo Catálogo Moderno */
        .catalog-mode .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .catalog-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }
        .catalog-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        .catalog-image {
            height: 250px;
            background: linear-gradient(135deg, var(--primary-light), #ffddee);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .catalog-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .catalog-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .catalog-info {
            padding: 1.2rem;
        }
        .catalog-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .catalog-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }
        .catalog-actions {
            display: flex;
            gap: 0.5rem;
        }
        .catalog-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.8rem;
        }

        /* Galeria de Fotos */
        .photo-gallery {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .gallery-container {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        .gallery-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            padding: 1rem;
            cursor: pointer;
            border-radius: 50%;
        }
        .gallery-prev { left: -60px; }
        .gallery-next { right: -60px; }
        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        /* Seleção de Variações */
        .variation-selector {
            padding: 1rem;
            border-top: 1px solid #eee;
        }
        .color-options {
            display: flex;
            gap: 0.5rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: var(--transition);
        }
        .color-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.3);
        }
        .size-options {
            display: flex;
            gap: 0.5rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
        }
        .size-option {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
        }
        .size-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .stock-status {
            font-size: 0.8rem;
            margin: 0.5rem 0;
        }
        .stock-available { color: var(--success); }
        .stock-low { color: var(--warning); }
        .stock-out { color: var(--danger); }

        /* Carrinho */
        .cart-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            z-index: 1500;
            overflow-y: auto;
        }
        .cart-sidebar.open {
            right: 0;
        }
        .cart-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-items {
            padding: 1rem;
        }
        .cart-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            object-fit: cover;
        }
        .cart-item-info {
            flex: 1;
        }
        .cart-total {
            padding: 1rem;
            border-top: 2px solid var(--primary);
            background: var(--primary-light);
        }

        /* Toggle de Visualização */
        .view-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 0.3rem;
            margin-bottom: 1rem;
        }
        .view-toggle button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            transition: var(--transition);
        }
        .view-toggle button.active {
            background: var(--primary);
            color: white;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .catalog-mode .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            .gallery-nav {
                display: none;
            }
        }

        /* Help Widget Styles */
        .help-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .help-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .help-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .help-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
        }

        .help-button:hover .help-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .help-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .help-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .help-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .help-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .help-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .help-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.3s ease;
        }

        .help-tab.active {
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary);
            background: var(--primary-light);
        }

        .help-tab-content {
            padding: 20px;
            display: none;
        }

        .help-tab-content.active {
            display: block;
        }

        .help-tip {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .help-tip-icon {
            color: var(--primary-dark);
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .help-card {
            background: var(--card-bg);
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .help-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .help-card h4 {
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .manual-nav {
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #eee;
            width: 250px;
            overflow-y: auto;
        }

        .manual-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .manual-layout {
            display: flex;
            height: 100%;
        }

        .nav-item {
            display: block;
            padding: 8px 12px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .manual-section {
            display: none;
        }

        .manual-section.active {
            display: block;
        }

        @media (max-width: 768px) {
            .help-widget {
                bottom: 80px;
            }
            
            .manual-layout {
                flex-direction: column;
            }
            
            .manual-nav {
                width: 100%;
                max-height: 150px;
            }
        }

        /* Sale Details Modal specific styles */
        #saleDetailsModal .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #saleDetailsModal .sale-overview,
        #saleDetailsModal .sale-items-detail,
        #saleDetailsModal .sale-installments-detail {
            border: 1px solid #eee;
            border-radius: var(--radius);
            padding: 1rem;
            background: var(--card-bg);
        }
        #saleDetailsModal .sale-overview h4,
        #saleDetailsModal .sale-items-detail h4,
        #saleDetailsModal .sale-installments-detail h4 {
            color: var(--primary-dark);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        #saleDetailsModal .sale-items-detail ul,
        #saleDetailsModal .sale-installments-detail ul {
            list-style: none;
            padding: 0;
        }
        #saleDetailsModal .sale-items-detail li,
        #saleDetailsModal .sale-installments-detail li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #saleDetailsModal .sale-items-detail li:last-child,
        #saleDetailsModal .sale-installments-detail li:last-child {
            border-bottom: none;
        }
        #saleDetailsModal .sale-items-detail .item-price {
            font-weight: 600;
        }
        #saleDetailsModal .sale-installments-detail .installment-status {
            font-weight: 500;
        }
    </style>
</head>
<body class="theme-pink">
    <!-- Header -->
    <header>
        <h1><i class="fas fa-boxes"></i> Angeli - Vendas & Estoque</h1>
        <div class="status-bar">
            <div id="lastBackup"><i class="fas fa-cloud"></i> Último backup: <span id="backupTime">N/A</span></div>
            <div id="storageStatus"><i class="fas fa-database"></i> <span id="storageUsage">0MB</span> / 5MB usado</div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard -->
        <div class="dashboard fade-in">
            <div class="card">
                <h3><i class="fas fa-box-open"></i> Total de Produtos</h3>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-desc"><span class="trend-up" id="productsTrend">+0%</span> no último mês</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-shopping-cart"></i> Vendas do Mês</h3>
                <div class="stat-value" id="monthSales">R$ 0,00</div>
                <div class="stat-desc"><span class="trend-up" id="salesTrend">+0%</span> em relação ao mês passado</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-exclamation-triangle"></i> Produtos com Baixo Estoque</h3>
                <div class="stat-value" id="lowStock">0</div>
                <div class="stat-desc">Reabastecimento necessário</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-file-invoice-dollar"></i> Receita Pendente</h3>
                <div class="stat-value" id="pendingRevenue">R$ 0,00</div>
                <div class="stat-desc">Vendas parceladas em aberto</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="angeli-actions">
            <button class="btn btn-primary fade-in" onclick="openProductModal()">
                <i class="fas fa-plus-circle"></i> Adicionar Produto
            </button>
            <button class="btn btn-success fade-in" onclick="openSaleModal()">
                <i class="fas fa-cash-register"></i> Registrar Venda
            </button>
            <!-- O botão de backup foi movido para a seção de Configurações -->
            <button class="btn btn-warning fade-in" onclick="generateReport()">
                <i class="fas fa-chart-bar"></i> Relatório
            </button>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" data-target="productsSection">Produtos</div>
            <div class="tab" data-target="salesSection">Vendas</div>
            <div class="tab" data-target="reportsSection">Relatórios</div>
            <div class="tab" data-target="settingsSection">Configurações</div>
        </div>

        <!-- Products Section -->
        <section id="productsSection" class="section active">
            <div class="section-header">
                <h2><i class="fas fa-boxes"></i> Seus Produtos</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="view-toggle">
                        <button id="listViewBtn" class="active" onclick="toggleView('list')"><i class="fas fa-list"></i> Lista</button>
                        <button id="catalogViewBtn" onclick="toggleView('catalog')"><i class="fas fa-th-large"></i> Catálogo</button>
                    </div>
                    <button class="btn btn-info" onclick="toggleCart()" id="cartToggle">
                        <i class="fas fa-shopping-cart"></i> Carrinho (<span id="cartCount">0</span>)
                    </button>
                </div>
            </div>
            
            <div class="search-filter-bar">
                <input type="text" id="productSearch" class="form-control" placeholder="Pesquisar produtos..." oninput="filterProducts()">
                <select id="productCategoryFilter" class="form-control" onchange="filterProducts()">
                    <option value="">Todas as Categorias</option>
                </select>
                <select id="productStockFilter" class="form-control" onchange="filterProducts()">
                    <option value="">Todo Estoque</option>
                    <option value="low">Baixo Estoque</option>
                </select>
            </div>

            <div class="products-grid" id="productsList">
                <!-- Products will be loaded dynamically -->
            </div>
            <div class="empty-state" id="productsEmptyState" style="display: none;">
                <i class="fas fa-box-open"></i>
                <p>Nenhum produto cadastrado ainda.</p>
                <button class="btn btn-primary" onclick="openProductModal()">Adicionar Primeiro Produto</button>
            </div>
        </section>

        <!-- Sales Section -->
        <section id="salesSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Histórico de Vendas</h2>
                <div class="search-filter-bar">
                    <input type="text" id="saleSearch" class="form-control" placeholder="Pesquisar vendas..." oninput="filterSales()">
                    <input type="date" id="saleDateFilterStart" class="form-control" onchange="filterSales()">
                    <input type="date" id="saleDateFilterEnd" class="form-control" onchange="filterSales()">
                    <select id="saleStatusFilter" class="form-control" onchange="filterSales()">
                        <option value="">Todos os Status</option>
                        <option value="paid">Pago</option>
                        <option value="pending">Pendente</option>
                        <option value="overdue">Atrasado</option>
                    </select>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1rem;">
                <h3>Histórico do Cliente</h3>
                <div class="form-group">
                    <input type="text" id="customerHistorySearch" class="form-control" placeholder="Digite o nome do cliente..." oninput="searchCustomerHistory()">
                </div>
                <div id="customerHistoryResults" style="display: none;"></div>
            </div>
            
            <div class="card">
                <h3>Últimas Vendas</h3>
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- Sales will be loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="empty-state" id="salesEmptyState" style="display: none;">
                        <i class="fas fa-cash-register"></i>
                        <p>Nenhuma venda registrada ainda.</p>
                        <button class="btn btn-success" onclick="openSaleModal()">Registrar Primeira Venda</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reportsSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Relatórios e Análises</h2>
                <div>
                    <button class="btn btn-primary" onclick="exportPDF()" id="exportPdfBtn">
                        <i class="fas fa-file-export"></i> Exportar PDF
                    </button>

                    <!-- Novo botão para exportar para Excel -->
                    <button class="btn btn-success" onclick="exportAllToExcel()" id="exportExcelBtn" style="margin-left: 0.5rem;">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button class="btn btn-warning" onclick="generateCatalogPDF()" style="margin-left: 0.5rem;">
                        <i class="fas fa-book"></i> Catálogo PDF
                    </button>

                </div>
            </div>

            <div class="card">
                <h3>Desempenho de Vendas - Últimos 6 Meses</h3>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem;">
                <div class="card">
                    <h3>Produtos Mais Vendidos</h3>
                    <div class="chart-container">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Vendas por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Novo Relatório de Movimentação de Estoque -->
            <div class="card" style="margin-top: 1.5rem;">
                <h3><i class="fas fa-exchange-alt"></i> Relatório de Movimentação de Estoque</h3>
                <div class="search-filter-bar" style="margin-bottom: 1rem;">
                    <input type="date" id="stockMoveDateFilterStart" class="form-control" onchange="filterStockMovements()">
                    <input type="date" id="stockMoveDateFilterEnd" class="form-control" onchange="filterStockMovements()">
                    <input type="text" id="stockMoveProductSearch" class="form-control" placeholder="Pesquisar produto..." oninput="filterStockMovements()">
                    <select id="stockMoveTypeFilter" class="form-control" onchange="filterStockMovements()">
                        <option value="">Todos os Tipos</option>
                        <option value="Venda">Venda</option>
                        <option value="Entrada">Entrada</option>
                        <option value="Devolução">Devolução</option>
                        <option value="Ajuste">Ajuste</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Valor Unitário</th>
                                <th>Valor Total</th>
                                <th>Estoque Final</th>
                                <th>Cliente/Obs</th>
                            </tr>
                        </thead>
                        <tbody id="stockMovementsTableBody">
                            <!-- Movimentações de estoque serão carregadas dinamicamente -->
                        </tbody>
                    </table>
                    <div class="empty-state" id="stockMovementsEmptyState" style="display: none;">
                        <i class="fas fa-box-open"></i>
                        <p>Nenhuma movimentação de estoque encontrada.</p>
                    </div>
                </div>
            </div>

            <!-- Novo Relatório Financeiro Completo -->
            <div class="card" style="margin-top: 1.5rem;">
                <h3><i class="fas fa-dollar-sign"></i> Relatório Financeiro Completo</h3>
                <div class="search-filter-bar" style="margin-bottom: 1rem;">
                    <input type="date" id="financeReportDateFilterStart" class="form-control" onchange="filterFinancialReport()">
                    <input type="date" id="financeReportDateFilterEnd" class="form-control" onchange="filterFinancialReport()">
                    <select id="financeReportStatusFilter" class="form-control" onchange="filterFinancialReport()">
                        <option value="">Todos os Status</option>
                        <option value="paid">Pago</option>
                        <option value="pending">Pendente</option>
                        <option value="overdue">Atrasado</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="sales-table">
                        <thead>
                            <tr>
                                <th>Data Venda</th>
                                <th>Cliente</th>
                                <th>Produtos Vendidos</th>
                                <th>Forma Pagamento</th>
                                <th>Valor Total Venda</th>
                                <th>Parcelado?</th>
                                <th>Qtd Parcelas</th>
                                <th>Valor Parcela</th>
                                <th>Juros Aplicados</th>
                                <th>Valor Já Recebido</th>
                                <th>Valor Pendente</th>
                                <th>Status Venda</th>
                            </tr>
                        </thead>
                        <tbody id="financialReportTableBody">
                            <!-- Dados financeiros serão carregados dinamicamente -->
                        </tbody>
                    </table>
                    <div class="empty-state" id="financialReportEmptyState" style="display: none;">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <p>Nenhum dado financeiro encontrado.</p>
                    </div>
                </div>
            </div>

        </section>

        <!-- Settings Section -->
        <section id="settingsSection" class="section">
            <div class="section-header">
                <h2><i class="fas fa-cog"></i> Configurações</h2>
            </div>

            <div class="card">
                <h3>Aparência</h3>
                <div class="form-group">
                    <label for="appTheme">Tema do Aplicativo</label>
                    <select id="appTheme" class="form-control" onchange="changeTheme(this.value)">
                        <option value="pink">Rosa (Padrão)</option>
                        <option value="blue">Azul Profissional</option>
                        <option value="green">Verde Natureza</option>
                        <option value="dark">Escuro</option>
                    </select>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h3>Backup de Dados</h3>
                <div class="form-group">
                    <label for="autoBackupToggle" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()" style="width: auto;">
                        Backup Automático Local (Download)
                    </label>
                    <small style="color: var(--secondary);">Um arquivo de backup será baixado automaticamente no seu dispositivo a cada alteração de dados.</small>
                </div>
                <button class="btn btn-primary" onclick="exportAllData('angeli_manual_backup')">
                    <i class="fas fa-download"></i> Fazer Backup Manual (JSON)
                </button>
                <button class="btn btn-success" onclick="exportBackupZip()" style="margin-left: 0.5rem;">
                    <i class="fas fa-file-archive"></i> Backup Completo (ZIP)
                </button>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="importFileInput">Importar Dados (JSON ou ZIP)</label>
                    <div class="file-input-container">
                        <input type="file" id="importFileInput" accept=".json,.zip" onchange="handleImportFile(event)">
                        <label class="file-input-label" for="importFileInput">
                            <i class="fas fa-upload"></i>
                            <p>Clique para selecionar arquivo JSON ou ZIP</p>
                            <p class="text-sm" style="margin-top: 0.5rem; color: var(--secondary);">ZIP: backup completo com fotos. JSON: apenas dados.</p>
                        </label>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h3>Notificações</h3>
                <div class="form-group">
                    <label for="stockAlerts" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="stockAlerts" onchange="saveAppSetting('stockAlerts', this.checked)" style="width: auto;">
                        Alertas de Baixo Estoque
                    </label>
                </div>
                <div class="form-group">
                    <label for="paymentReminders" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="paymentReminders" onchange="saveAppSetting('paymentReminders', this.checked)" style="width: auto;">
                        Lembretes de Pagamento
                    </label>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h3>Gerenciar Categorias</h3>
                <div class="form-group">
                    <label for="newCategoryName">Nova Categoria</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="newCategoryName" class="form-control" placeholder="Nome da categoria">
                        <button class="btn btn-primary" onclick="addCategory()"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                </div>
                <div class="category-list" id="categoryList">
                    <!-- Categorias serão carregadas aqui -->
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <h3>Informações da Loja</h3>
                <div class="form-group">
                    <label for="storeName">Nome da Loja</label>
                    <input type="text" id="storeName" class="form-control" placeholder="Ex: Minha Loja" onchange="saveStoreInfo()">
                </div>
                <div class="form-group">
                    <label for="storePhone">Telefone</label>
                    <input type="text" id="storePhone" class="form-control" placeholder="Ex: (11) 99999-9999" onchange="saveStoreInfo()">
                </div>
                <div class="form-group">
                    <label for="storeInstagram">Instagram</label>
                    <input type="text" id="storeInstagram" class="form-control" placeholder="Ex: @minhaloja" onchange="saveStoreInfo()">
                </div>
                <div class="form-group">
                    <label for="storeFacebook">Facebook</label>
                    <input type="text" id="storeFacebook" class="form-control" placeholder="Ex: @minhaloja" onchange="saveStoreInfo()">
                </div>
                <div class="form-group">
                    <label for="storeWebsite">Site/E-mail</label>
                    <input type="text" id="storeWebsite" class="form-control" placeholder="Ex: www.minhaloja.com" onchange="saveStoreInfo()">
                </div>
            </div>
            
            <div class="card" style="margin-top: 1.5rem;">
                <h3>Outras Configurações</h3>
                <div class="form-group">
                    <label for="showHelpWidget" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="showHelpWidget" onchange="toggleHelpWidget(this.checked)" style="width: auto;" checked>
                        Exibir Botão de Ajuda
                    </label>
                </div>
                <div class="form-group">
                    <label for="updates" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="updates" onchange="saveAppSetting('updates', this.checked)" style="width: auto;">
                        Receber Atualizações do App
                    </label>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="productModalTitle"><i class="fas fa-plus-circle"></i> Adicionar Novo Produto</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="productName">Nome do Produto</label>
                    <input type="text" id="productName" class="form-control" placeholder="Ex: Camiseta Básica Branca">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productSku">SKU (Código do Produto)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="productSku" class="form-control" placeholder="Ex: CAM-BRA-001">
                            <button type="button" class="btn btn-info btn-sm" onclick="generateProductSku()" title="Gerar SKU automaticamente">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Categoria</label>
                        <select id="productCategory" class="form-control">
                            <option value="">Selecione uma categoria</option>
                            <option>Vestuário</option>
                            <option>Eletrônicos</option>
                            <option>Acessórios</option>
                            <option>Livros</option>
                            <option>Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Preço (R$)</label>
                        <input type="number" id="productPrice" class="form-control" placeholder="0,00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Quantidade em Estoque</label>
                        <input type="number" id="productStock" class="form-control" placeholder="0" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Descrição do Produto</label>
                    <textarea id="productDescription" class="form-control" rows="3" placeholder="Descrição detalhada do produto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hasVariations" onchange="toggleVariations()" style="width: auto; margin-right: 0.5rem;">
                        Este produto possui variações (cor e tamanho)
                    </label>
                </div>
                
                <div id="variationsSection" class="variations-container" style="display: none;">
                    <h4>Variações do Produto</h4>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addColorVariation()"><i class="fas fa-plus"></i> Adicionar Cor</button>
                    <div id="colorVariations"></div>
                    <div class="variation-summary" id="variationSummary"></div>
                </div>
                
                <div class="form-group">
                    <label>Imagens do Produto (até 3)</label>
                    <div class="image-gallery" id="productImageGallery">
                        <div class="image-item" onclick="selectProductImage(0)">
                            <div class="image-placeholder">
                                <i class="fas fa-plus"></i><br>Adicionar
                            </div>
                        </div>
                        <div class="image-item" onclick="selectProductImage(1)" style="display: none;">
                            <div class="image-placeholder">
                                <i class="fas fa-plus"></i><br>Adicionar
                            </div>
                        </div>
                        <div class="image-item" onclick="selectProductImage(2)" style="display: none;">
                            <div class="image-placeholder">
                                <i class="fas fa-plus"></i><br>Adicionar
                            </div>
                        </div>
                    </div>
                    <input type="file" id="productImageInput" accept="image/*" style="display: none;" onchange="handleProductImageUpload(event)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">Salvar Produto</button>
            </div>
        </div>
    </div>

    <!-- Sale Modal -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="saleModalTitle"><i class="fas fa-cash-register"></i> Registrar Nova Venda</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="saleCustomer">Cliente</label>
                    <input type="text" id="saleCustomer" class="form-control" placeholder="Nome do cliente">
                </div>
                
                <div class="form-group">
                    <label for="productSearch">Pesquisar Produto</label>
                    <input type="text" id="productSearchInput" class="form-control" placeholder="Digite para pesquisar produtos..." oninput="filterProductDropdown()">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="saleProduct">Produto</label>
                        <select id="saleProduct" class="form-control" onchange="loadProductVariations()">
                            <option value="">Selecione um produto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="saleQuantity">Quantidade</label>
                        <input type="number" id="saleQuantity" class="form-control" value="1" min="1">
                    </div>
                </div>
                
                <div id="variationSelection" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="saleVariation">Variação</label>
                            <select id="saleVariation" class="form-control">
                                <option value="">Selecione uma variação</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="addSaleItem()"><i class="fas fa-plus"></i> Adicionar Item</button>
                
                <div class="sale-items" id="saleItemsContainer">
                    <h4>Itens da Venda</h4>
                    <div id="saleItemsList"></div>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Forma de Pagamento</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">À Vista</option>
                        <option value="credit">Crédito</option>
                        <option value="installment">Parcelado</option>
                    </select>
                </div>
                
                <div id="installmentFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="installmentCount">Número de Parcelas</label>
                            <input type="number" id="installmentCount" class="form-control" value="2" min="2" max="12">
                        </div>
                        <div class="form-group">
                            <label for="installmentInterest">Juros (%)</label>
                            <input type="number" id="installmentInterest" class="form-control" value="0" min="0" max="20" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Total da Venda</label>
                            <div class="stat-value">R$ <span id="saleTotal">0.00</span></div>
                        </div>
                        <div class="form-group">
                            <label>Valor por Parcela</label>
                            <div class="stat-value">R$ <span id="installmentValue">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-success" id="finalizeSaleBtn" onclick="finalizeSale()"><i class="fas fa-check"></i> Finalizar Venda</button>
            </div>
        </div>
    </div>

    <!-- Sale Details Modal (substitui Installment Modal) -->
    <div class="modal-overlay" id="saleDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="saleDetailsModalTitle"><i class="fas fa-file-invoice-dollar"></i> Detalhes da Venda</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="sale-overview">
                    <h4>Resumo da Venda</h4>
                    <div id="saleOverviewDetails"></div>
                </div>
                
                <div class="sale-items-detail">
                    <h4>Itens da Venda</h4>
                    <ul id="saleItemsDetailList">
                        <!-- Itens da venda serão carregados aqui -->
                    </ul>
                </div>

                <div class="sale-installments-detail" id="saleInstallmentsDetailSection" style="display: none;">
                    <h4>Parcelas</h4>
                    <table class="installment-table">
                        <thead>
                            <tr>
                                <th>Parcela</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="installmentList">
                            <!-- Parcelas serão carregadas aqui -->
                        </tbody>
                    </table>
                </div>
                
                <div class="sale-installments-detail" id="paymentHistorySection" style="display: none;">
                    <h4>Histórico de Pagamentos</h4>
                    <div id="paymentHistory" style="margin-top: 1rem;">
                        <!-- Histórico será carregado aqui -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal (Mantido, mas as funções foram movidas para Configurações) -->
    <div class="modal-overlay" id="backupModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> Backup em Nuvem (Simulado)</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="backupService">Serviço de Nuvem</label>
                    <select id="backupService" class="form-control">
                        <option>Google Drive</option>
                        <option selected>Dropbox</option>
                        <option>OneDrive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="backupFreq">Frequência de Backup</label>
                    <select id="backupFreq" class="form-control">
                        <option>Diariamente</option>
                        <option selected>Semanalmente</option>
                        <option>Mensalmente</option>
                    </select>
                </div>
                
                <div class="card">
                    <h3>Últimos Backups (Simulados)</h3>
                    <ul id="backupHistory" style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        <li>Nenhum backup registrado ainda.</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Fechar</button>
                <button class="btn btn-primary" onclick="performBackup()"><i class="fas fa-cloud-upload-alt"></i> Fazer Backup Agora (Simulado)</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Confirmação</h3>
                <button class="close-modal" aria-label="Fechar Modal">&times;</button>
            </div>
            <div class="modal-body">
                <i class="fas fa-question-circle"></i>
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" aria-live="polite"></div>

    <!-- Help Widget -->
    <div class="help-widget" id="helpWidget">
        <button class="help-button" onclick="toggleHelpModal()" title="Ajuda">
            <i class="fas fa-question"></i>
            <div class="help-tooltip">Precisa de ajuda?</div>
        </button>
    </div>

    <!-- Help Modal -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <div class="help-header">
                <h3><i class="fas fa-life-ring"></i> Central de Ajuda - Angeli</h3>
                <button class="help-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="help-body">
                <div class="help-tabs">
                    <button class="help-tab active" onclick="switchHelpTab('tips')">Dicas Rápidas</button>
                    <button class="help-tab" onclick="switchHelpTab('manual')">Manual Completo</button>
                </div>
                
                <!-- Quick Tips Tab -->
                <div class="help-tab-content active" id="helpTips">
                    <div class="help-section">
                        <h3><i class="fas fa-lightbulb"></i> Dicas Essenciais</h3>
                        
                        <div class="help-tip">
                            <i class="fas fa-keyboard help-tip-icon"></i>
                            <strong>Atalhos Úteis:</strong> Use Tab para navegar entre campos, Enter para confirmar ações e Esc para fechar modais.
                        </div>
                        
                        <div class="help-grid">
                            <div class="help-card">
                                <h4><i class="fas fa-plus-circle"></i> Produtos</h4>
                                <p>• SKU é gerado automaticamente se deixar vazio<br>
                                • Use variações para produtos com cores/tamanhos<br>
                                • Máximo 3 imagens por produto</p>
                            </div>
                            
                            <div class="help-card">
                                <h4><i class="fas fa-shopping-cart"></i> Vendas</h4>
                                <p>• Pesquise produtos digitando no campo<br>
                                • Vendas parceladas geram controle automático<br>
                                • Estoque é atualizado automaticamente</p>
                            </div>
                            
                            <div class="help-card">
                                <h4><i class="fas fa-chart-bar"></i> Relatórios</h4>
                                <p>• Exporte para Excel ou PDF<br>
                                • Use filtros para análises específicas<br>
                                • Gráficos são atualizados em tempo real</p>
                            </div>
                            
                            <div class="help-card">
                                <h4><i class="fas fa-cloud-download-alt"></i> Backup</h4>
                                <p>• Ative backup automático nas configurações<br>
                                • Backup ZIP inclui todas as imagens<br>
                                • Importe dados de outros sistemas</p>
                            </div>
                        </div>
                        
                        <div class="help-tip">
                            <i class="fas fa-mobile-alt help-tip-icon"></i>
                            <strong>Mobile:</strong> O sistema é totalmente responsivo. Use o modo catálogo para melhor visualização em celulares.
                        </div>
                        
                        <div class="help-tip">
                            <i class="fas fa-whatsapp help-tip-icon"></i>
                            <strong>WhatsApp:</strong> Compartilhe produtos e carrinho diretamente pelo WhatsApp com um clique.
                        </div>
                    </div>
                </div>
                
                <!-- Manual Tab -->
                <div class="help-tab-content" id="helpManual">
                    <div class="manual-layout">
                        <nav class="manual-nav">
                            <h4 style="margin-bottom: 15px; color: var(--primary-dark);">Índice</h4>
                            <a href="#" class="nav-item active" onclick="showManualSection('intro')">1. Introdução</a>
                            <a href="#" class="nav-item" onclick="showManualSection('dashboard')">2. Dashboard</a>
                            <a href="#" class="nav-item" onclick="showManualSection('products')">3. Gestão de Produtos</a>
                            <a href="#" class="nav-item" onclick="showManualSection('sales')">4. Sistema de Vendas</a>
                            <a href="#" class="nav-item" onclick="showManualSection('reports')">5. Relatórios</a>
                            <a href="#" class="nav-item" onclick="showManualSection('settings')">6. Configurações</a>
                            <a href="#" class="nav-item" onclick="showManualSection('tips')">7. Dicas Avançadas</a>
                        </nav>
                        
                        <div class="manual-content">
                            <div class="manual-section active" id="manualIntro">
                                <h2>1. Introdução ao Sistema Angeli</h2>
                                <p><strong>Última atualização:</strong> <span id="manualDate"></span></p>
                                
                                <h3>Bem-vindo ao Angeli!</h3>
                                <p>O Angeli é um sistema completo de gestão de vendas e estoque, desenvolvido especialmente para pequenos e médios negócios. Com interface moderna e intuitiva, oferece todas as ferramentas necessárias para gerenciar seu negócio de forma eficiente.</p>
                                
                                <h3>Principais Recursos:</h3>
                                <ul>
                                    <li><strong>Gestão de Produtos:</strong> Cadastro completo com imagens, variações e controle de estoque</li>
                                    <li><strong>Sistema de Vendas:</strong> Registro de vendas com múltiplas formas de pagamento</li>
                                    <li><strong>Relatórios Avançados:</strong> Análises detalhadas com gráficos e exportação</li>
                                    <li><strong>Backup Automático:</strong> Seus dados sempre seguros</li>
                                    <li><strong>Integração WhatsApp:</strong> Compartilhe produtos facilmente</li>
                                </ul>
                                
                                <div class="help-tip">
                                    <i class="fas fa-info-circle help-tip-icon"></i>
                                    <strong>Dica:</strong> Este sistema funciona 100% offline no seu navegador. Seus dados ficam salvos localmente no seu dispositivo.
                                </div>
                            </div>
                            
                            <div class="manual-section" id="manualDashboard">
                                <h2>2. Dashboard - Visão Geral</h2>
                                
                                <h3>Cartões de Estatísticas</h3>
                                <p>O dashboard apresenta 4 cartões principais com informações em tempo real:</p>
                                
                                <div class="help-grid">
                                    <div class="help-card">
                                        <h4><i class="fas fa-box-open"></i> Total de Produtos</h4>
                                        <p>Mostra a quantidade total de produtos cadastrados e a tendência de crescimento.</p>
                                    </div>
                                    
                                    <div class="help-card">
                                        <h4><i class="fas fa-shopping-cart"></i> Vendas do Mês</h4>
                                        <p>Valor total das vendas do mês atual comparado ao mês anterior.</p>
                                    </div>
                                    
                                    <div class="help-card">
                                        <h4><i class="fas fa-exclamation-triangle"></i> Baixo Estoque</h4>
                                        <p>Produtos com estoque abaixo de 5 unidades que precisam de reposição.</p>
                                    </div>
                                    
                                    <div class="help-card">
                                        <h4><i class="fas fa-file-invoice-dollar"></i> Receita Pendente</h4>
                                        <p>Valor total das vendas parceladas ainda não recebidas.</p>
                                    </div>
                                </div>
                                
                                <h3>Botões de Ação Rápida</h3>
                                <p>Logo abaixo do dashboard, você encontra os botões para as ações mais comuns:</p>
                                <ul>
                                    <li><strong>Adicionar Produto:</strong> Cadastra um novo produto</li>
                                    <li><strong>Registrar Venda:</strong> Inicia uma nova venda</li>
                                    <li><strong>Relatório:</strong> Gera relatórios em PDF</li>
                                </ul>
                            </div>
                            
                            <div class="manual-section" id="manualProducts">
                                <h2>3. Gestão de Produtos</h2>
                                
                                <h3>Cadastrando um Produto</h3>
                                <p>Para cadastrar um novo produto, clique em "Adicionar Produto" e preencha:</p>
                                
                                <ul>
                                    <li><strong>Nome:</strong> Nome descritivo do produto</li>
                                    <li><strong>SKU:</strong> Código único (gerado automaticamente se vazio)</li>
                                    <li><strong>Categoria:</strong> Classificação do produto</li>
                                    <li><strong>Preço:</strong> Valor de venda</li>
                                    <li><strong>Estoque:</strong> Quantidade disponível</li>
                                    <li><strong>Descrição:</strong> Detalhes do produto</li>
                                </ul>
                                
                                <h3>Produtos com Variações</h3>
                                <p>Para produtos com diferentes cores e tamanhos:</p>
                                <ol>
                                    <li>Marque "Este produto possui variações"</li>
                                    <li>Adicione as cores disponíveis</li>
                                    <li>Para cada cor, adicione os tamanhos</li>
                                    <li>Defina estoque e preço para cada variação</li>
                                </ol>
                                
                                <div class="help-tip">
                                    <i class="fas fa-camera help-tip-icon"></i>
                                    <strong>Imagens:</strong> Adicione até 3 imagens por produto. Imagens de variações são exibidas na galeria.
                                </div>
                                
                                <h3>Filtros e Busca</h3>
                                <p>Use os filtros para encontrar produtos rapidamente:</p>
                                <ul>
                                    <li><strong>Busca:</strong> Pesquise por nome, SKU ou categoria</li>
                                    <li><strong>Categoria:</strong> Filtre por categoria específica</li>
                                    <li><strong>Estoque:</strong> Veja apenas produtos com baixo estoque</li>
                                </ul>
                            </div>
                            
                            <div class="manual-section" id="manualSales">
                                <h2>4. Sistema de Vendas</h2>
                                
                                <h3>Registrando uma Venda</h3>
                                <p>Para registrar uma nova venda:</p>
                                <ol>
                                    <li>Clique em "Registrar Venda"</li>
                                    <li>Informe o nome do cliente</li>
                                    <li>Pesquise e selecione produtos</li>
                                    <li>Defina quantidades</li>
                                    <li>Escolha a forma de pagamento</li>
                                    <li>Finalize a venda</li>
                                </ol>
                                
                                <h3>Formas de Pagamento</h3>
                                <ul>
                                    <li><strong>À Vista:</strong> Pagamento imediato, venda marcada como "Paga"</li>
                                    <li><strong>Crédito:</strong> Pagamento no cartão, venda marcada como "Paga"</li>
                                    <li><strong>Parcelado:</strong> Cria parcelas com controle de vencimento</li>
                                </ul>
                                
                                <h3>Vendas Parceladas</h3>
                                <p>Para vendas parceladas, o sistema:</p>
                                <ul>
                                    <li>Calcula automaticamente o valor das parcelas</li>
                                    <li>Aplica juros se definido</li>
                                    <li>Gera cronograma de vencimentos</li>
                                    <li>Permite marcar parcelas como pagas</li>
                                </ul>
                                
                                <div class="help-tip">
                                    <i class="fas fa-edit help-tip-icon"></i>
                                    <strong>Edição:</strong> Vendas podem ser editadas clicando no ícone de edição. O estoque é ajustado automaticamente.
                                </div>
                            </div>
                            
                            <div class="manual-section" id="manualReports">
                                <h2>5. Relatórios e Análises</h2>
                                
                                <h3>Gráficos do Dashboard</h3>
                                <p>A seção de relatórios apresenta gráficos interativos:</p>
                                <ul>
                                    <li><strong>Vendas dos Últimos 6 Meses:</strong> Evolução das vendas</li>
                                    <li><strong>Produtos Mais Vendidos:</strong> Top 5 produtos</li>
                                    <li><strong>Vendas por Categoria:</strong> Distribuição por categoria</li>
                                </ul>
                                
                                <h3>Relatório de Movimentação de Estoque</h3>
                                <p>Acompanhe todas as movimentações:</p>
                                <ul>
                                    <li>Vendas realizadas</li>
                                    <li>Entradas de estoque</li>
                                    <li>Ajustes e devoluções</li>
                                </ul>
                                
                                <h3>Relatório Financeiro</h3>
                                <p>Análise completa das finanças:</p>
                                <ul>
                                    <li>Vendas por período</li>
                                    <li>Valores recebidos e pendentes</li>
                                    <li>Status de parcelas</li>
                                </ul>
                                
                                <h3>Exportação</h3>
                                <p>Exporte relatórios em diferentes formatos:</p>
                                <ul>
                                    <li><strong>PDF:</strong> Relatório visual com gráficos</li>
                                    <li><strong>Excel:</strong> Dados detalhados em planilhas</li>
                                    <li><strong>Catálogo PDF:</strong> Catálogo de produtos com imagens</li>
                                </ul>
                            </div>
                            
                            <div class="manual-section" id="manualSettings">
                                <h2>6. Configurações</h2>
                                
                                <h3>Aparência</h3>
                                <p>Personalize a interface escolhendo entre 4 temas:</p>
                                <ul>
                                    <li>Rosa (Padrão)</li>
                                    <li>Azul Profissional</li>
                                    <li>Verde Natureza</li>
                                    <li>Escuro</li>
                                </ul>
                                
                                <h3>Backup de Dados</h3>
                                <p>Mantenha seus dados seguros:</p>
                                <ul>
                                    <li><strong>Backup Automático:</strong> Download automático a cada alteração</li>
                                    <li><strong>Backup Manual JSON:</strong> Apenas dados do sistema</li>
                                    <li><strong>Backup ZIP:</strong> Dados + todas as imagens</li>
                                </ul>
                                
                                <h3>Gerenciar Categorias</h3>
                                <p>Adicione, edite ou remova categorias de produtos. Produtos existentes são atualizados automaticamente.</p>
                                
                                <h3>Informações da Loja</h3>
                                <p>Configure os dados da sua loja para aparecer nos relatórios:</p>
                                <ul>
                                    <li>Nome da loja</li>
                                    <li>Telefone</li>
                                    <li>Redes sociais</li>
                                    <li>Site/E-mail</li>
                                </ul>
                            </div>
                            
                            <div class="manual-section" id="manualTips">
                                <h2>7. Dicas Avançadas</h2>
                                
                                <h3>Otimização de Performance</h3>
                                <ul>
                                    <li>Mantenha o navegador atualizado</li>
                                    <li>Faça backup regular dos dados</li>
                                    <li>Otimize imagens antes de fazer upload (máx. 5MB)</li>
                                    <li>Use SKUs padronizados para melhor organização</li>
                                </ul>
                                
                                <h3>Integração WhatsApp</h3>
                                <p>Maximize as vendas usando o WhatsApp:</p>
                                <ul>
                                    <li>Compartilhe produtos individuais com imagens</li>
                                    <li>Envie carrinho completo para clientes</li>
                                    <li>Use o modo catálogo para apresentações</li>
                                </ul>
                                
                                <h3>Gestão de Estoque</h3>
                                <ul>
                                    <li>Configure alertas de baixo estoque</li>
                                    <li>Use o relatório de giro de estoque</li>
                                    <li>Monitore produtos críticos regularmente</li>
                                </ul>
                                
                                <h3>Análise de Vendas</h3>
                                <ul>
                                    <li>Acompanhe tendências nos gráficos</li>
                                    <li>Identifique produtos mais rentáveis</li>
                                    <li>Analise sazonalidade das vendas</li>
                                    <li>Use filtros para análises específicas</li>
                                </ul>
                                
                                <div class="help-tip">
                                    <i class="fas fa-star help-tip-icon"></i>
                                    <strong>Dica Pro:</strong> Use as teclas de atalho para navegar mais rapidamente: Tab (próximo campo), Enter (confirmar), Esc (fechar modal).
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Carrinho Lateral -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Carrinho</h3>
            <button onclick="toggleCart()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <p style="text-align: center; color: var(--secondary); padding: 2rem;">Carrinho vazio</p>
        </div>
        <div class="cart-total" id="cartTotal" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <strong>Total: R$ <span id="cartTotalValue">0,00</span></strong>
            </div>
            <button class="btn btn-success" style="width: 100%;" onclick="finalizePurchase()">
                <i class="fas fa-check"></i> Finalizar Compra
            </button>
            <button class="btn btn-info" style="width: 100%; margin-top: 0.5rem;" onclick="shareCartWhatsApp()">
                <i class="fab fa-whatsapp"></i> Enviar no WhatsApp
            </button>
        </div>
    </div>

    <!-- Galeria de Fotos -->
    <div class="photo-gallery" id="photoGallery">
        <div class="gallery-container">
            <img class="gallery-image" id="galleryImage" src="" alt="">
            <button class="gallery-nav gallery-prev" onclick="navigateGallery(-1)">&lt;</button>
            <button class="gallery-nav gallery-next" onclick="navigateGallery(1)">&gt;</button>
        </div>
        <button class="gallery-close" onclick="closeGallery()">&times;</button>
    </div>

    <!-- Modal de Variações -->
    <div class="modal-overlay" id="variationModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="variationModalTitle">Selecionar Variação</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="variationContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addVariationToCart()">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <!-- Modal de Documentos Legais -->
    <div class="modal-overlay" id="legalModal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="legalModalTitle">Documento Legal</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="legalContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Tratamento de erros globais
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('solveSimpleChallenge')) {
                e.preventDefault();
                return false;
            }
        });
        
        // Dados do aplicativo
        const appData = {
            products: [],
            sales: [],
            categories: [], // Nova estrutura para categorias
            currentSale: {
                id: null, // Adicionado para rastrear se está editando uma venda existente
                items: [],
                originalItems: [], // Para controle de estoque ao editar
                customer: '',
                paymentMethod: 'cash',
                installments: 1,
                interest: 0
            },
            editingProductId: null,
            uploadedImage: null,
            productImages: [], // Array para múltiplas imagens do produto
            currentImageIndex: 0, // Índice da imagem sendo editada
            currentSaleDetails: null, // Para a nova modal de detalhes da venda
            backupHistory: [], // Histórico de backups simulados
            currentProductVariations: [], // Para gerenciar variações no modal
            cart: [], // Carrinho de compras
            currentView: 'list', // Visualização atual (list/catalog)
            galleryImages: [], // Imagens da galeria
            currentGalleryIndex: 0, // Índice atual da galeria
            selectedVariation: null, // Variação selecionada
            settings: {
                autoBackupEnabled: false, // Nova configuração para backup automático local
                theme: 'pink',
                stockAlerts: true,
                paymentReminders: true,
                updates: true
            },
            // Dados simulados para movimentações de estoque (além das vendas)
            // Em um sistema real, estas seriam registradas através de outras interfaces
            simulatedStockMovements: [
                { id: 1, date: "2024-07-01", type: "Entrada", productId: 1, quantity: 10, unitValue: 25.00, clientOrNotes: "Fornecedor X", finalStock: 52 },
                { id: 2, date: "2024-07-05", type: "Ajuste", productId: 3, quantity: -2, unitValue: 39.90, clientOrNotes: "Perda/Dano", finalStock: 13 },
                { id: 3, date: "2024-07-10", type: "Entrada", productId: 4, quantity: 5, unitValue: 130.00, clientOrNotes: "Fornecedor Y", finalStock: 33 }
            ]
        };

        // Configuração do IndexedDB
        const DB_NAME = 'AngeliDB';
        const DB_VERSION = 3; // VERSÃO ATUALIZADA PARA FORÇAR UPGRADE E CRIAR NOVAS STORES
        let db;

        // --- Funções do IndexedDB ---
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // Garante que as objectStores existam. Se não existirem, são criadas.
                    // Se já existirem, esta linha não faz nada, preservando os dados.
                    if (!db.objectStoreNames.contains('products')) {
                        db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('sales')) {
                        db.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('appSettings')) {
                        db.createObjectStore('appSettings', { keyPath: 'key' });
                    }
                    if (!db.objectStoreNames.contains('backupHistory')) {
                        db.createObjectStore('backupHistory', { keyPath: 'id', autoIncrement: true });
                    }
                    // Nova object store para movimentações de estoque simuladas
                    if (!db.objectStoreNames.contains('stockMovements')) {
                        db.createObjectStore('stockMovements', { keyPath: 'id', autoIncrement: true });
                    }
                    // Nova object store para categorias
                    if (!db.objectStoreNames.contains('categories')) {
                        db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    }
                    console.log('IndexedDB upgrade complete.');
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    showMessage('error', 'Erro ao abrir o banco de dados local. Os dados podem não ser salvos.');
                    reject(event.target.errorCode);
                };
            });
        }

        async function saveDataToIndexedDB(storeName, data) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot save data.');
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                let request;
                if (storeName === 'appSettings') {
                    // Para appSettings, sempre usar put para evitar ConstraintError
                    request = store.put(data);
                } else {
                    request = data.id ? store.put(data) : store.add(data); // Usa put para atualizar/adicionar, add para novo
                }

                request.onsuccess = async (event) => {
                    // REMOVIDO: performAutomaticLocalBackup() daqui para evitar múltiplas chamadas
                    resolve(event.target.result); // Retorna o ID para operações de adição
                };

                request.onerror = (event) => {
                    const error = event.target.error || event.target.errorCode || 'Unknown error';
                    console.error(`Error saving to ${storeName}:`, error);
                    reject(error);
                };
            });
        }

        async function deleteDataFromIndexedDB(storeName, id) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot delete data.');
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = async () => {
                    // REMOVIDO: performAutomaticLocalBackup() daqui para evitar múltiplas chamadas
                    resolve();
                };
                request.onerror = (event) => {
                    console.error(`Error deleting from ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function loadDataFromIndexedDB(storeName) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot load data.');
                return [];
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error(`Error loading from ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function clearObjectStore(storeName) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot clear store.');
                return;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Error clearing ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function getNextId(storeName) {
            if (!db) {
                console.warn('IndexedDB not open. Cannot get next ID.');
                return 1;
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor(null, 'prev');
                let maxId = 0;

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        maxId = cursor.value.id;
                    }
                    resolve(maxId + 1);
                };

                request.onerror = (event) => {
                    console.error(`Error getting next ID for ${storeName}:`, event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function loadAppSettings() {
            try {
                const settings = await loadDataFromIndexedDB('appSettings');
                
                // Carrega e aplica o tema
                const themeSetting = settings.find(s => s.key === 'theme');
                if (themeSetting) {
                    appData.settings.theme = themeSetting.value;
                    const appThemeElement = document.getElementById('appTheme');
                    if (appThemeElement) { // Adicionado verificação de null
                        appThemeElement.value = themeSetting.value;
                    }
                    changeTheme(themeSetting.value, false); // Não mostra mensagem ao carregar
                }

                // Carrega e aplica a configuração de backup automático
                const autoBackupSetting = settings.find(s => s.key === 'autoBackupEnabled');
                if (autoBackupSetting) {
                    appData.settings.autoBackupEnabled = autoBackupSetting.value;
                    const autoBackupToggleElement = document.getElementById('autoBackupToggle');
                    if (autoBackupToggleElement) { // Adicionado verificação de null
                        autoBackupToggleElement.checked = autoBackupSetting.value;
                    }
                }

                // Carrega outras configurações de notificação (exemplo)
                const stockAlertsSetting = settings.find(s => s.key === 'stockAlerts');
                if (stockAlertsSetting) {
                    appData.settings.stockAlerts = stockAlertsSetting.value;
                    const stockAlertsElement = document.getElementById('stockAlerts');
                    if (stockAlertsElement) { // Adicionado verificação de null
                        stockAlertsElement.checked = stockAlertsSetting.value;
                    }
                }

                const paymentRemindersSetting = settings.find(s => s.key === 'paymentReminders');
                if (paymentRemindersSetting) {
                    appData.settings.paymentReminders = paymentRemindersSetting.value;
                    const paymentRemindersElement = document.getElementById('paymentReminders');
                    if (paymentRemindersElement) { // Adicionado verificação de null
                        paymentRemindersElement.checked = paymentRemindersSetting.value;
                    }
                }
                
                const updatesSetting = settings.find(s => s.key === 'updates');
                if (updatesSetting) {
                    appData.settings.updates = updatesSetting.value;
                    const updatesElement = document.getElementById('updates');
                    if (updatesElement) { // Adicionado verificação de null
                        updatesElement.checked = updatesSetting.value;
                    }
                }
                
                // Carrega configuração do widget de ajuda
                const showHelpWidgetSetting = settings.find(s => s.key === 'showHelpWidget');
                if (showHelpWidgetSetting !== undefined) {
                    appData.settings.showHelpWidget = showHelpWidgetSetting.value;
                    const showHelpWidgetElement = document.getElementById('showHelpWidget');
                    if (showHelpWidgetElement) {
                        showHelpWidgetElement.checked = showHelpWidgetSetting.value;
                    }
                    toggleHelpWidget(showHelpWidgetSetting.value);
                } else {
                    // Padrão: mostrar widget
                    appData.settings.showHelpWidget = true;
                    saveAppSetting('showHelpWidget', true);
                }
                
                // Carrega informações da loja
                const storeFields = ['storeName', 'storePhone', 'storeInstagram', 'storeFacebook', 'storeWebsite'];
                storeFields.forEach(field => {
                    const setting = settings.find(s => s.key === field);
                    if (setting) {
                        appData.settings[field] = setting.value;
                    }
                });
                
                // Carrega informações da loja nos campos após DOM estar pronto
                setTimeout(loadStoreInfo, 100);

                const backupHistorySetting = await loadDataFromIndexedDB('backupHistory');
                if (backupHistorySetting) {
                    appData.backupHistory = backupHistorySetting;
                    updateBackupHistoryDisplay();
                }

            } catch (error) {
                console.error('Falha ao carregar configurações do aplicativo:', error);
            }
        }

        async function saveAppSetting(key, value) {
            if (!db) return;
            try {
                await saveDataToIndexedDB('appSettings', { key, value });
                appData.settings[key] = value; // Atualiza o estado local também
            } catch (error) {
                console.error(`Falha ao salvar configuração ${key}:`, error);
            }
        }

        async function loadAllDataAndRender() {
            try {
                appData.products = await loadDataFromIndexedDB('products');
                appData.sales = await loadDataFromIndexedDB('sales');
                appData.categories = await loadDataFromIndexedDB('categories');
                
                // Carrega movimentações de estoque simuladas se existirem no DB
                const storedSimulatedMovements = await loadDataFromIndexedDB('stockMovements');
                if (storedSimulatedMovements.length > 0) {
                    appData.simulatedStockMovements = storedSimulatedMovements;
                } else {
                    // Salva os dados simulados iniciais no DB se não houver nenhum
                    for (const movement of appData.simulatedStockMovements) {
                        await saveDataToIndexedDB('stockMovements', movement);
                    }
                }

                // Carrega as configurações antes de verificar os dados de exemplo
                await loadAppSettings(); 

                // Sistema inicia vazio - sem dados de demonstração
                if (false) {
                    initializeSampleData();
                    // Salva dados de exemplo iniciais no DB
                    for (const product of appData.products) {
                        await saveDataToIndexedDB('products', product);
                    }
                    for (const sale of appData.sales) {
                        await saveDataToIndexedDB('sales', sale);
                    }
                }
                
                // Inicializa categorias padrão se não existirem
                if (appData.categories.length === 0) {
                    const defaultCategories = ['Vestuário', 'Eletrônicos', 'Acessórios', 'Livros', 'Outros'];
                    for (const catName of defaultCategories) {
                        const category = { name: catName };
                        const id = await saveDataToIndexedDB('categories', category);
                        category.id = id;
                        appData.categories.push(category);
                    }
                }

                renderProducts();
                renderSales();
                renderCategories();
                populateProductDropdown();
                populateCategoryDropdowns();
                initCharts();
                updateDashboard();
                renderStockMovements(); // Renderiza o novo relatório de movimentação de estoque
                renderFinancialReport(); // Renderiza o novo relatório financeiro completo

                // Mensagem inicial após o carregamento dos dados
                setTimeout(() => {
                    showMessage('success', 'Aplicativo Angeli carregado com sucesso!');
                }, 1000);

            } catch (error) {
                console.error('Erro ao carregar dados do IndexedDB:', error);
                showMessage('error', 'Não foi possível carregar os dados. Verifique o console para mais detalhes. Se estiver executando o arquivo diretamente, tente usar um servidor web local.');
            }
        }

        // --- Funcionalidade das Abas ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                
                const target = tab.getAttribute('data-target');
                document.getElementById(target).classList.add('active');
            });
        });

        // --- Funcionalidade do Modal ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            resetSaleForm();
            resetProductForm();
        }

        // Fecha o modal ao clicar no botão de fechar ou fora do modal
        document.querySelectorAll('.close-modal, .modal-overlay').forEach(element => {
            if (element.classList.contains('close-modal')) {
                element.addEventListener('click', closeModal);
            } else { // Clica fora do modal, mas apenas se for o overlay
                element.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        closeModal();
                    }
                });
            }
        });

        // Impede que o modal feche ao clicar dentro dele
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => e.stopPropagation());
        });

        // --- Caixa de Mensagens ---
        function showMessage(type, text) {
            const messageBox = document.getElementById('messageBox');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.setAttribute('role', 'alert');
            message.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <div>${text}</div>
            `;
            messageBox.appendChild(message);
            
            setTimeout(() => {
                message.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => {
                    message.remove();
                }, 500);
            }, 5000);
        }

        // --- Gerenciamento de Tema ---
        function changeTheme(theme, showMsg = true) {
            document.body.className = `theme-${theme}`;
            saveAppSetting('theme', theme);
            if (showMsg) {
                showMessage('success', `Tema alterado para ${theme === 'pink' ? 'Rosa' : theme === 'blue' ? 'Azul' : theme === 'green' ? 'Verde' : 'Escuro'}.`);
            }
        }

        // --- Gerenciamento de Categorias ---
        function renderCategories() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            
            if (appData.categories.length === 0) {
                categoryList.innerHTML = '<div class="category-item">Nenhuma categoria cadastrada</div>';
                return;
            }
            
            appData.categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <span>${category.name}</span>
                    <div>
                        <button class="action-btn btn-edit" onclick="editCategory(${category.id}, '${category.name}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="confirmDeleteCategory(${category.id}, '${category.name}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                categoryList.appendChild(categoryItem);
            });
        }
        
        async function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                showMessage('error', 'Digite o nome da categoria!');
                return;
            }
            
            if (appData.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showMessage('error', 'Esta categoria já existe!');
                return;
            }
            
            const category = { name };
            const id = await saveDataToIndexedDB('categories', category);
            category.id = id;
            appData.categories.push(category);
            
            document.getElementById('newCategoryName').value = '';
            renderCategories();
            populateCategoryDropdowns();
            showMessage('success', 'Categoria adicionada com sucesso!');
            await performAutomaticLocalBackup();
        }
        
        function editCategory(id, currentName) {
            const newName = prompt('Novo nome da categoria:', currentName);
            if (!newName || newName.trim() === '') return;
            
            const trimmedName = newName.trim();
            if (appData.categories.some(c => c.name.toLowerCase() === trimmedName.toLowerCase() && c.id !== id)) {
                showMessage('error', 'Esta categoria já existe!');
                return;
            }
            
            updateCategory(id, trimmedName);
        }
        
        async function updateCategory(id, newName) {
            const category = appData.categories.find(c => c.id === id);
            if (category) {
                const oldName = category.name;
                category.name = newName;
                await saveDataToIndexedDB('categories', category);
                
                // Atualiza produtos que usam esta categoria
                appData.products.forEach(async product => {
                    if (product.category === oldName) {
                        product.category = newName;
                        await saveDataToIndexedDB('products', product);
                    }
                });
                
                renderCategories();
                populateCategoryDropdowns();
                renderProducts();
                showMessage('success', 'Categoria atualizada com sucesso!');
                await performAutomaticLocalBackup();
            }
        }
        
        function confirmDeleteCategory(id, name) {
            const productsUsingCategory = appData.products.filter(p => p.category === name).length;
            let message = `Tem certeza que deseja excluir a categoria "${name}"?`;
            if (productsUsingCategory > 0) {
                message += `\n\nAtenção: ${productsUsingCategory} produto(s) usarão esta categoria e ficarão sem categoria definida.`;
            }
            
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmActionBtn').onclick = () => deleteCategory(id);
        }
        
        async function deleteCategory(id) {
            const category = appData.categories.find(c => c.id === id);
            if (category) {
                // Remove produtos que usam esta categoria (define como vazio)
                appData.products.forEach(async product => {
                    if (product.category === category.name) {
                        product.category = '';
                        await saveDataToIndexedDB('products', product);
                    }
                });
                
                appData.categories = appData.categories.filter(c => c.id !== id);
                await deleteDataFromIndexedDB('categories', id);
                
                renderCategories();
                populateCategoryDropdowns();
                renderProducts();
                showMessage('success', 'Categoria excluída com sucesso!');
                await performAutomaticLocalBackup();
            }
            closeModal();
        }
        
        function populateCategoryDropdowns() {
            const selects = ['productCategory', 'productCategoryFilter'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const isFilter = selectId.includes('Filter');
                    
                    select.innerHTML = isFilter ? '<option value="">Todas as Categorias</option>' : '<option value="">Selecione uma categoria</option>';
                    
                    appData.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                }
            });
        }

        // --- Upload de Imagem ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) { // Máximo 5MB
                showMessage('error', 'A imagem é muito grande! Máximo 5MB.');
                document.getElementById('productImage').value = ''; // Limpa o input de arquivo
                document.getElementById('imagePreview').innerHTML = '';
                appData.uploadedImage = null;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px;">`;
                appData.uploadedImage = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Gerenciamento de Múltiplas Imagens ---
        function selectProductImage(index) {
            appData.currentImageIndex = index;
            document.getElementById('productImageInput').click();
        }
        
        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', 'A imagem é muito grande! Máximo 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                appData.productImages[appData.currentImageIndex] = e.target.result;
                updateImageGallery();
            };
            reader.readAsDataURL(file);
        }
        
        function updateImageGallery() {
            const gallery = document.getElementById('productImageGallery');
            if (!gallery) return;
            
            const items = gallery.querySelectorAll('.image-item');
            
            items.forEach((item, index) => {
                if (appData.productImages[index]) {
                    item.innerHTML = `
                        <img src="${appData.productImages[index]}" alt="Imagem ${index + 1}">
                        <button class="remove-image" onclick="removeProductImage(${index})">&times;</button>
                    `;
                    if (index < 2 && items[index + 1]) items[index + 1].style.display = 'block';
                } else {
                    item.innerHTML = `
                        <div class="image-placeholder">
                            <i class="fas fa-plus"></i><br>Adicionar
                        </div>
                    `;
                    if (index > 0 && !appData.productImages[index - 1]) {
                        item.style.display = 'none';
                    }
                }
            });
        }
        
        function removeProductImage(index) {
            appData.productImages.splice(index, 1);
            updateImageGallery();
        }
        
        // --- Geração de SKU Automático ---
        function generateProductSku() {
            const name = document.getElementById('productName').value.trim();
            if (!name) {
                showMessage('error', 'Digite o nome do produto primeiro!');
                return;
            }
            
            const words = name.split(' ').filter(word => word.length > 2);
            const prefix = words.slice(0, 3).map(word => word.substring(0, 3).toUpperCase()).join('-');
            const timestamp = Date.now().toString().slice(-3);
            const sku = `${prefix}-${timestamp}`;
            
            document.getElementById('productSku').value = sku;
        }
        
        function generateAutoSku(baseName) {
            const words = baseName.split(' ').filter(word => word.length > 2);
            const prefix = words.slice(0, 2).map(word => word.substring(0, 3).toUpperCase()).join('-');
            const timestamp = Date.now().toString().slice(-3);
            return `${prefix}-${timestamp}`;
        }

        // --- Modo Catálogo e Visualização ---
        function toggleView(view) {
            appData.currentView = view;
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('catalogViewBtn').classList.toggle('active', view === 'catalog');
            document.getElementById('productsSection').classList.toggle('catalog-mode', view === 'catalog');
            renderProducts();
        }
        
        function renderCatalogCard(product) {
            const totalStock = getTotalProductStock(product);
            const displayImage = getProductDisplayImage(product);
            const hasVariations = product.hasVariations && product.variations && product.variations.length > 0;
            
            return `
                <div class="catalog-card fade-in">
                    <div class="catalog-image" onclick="openGallery(${product.id})">
                        ${displayImage ? 
                            `<img src="${displayImage}" alt="${product.name}">` : 
                            `<i class="${getProductIcon(product.category)}" style="font-size: 4rem; color: var(--primary);"></i>`
                        }
                        ${totalStock < 5 ? '<div class="catalog-badge">Poucas unidades</div>' : ''}
                    </div>
                    <div class="catalog-info">
                        <div class="catalog-title">${product.name}</div>
                        <div class="catalog-price">R$ ${product.price.toFixed(2)}</div>
                        <div class="catalog-actions">
                            ${hasVariations ? 
                                `<button class="btn btn-info" onclick="openVariationModal(${product.id})"><i class="fas fa-palette"></i> Variações</button>` :
                                `<button class="btn btn-success" onclick="addToCart(${product.id})"><i class="fas fa-cart-plus"></i> Adicionar</button>`
                            }
                            <button class="btn btn-primary" onclick="shareProductWhatsApp(${product.id})"><i class="fab fa-whatsapp"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Carrinho de Compras ---
        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('open');
        }
        
        function addToCart(productId, variationId = null, quantity = 1) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            let variation = null;
            let itemPrice = product.price;
            let itemName = product.name;
            let itemImage = getProductDisplayImage(product);
            let availableStock = product.stock;
            
            if (variationId && product.hasVariations) {
                variation = product.variations.find(v => v.id === variationId);
                if (!variation) return;
                
                itemPrice = variation.price || product.price;
                itemName = `${product.name} (${variation.color} - ${variation.size})`;
                itemImage = variation.image || itemImage;
                availableStock = variation.stock;
            }
            
            if (availableStock < quantity) {
                showMessage('error', 'Estoque insuficiente!');
                return;
            }
            
            const cartKey = `${productId}-${variationId || 'default'}`;
            const existingItem = appData.cart.find(item => item.key === cartKey);
            
            if (existingItem) {
                if (existingItem.quantity + quantity > availableStock) {
                    showMessage('error', 'Estoque insuficiente!');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                appData.cart.push({
                    key: cartKey,
                    productId,
                    variationId,
                    name: itemName,
                    price: itemPrice,
                    quantity,
                    image: itemImage
                });
            }
            
            updateCartDisplay();
            showMessage('success', 'Item adicionado ao carrinho!');
        }
        
        function removeFromCart(cartKey) {
            appData.cart = appData.cart.filter(item => item.key !== cartKey);
            updateCartDisplay();
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const cartTotalValue = document.getElementById('cartTotalValue');
            
            const totalItems = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            cartCount.textContent = totalItems;
            
            if (appData.cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: var(--secondary); padding: 2rem;">Carrinho vazio</p>';
                cartTotal.style.display = 'none';
            } else {
                cartItems.innerHTML = appData.cart.map(item => `
                    <div class="cart-item">
                        <img class="cart-item-image" src="${item.image || ''}" alt="${item.name}">
                        <div class="cart-item-info">
                            <div style="font-weight: 600;">${item.name}</div>
                            <div style="color: var(--secondary); font-size: 0.9rem;">Qtd: ${item.quantity}</div>
                            <div style="color: var(--primary-dark); font-weight: 600;">R$ ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                        <button onclick="removeFromCart('${item.key}')" style="background: none; border: none; color: var(--danger); cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
                cartTotal.style.display = 'block';
                cartTotalValue.textContent = totalValue.toFixed(2);
            }
        }
        
        // --- Galeria de Fotos ---
        function openGallery(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            appData.galleryImages = [];
            
            // Adiciona imagens do produto
            if (product.images && product.images.length > 0) {
                appData.galleryImages.push(...product.images);
            } else if (product.image) {
                appData.galleryImages.push(product.image);
            }
            
            // Adiciona imagens das variações
            if (product.hasVariations && product.variations) {
                product.variations.forEach(variation => {
                    if (variation.image && !appData.galleryImages.includes(variation.image)) {
                        appData.galleryImages.push(variation.image);
                    }
                });
            }
            
            if (appData.galleryImages.length === 0) {
                showMessage('info', 'Nenhuma imagem disponível para este produto.');
                return;
            }
            
            appData.currentGalleryIndex = 0;
            updateGalleryImage();
            document.getElementById('photoGallery').style.display = 'flex';
        }
        
        function closeGallery() {
            document.getElementById('photoGallery').style.display = 'none';
        }
        
        function navigateGallery(direction) {
            appData.currentGalleryIndex += direction;
            if (appData.currentGalleryIndex < 0) {
                appData.currentGalleryIndex = appData.galleryImages.length - 1;
            } else if (appData.currentGalleryIndex >= appData.galleryImages.length) {
                appData.currentGalleryIndex = 0;
            }
            updateGalleryImage();
        }
        
        function updateGalleryImage() {
            const galleryImage = document.getElementById('galleryImage');
            if (appData.galleryImages[appData.currentGalleryIndex]) {
                galleryImage.src = appData.galleryImages[appData.currentGalleryIndex];
            }
        }
        
        // --- Modal de Variações ---
        function openVariationModal(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product || !product.hasVariations) return;
            
            const variationContent = document.getElementById('variationContent');
            const colors = [...new Set(product.variations.map(v => v.color))];
            const sizes = [...new Set(product.variations.map(v => v.size))];
            
            variationContent.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <img src="${getProductDisplayImage(product)}" alt="${product.name}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px;">
                </div>
                <h4>${product.name}</h4>
                <div style="font-size: 1.2rem; color: var(--primary-dark); font-weight: 600; margin: 0.5rem 0;">R$ ${product.price.toFixed(2)}</div>
                
                <div style="margin: 1rem 0;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Cor:</label>
                    <div class="color-options">
                        ${colors.map(color => `
                            <div class="color-option" style="background-color: ${getColorCode(color)};" 
                                 onclick="selectColor('${color}')" data-color="${color}" title="${color}"></div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin: 1rem 0;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Tamanho:</label>
                    <div class="size-options">
                        ${sizes.map(size => `
                            <div class="size-option" onclick="selectSize('${size}')" data-size="${size}">${size}</div>
                        `).join('')}
                    </div>
                </div>
                
                <div id="stockStatus" class="stock-status"></div>
                <input type="hidden" id="selectedProductId" value="${productId}">
            `;
            
            appData.selectedVariation = { productId, color: null, size: null };
            openModal('variationModal');
        }
        
        function selectColor(color) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            appData.selectedVariation.color = color;
            updateStockStatus();
        }
        
        function selectSize(size) {
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-size="${size}"]`).classList.add('selected');
            appData.selectedVariation.size = size;
            updateStockStatus();
        }
        
        function updateStockStatus() {
            const stockStatus = document.getElementById('stockStatus');
            if (!appData.selectedVariation.color || !appData.selectedVariation.size) {
                stockStatus.innerHTML = '';
                return;
            }
            
            const product = appData.products.find(p => p.id === appData.selectedVariation.productId);
            const variation = product.variations.find(v => 
                v.color === appData.selectedVariation.color && v.size === appData.selectedVariation.size
            );
            
            if (!variation) {
                stockStatus.innerHTML = '<span class="stock-out">Variação não disponível</span>';
                return;
            }
            
            if (variation.stock === 0) {
                stockStatus.innerHTML = '<span class="stock-out"><i class="fas fa-times-circle"></i> Esgotado</span>';
            } else if (variation.stock < 5) {
                stockStatus.innerHTML = `<span class="stock-low"><i class="fas fa-exclamation-triangle"></i> Poucas unidades (${variation.stock})</span>`;
            } else {
                stockStatus.innerHTML = `<span class="stock-available"><i class="fas fa-check-circle"></i> Disponível (${variation.stock})</span>`;
            }
        }
        
        function addVariationToCart() {
            if (!appData.selectedVariation.color || !appData.selectedVariation.size) {
                showMessage('error', 'Selecione cor e tamanho!');
                return;
            }
            
            const product = appData.products.find(p => p.id === appData.selectedVariation.productId);
            const variation = product.variations.find(v => 
                v.color === appData.selectedVariation.color && v.size === appData.selectedVariation.size
            );
            
            if (!variation || variation.stock === 0) {
                showMessage('error', 'Variação indisponível!');
                return;
            }
            
            addToCart(appData.selectedVariation.productId, variation.id);
            closeModal();
        }
        
        function getColorCode(colorName) {
            const colorMap = {
                'branco': '#ffffff',
                'preto': '#000000',
                'vermelho': '#ff0000',
                'azul': '#0000ff',
                'verde': '#008000',
                'amarelo': '#ffff00',
                'rosa': '#ffc0cb',
                'roxo': '#800080',
                'laranja': '#ffa500',
                'marrom': '#a52a2a',
                'cinza': '#808080'
            };
            return colorMap[colorName.toLowerCase()] || '#cccccc';
        }
        
        // --- Sistema de Ajuda ---
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if (modal.style.display === 'flex') {
                document.getElementById('manualDate').textContent = new Date().toLocaleDateString('pt-BR');
            }
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        function switchHelpTab(tab) {
            document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.help-tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab === 'tips' ? 'helpTips' : 'helpManual').classList.add('active');
        }

        function showManualSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.manual-section').forEach(sec => sec.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('manual' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
        }

        // Fecha modal ao clicar fora
        document.addEventListener('click', function(e) {
            const helpModal = document.getElementById('helpModal');
            if (e.target === helpModal) {
                closeHelpModal();
            }
        });

        // Atalho ESC para fechar ajuda
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHelpModal();
            }
        });

        function toggleHelpWidget(show) {
            const widget = document.getElementById('helpWidget');
            widget.style.display = show ? 'flex' : 'none';
            saveAppSetting('showHelpWidget', show);
        }

        // --- Documentos Legais ---
        function openLegalModal(type) {
            const title = document.getElementById('legalModalTitle');
            const content = document.getElementById('legalContent');
            
            const documents = {
                privacy: {
                    title: 'Política de Privacidade',
                    content: `<h1 style="color: #d13a83; border-bottom: 3px solid #ff69b4; padding-bottom: 0.5rem;">Política de Privacidade</h1><div style="background: #f8f0f4; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;"><strong>Última atualização:</strong> Janeiro de 2025</div><h2 style="color: #d13a83; margin-top: 2rem;">1. Informações Gerais</h2><p>A Angeli - Sistema de Gestão de Vendas e Estoque ("nós", "nosso" ou "Angeli") respeita sua privacidade e está comprometida em proteger suas informações pessoais. Esta Política de Privacidade descreve como coletamos, usamos, armazenamos e protegemos suas informações.</p><h2 style="color: #d13a83; margin-top: 2rem;">2. Informações que Coletamos</h2><p><strong>2.1 Informações Fornecidas por Você:</strong></p><ul><li>Dados de cadastro (nome, e-mail, telefone)</li><li>Informações comerciais (produtos, vendas, clientes)</li><li>Dados de configuração do sistema</li></ul><p><strong>2.2 Informações Coletadas Automaticamente:</strong></p><ul><li>Dados de uso do sistema</li><li>Informações técnicas (navegador, dispositivo)</li><li>Logs de acesso e atividade</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">3. Como Usamos suas Informações</h2><ul><li>Fornecer e manter nossos serviços</li><li>Processar transações e gerar relatórios</li><li>Melhorar a experiência do usuário</li><li>Comunicar atualizações e suporte técnico</li><li>Cumprir obrigações legais</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">4. Armazenamento e Segurança</h2><p>Seus dados são armazenados localmente em seu dispositivo através do navegador (IndexedDB). Implementamos medidas de segurança técnicas e organizacionais para proteger suas informações contra acesso não autorizado, alteração, divulgação ou destruição.</p><h2 style="color: #d13a83; margin-top: 2rem;">5. Compartilhamento de Informações</h2><p>Não vendemos, alugamos ou compartilhamos suas informações pessoais com terceiros, exceto:</p><ul><li>Quando exigido por lei</li><li>Para proteger nossos direitos legais</li><li>Com seu consentimento explícito</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">6. Seus Direitos</h2><p>Você tem o direito de:</p><ul><li>Acessar suas informações pessoais</li><li>Corrigir dados incorretos</li><li>Solicitar exclusão de dados</li><li>Portabilidade de dados</li><li>Revogar consentimento</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">7. Cookies e Tecnologias Similares</h2><p>Utilizamos tecnologias de armazenamento local para melhorar sua experiência. Você pode controlar essas configurações através do seu navegador.</p><h2 style="color: #d13a83; margin-top: 2rem;">8. Alterações nesta Política</h2><p>Podemos atualizar esta Política periodicamente. Notificaremos sobre mudanças significativas através do sistema ou por e-mail.</p><h2 style="color: #d13a83; margin-top: 2rem;">9. Contato</h2><p>Para questões sobre esta Política de Privacidade, entre em contato conosco através dos canais oficiais do sistema Angeli.</p><p><em>Esta política está em conformidade com a Lei Geral de Proteção de Dados (LGPD) - Lei nº 13.709/2018.</em>`
                },
                terms: {
                    title: 'Termos de Uso',
                    content: `<h1 style="color: #d13a83; border-bottom: 3px solid #ff69b4; padding-bottom: 0.5rem;">Termos de Uso</h1><div style="background: #f8f0f4; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;"><strong>Última atualização:</strong> Janeiro de 2025</div><h2 style="color: #d13a83; margin-top: 2rem;">1. Aceitação dos Termos</h2><p>Ao acessar e usar o sistema Angeli - Sistema de Gestão de Vendas e Estoque, você concorda em cumprir estes Termos de Uso. Se não concordar com qualquer parte destes termos, não utilize nossos serviços.</p><h2 style="color: #d13a83; margin-top: 2rem;">2. Descrição do Serviço</h2><p>O Angeli é um sistema de gestão empresarial que oferece funcionalidades para controle de estoque, registro de vendas, geração de relatórios e outras ferramentas de gestão comercial.</p><h2 style="color: #d13a83; margin-top: 2rem;">3. Elegibilidade e Cadastro</h2><ul><li>Você deve ter pelo menos 18 anos ou autorização legal para usar nossos serviços</li><li>Deve fornecer informações precisas e atualizadas</li><li>É responsável por manter a confidencialidade de suas credenciais</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">4. Uso Permitido</h2><p>Você pode usar o Angeli para:</p><ul><li>Gerenciar seu negócio de forma legítima</li><li>Armazenar e processar dados comerciais</li><li>Gerar relatórios e análises</li><li>Exportar seus dados</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">5. Uso Proibido</h2><p>É expressamente proibido:</p><ul><li>Usar o sistema para atividades ilegais</li><li>Tentar hackear ou comprometer a segurança</li><li>Reproduzir, distribuir ou modificar o software</li><li>Usar para fins que violem direitos de terceiros</li></ul><div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 1rem 0;"><strong>Importante:</strong> O sistema armazena dados localmente em seu dispositivo. Você é responsável por fazer backups regulares de suas informações.</div><h2 style="color: #d13a83; margin-top: 2rem;">6. Propriedade Intelectual</h2><p>O sistema Angeli, incluindo seu código, design, marca e conteúdo, é protegido por direitos autorais e outras leis de propriedade intelectual. Todos os direitos são reservados.</p><h2 style="color: #d13a83; margin-top: 2rem;">7. Responsabilidades do Usuário</h2><ul><li>Manter backup regular de seus dados</li><li>Usar o sistema de acordo com a legislação aplicável</li><li>Não compartilhar credenciais de acesso</li><li>Reportar problemas de segurança</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">8. Limitação de Responsabilidade</h2><p>O Angeli é fornecido "como está". Não garantimos que o serviço será ininterrupto ou livre de erros. Nossa responsabilidade é limitada ao máximo permitido por lei.</p><h2 style="color: #d13a83; margin-top: 2rem;">9. Disponibilidade do Serviço</h2><p>Embora nos esforçemos para manter o serviço disponível, pode haver interrupções para manutenção, atualizações ou por circunstâncias além de nosso controle.</p><h2 style="color: #d13a83; margin-top: 2rem;">10. Modificações dos Termos</h2><p>Reservamos o direito de modificar estes termos a qualquer momento. Mudanças significativas serão comunicadas através do sistema.</p><h2 style="color: #d13a83; margin-top: 2rem;">11. Rescisão</h2><p>Podemos suspender ou encerrar seu acesso ao serviço por violação destes termos ou por outros motivos legítimos, mediante notificação prévia quando possível.</p><h2 style="color: #d13a83; margin-top: 2rem;">12. Lei Aplicável</h2><p>Estes termos são regidos pelas leis brasileiras. Qualquer disputa será resolvida nos tribunais competentes do Brasil.</p><h2 style="color: #d13a83; margin-top: 2rem;">13. Contato</h2><p>Para questões sobre estes Termos de Uso, entre em contato através dos canais oficiais disponíveis no sistema.</p><p><em>Ao continuar usando o Angeli, você confirma que leu, entendeu e concorda com estes Termos de Uso.</em>`
                },
                security: {
                    title: 'Segurança de Dados',
                    content: `<h1 style="color: #d13a83; border-bottom: 3px solid #ff69b4; padding-bottom: 0.5rem;">Segurança de Dados</h1><div style="background: #f8f0f4; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;"><strong>Última atualização:</strong> Janeiro de 2025</div><h2 style="color: #d13a83; margin-top: 2rem;">1. Compromisso com a Segurança</h2><p>A Angeli está comprometida em proteger a segurança e privacidade de seus dados. Implementamos múltiplas camadas de proteção para garantir que suas informações comerciais permaneçam seguras e confidenciais.</p><h2 style="color: #d13a83; margin-top: 2rem;">2. Arquitetura de Segurança</h2><div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 1rem 0;"><strong>Armazenamento Local Seguro:</strong> Seus dados são armazenados localmente em seu dispositivo usando IndexedDB, uma tecnologia segura do navegador que não permite acesso externo não autorizado.</div><div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 1rem 0;"><strong>Criptografia:</strong> Todas as informações sensíveis são protegidas por algoritmos de criptografia padrão da indústria implementados pelo navegador.</div><div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 1rem 0;"><strong>Isolamento de Dados:</strong> Cada instalação do sistema é completamente isolada, garantindo que seus dados não sejam acessíveis por outras aplicações ou usuários.</div><h2 style="color: #d13a83; margin-top: 2rem;">3. Medidas de Proteção Implementadas</h2><ul><li><strong>Controle de Acesso:</strong> Sistema baseado em sessão local do navegador</li><li><strong>Validação de Dados:</strong> Verificação rigorosa de todas as entradas de dados</li><li><strong>Backup Automático:</strong> Sistema de backup local para prevenir perda de dados</li><li><strong>Auditoria:</strong> Logs de atividades para rastreamento de operações</li><li><strong>Sanitização:</strong> Limpeza automática de dados para prevenir ataques</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">4. Proteção contra Ameaças</h2><p><strong>4.1 Proteção contra Malware:</strong></p><ul><li>Validação rigorosa de uploads de arquivos</li><li>Sanitização de dados de entrada</li><li>Verificação de integridade de arquivos</li></ul><p><strong>4.2 Prevenção de Ataques:</strong></p><ul><li>Proteção contra XSS (Cross-Site Scripting)</li><li>Validação de CSRF (Cross-Site Request Forgery)</li><li>Sanitização de SQL injection</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">5. Backup e Recuperação</h2><div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 1rem 0;"><strong>Sistema de Backup Robusto:</strong><ul><li>Backup automático local opcional</li><li>Exportação completa em formato ZIP com imagens</li><li>Backup incremental de dados JSON</li><li>Verificação de integridade dos backups</li></ul></div><h2 style="color: #d13a83; margin-top: 2rem;">6. Conformidade e Certificações</h2><ul><li><strong>LGPD:</strong> Conformidade com a Lei Geral de Proteção de Dados</li><li><strong>Padrões Web:</strong> Seguimos as melhores práticas de segurança web</li><li><strong>Criptografia:</strong> Uso de algoritmos aprovados pela indústria</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">7. Responsabilidades do Usuário</h2><div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem; margin: 1rem 0;"><strong>Importante - Suas Responsabilidades:</strong><ul><li>Manter seu dispositivo seguro com antivírus atualizado</li><li>Usar navegadores atualizados e seguros</li><li>Fazer backups regulares de seus dados</li><li>Não compartilhar acesso ao sistema</li><li>Reportar imediatamente qualquer atividade suspeita</li></ul></div><h2 style="color: #d13a83; margin-top: 2rem;">8. Monitoramento e Detecção</h2><ul><li>Monitoramento contínuo de atividades suspeitas</li><li>Detecção automática de anomalias</li><li>Alertas de segurança em tempo real</li><li>Logs detalhados de auditoria</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">9. Resposta a Incidentes</h2><p>Em caso de incidente de segurança:</p><ol><li>Identificação e contenção imediata</li><li>Avaliação do impacto</li><li>Notificação aos usuários afetados</li><li>Implementação de medidas corretivas</li><li>Análise pós-incidente e melhorias</li></ol><h2 style="color: #d13a83; margin-top: 2rem;">10. Atualizações de Segurança</h2><p>Mantemos nosso sistema constantemente atualizado com:</p><ul><li>Patches de segurança regulares</li><li>Atualizações de bibliotecas e dependências</li><li>Melhorias contínuas nos protocolos de segurança</li><li>Testes de penetração periódicos</li></ul><h2 style="color: #d13a83; margin-top: 2rem;">11. Contato para Questões de Segurança</h2><p>Para reportar vulnerabilidades ou questões de segurança, entre em contato imediatamente através dos canais oficiais do sistema. Levamos todas as questões de segurança muito a sério e respondemos rapidamente.</p><div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 1rem 0;"><strong>Compromisso:</strong> A segurança de seus dados é nossa prioridade máxima. Investimos continuamente em tecnologias e processos para manter suas informações protegidas.</div><p><em>Este documento é atualizado regularmente para refletir as mais recentes medidas de segurança implementadas.</em>`
                }
            };
            
            const doc = documents[type];
            title.textContent = doc.title;
            content.innerHTML = doc.content;
            
            openModal('legalModal');
        }

        // --- Integração WhatsApp ---
        function shareProductWhatsApp(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            const totalStock = getTotalProductStock(product);
            const stockWarning = (totalStock > 0 && totalStock < 5) ? '\n\n*Últimas unidades disponíveis!*' : '';
            
            let message = `*${product.name}*\n\n`;
            message += `SKU: ${product.sku}\n`;
            message += `Preço: *R$ ${product.price.toFixed(2)}*${stockWarning}\n\n`;
            
            if (product.description) {
                message += `${product.description}\n\n`;
            }
            
            if (product.hasVariations && product.variations && product.variations.length > 0) {
                const colors = [...new Set(product.variations.map(v => v.color))];
                const sizes = [...new Set(product.variations.map(v => v.size))];
                message += `Variações:\n`;
                message += `Cores: ${colors.join(', ')}\n`;
                message += `Tamanhos: ${sizes.join(', ')}\n\n`;
            }
            
            message += `Interesse? Entre em contato!`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Mostra foto para copiar se existir
            const productImage = getProductDisplayImage(product);
            if (productImage) {
                showImageToCopy(product.name, productImage);
            }
        }
        
        function showImageToCopy(productName, imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 9999; display: flex;
                align-items: center; justify-content: center; flex-direction: column;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; color: white; max-width: 90%;">
                    <h3 style="margin-bottom: 20px; color: #ff69b4;">${productName}</h3>
                    <img src="${imageUrl}" style="max-width: 100%; max-height: 60vh; border-radius: 10px; box-shadow: 0 4px 20px rgba(255,105,180,0.3);">
                    <div style="background: white; color: #333; padding: 20px; border-radius: 10px; margin: 20px 0; max-width: 400px;">
                        <strong style="color: #d13a83;">Como enviar no WhatsApp:</strong><br><br>
                        <div style="text-align: left;">
                            1. Clique com botão direito na imagem<br>
                            2. Selecione "Copiar imagem"<br>
                            3. Vá para o WhatsApp<br>
                            4. Cole a imagem (Ctrl+V)<br>
                            5. Envie junto com a mensagem
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: #ff69b4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Fechar
                    </button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }
        
        function shareCartWhatsApp() {
            if (appData.cart.length === 0) {
                showMessage('error', 'Carrinho vazio!');
                return;
            }
            
            const totalValue = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let message = '*Pedido:*\n\n';
            
            appData.cart.forEach(item => {
                message += `• ${item.name}\n`;
                message += `  Qtd: ${item.quantity} | Valor: R$ ${(item.price * item.quantity).toFixed(2)}\n\n`;
            });
            
            message += `*Total: R$ ${totalValue.toFixed(2)}*\n\nGostaria de finalizar este pedido!`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function finalizePurchase() {
            if (appData.cart.length === 0) {
                showMessage('error', 'Carrinho vazio!');
                return;
            }
            
            // Transfere os itens do carrinho para o modal de venda
            resetSaleForm();
            
            // Adiciona cada item do carrinho à venda atual
            appData.cart.forEach(cartItem => {
                appData.currentSale.items.push({
                    productId: cartItem.productId,
                    variationId: cartItem.variationId,
                    name: cartItem.name,
                    quantity: cartItem.quantity,
                    price: cartItem.price,
                    itemKey: cartItem.key
                });
            });
            
            // Fecha o carrinho e abre o modal de venda
            toggleCart();
            
            // Configura o modal para nova venda
            document.getElementById('saleModalTitle').innerHTML = '<i class="fas fa-cash-register"></i> Registrar Nova Venda';
            document.getElementById('finalizeSaleBtn').innerText = 'Finalizar Venda';
            appData.currentSale.id = null;
            
            // Renderiza os itens e atualiza o total
            renderSaleItems();
            updateSaleTotal();
            
            // Abre o modal de venda
            openModal('saleModal');
            
            showMessage('info', 'Itens transferidos para o modal de venda. Escolha a forma de pagamento e finalize.');
        }

        // --- Gerenciamento de Variações ---
        function toggleVariations() {
            const hasVariations = document.getElementById('hasVariations').checked;
            const variationsSection = document.getElementById('variationsSection');
            const stockField = document.getElementById('productStock');
            
            if (hasVariations) {
                variationsSection.style.display = 'block';
                stockField.disabled = true;
                stockField.value = 0;
                if (appData.currentProductVariations.length === 0) {
                    addColorVariation();
                }
            } else {
                variationsSection.style.display = 'none';
                stockField.disabled = false;
                appData.currentProductVariations = [];
                document.getElementById('colorVariations').innerHTML = '';
            }
            updateVariationSummary();
        }
        
        function addColorVariation() {
            const colorId = Date.now();
            const colorDiv = document.createElement('div');
            colorDiv.className = 'color-section';
            colorDiv.id = `color-${colorId}`;
            colorDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h5>Cor</h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeColorVariation(${colorId})"><i class="fas fa-trash"></i> Remover Cor</button>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="Nome da cor" onchange="updateVariationSummary()" data-color-input="${colorId}">
                </div>
                <div class="sizes-container" id="sizes-${colorId}">
                    <button type="button" class="btn btn-info btn-sm" onclick="addSizeVariation(${colorId})"><i class="fas fa-plus"></i> Adicionar Tamanho</button>
                </div>
            `;
            document.getElementById('colorVariations').appendChild(colorDiv);
            addSizeVariation(colorId);
        }
        
        function removeColorVariation(colorId) {
            document.getElementById(`color-${colorId}`).remove();
            updateVariationSummary();
        }
        
        function addSizeVariation(colorId) {
            const sizeId = Date.now() + Math.random();
            const sizeDiv = document.createElement('div');
            sizeDiv.className = 'size-row';
            sizeDiv.id = `size-${sizeId}`;
            sizeDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Tamanho" onchange="updateVariationSummary()">
                <input type="number" class="form-control" placeholder="Estoque" min="0" onchange="updateVariationSummary()">
                <input type="number" class="form-control" placeholder="Preço (opcional)" step="0.01" min="0" onchange="updateVariationSummary()">
                <input type="text" class="form-control" placeholder="SKU (opcional)" onchange="updateVariationSummary()">
                <div class="variation-image-container">
                    <img class="variation-image" style="display: none;" onclick="selectVariationImage(${sizeId})">
                    <button type="button" class="btn btn-info btn-sm" onclick="selectVariationImage(${sizeId})" title="Adicionar imagem"><i class="fas fa-camera"></i></button>
                    <input type="file" id="variationImage-${sizeId}" accept="image/*" style="display: none;" onchange="handleVariationImageUpload(event, ${sizeId})">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSizeVariation(${sizeId})"><i class="fas fa-trash"></i></button>
            `;
            const sizesContainer = document.getElementById(`sizes-${colorId}`);
            sizesContainer.insertBefore(sizeDiv, sizesContainer.lastElementChild);
            updateVariationSummary();
        }
        
        function selectVariationImage(sizeId) {
            document.getElementById(`variationImage-${sizeId}`).click();
        }
        
        function handleVariationImageUpload(event, sizeId) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', 'A imagem é muito grande! Máximo 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const sizeDiv = document.getElementById(`size-${sizeId}`);
                const img = sizeDiv.querySelector('.variation-image');
                img.src = e.target.result;
                img.style.display = 'block';
                img.setAttribute('data-image', e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function removeSizeVariation(sizeId) {
            document.getElementById(`size-${sizeId}`).remove();
            updateVariationSummary();
        }
        
        function updateVariationSummary() {
            const variations = collectVariationsFromForm();
            const totalStock = variations.reduce((sum, v) => sum + (v.stock || 0), 0);
            const summary = document.getElementById('variationSummary');
            summary.innerHTML = `Total de variações: ${variations.length} | Estoque total: ${totalStock}`;
        }
        
        function collectVariationsFromForm() {
            const variations = [];
            const colorSections = document.querySelectorAll('.color-section');
            
            colorSections.forEach(colorSection => {
                const colorInput = colorSection.querySelector('[data-color-input]');
                const color = colorInput ? colorInput.value.trim() : '';
                if (!color) return;
                
                const sizeRows = colorSection.querySelectorAll('.size-row');
                sizeRows.forEach(sizeRow => {
                    const inputs = sizeRow.querySelectorAll('input[type="text"], input[type="number"]');
                    const size = inputs[0].value.trim();
                    const stock = parseInt(inputs[1].value) || 0;
                    const price = parseFloat(inputs[2].value) || null;
                    const sku = inputs[3].value.trim() || '';
                    const img = sizeRow.querySelector('.variation-image');
                    const image = img && img.getAttribute('data-image') ? img.getAttribute('data-image') : null;
                    
                    if (size) {
                        variations.push({
                            id: Date.now() + Math.random(),
                            color,
                            size,
                            stock,
                            price,
                            sku: sku || generateVariationSKU(document.getElementById('productSku').value, color, size),
                            image,
                            active: true
                        });
                    }
                });
            });
            
            return variations;
        }
        
        function generateVariationSKU(baseSku, color, size) {
            const colorCode = color.substring(0, 2).toUpperCase();
            const sizeCode = size.toUpperCase();
            return `${baseSku}-${colorCode}-${sizeCode}`;
        }
        
        function loadVariationsToForm(variations) {
            document.getElementById('colorVariations').innerHTML = '';
            appData.currentProductVariations = variations || [];
            
            if (variations && variations.length > 0) {
                const colorGroups = {};
                variations.forEach(variation => {
                    if (!colorGroups[variation.color]) {
                        colorGroups[variation.color] = [];
                    }
                    colorGroups[variation.color].push(variation);
                });
                
                Object.keys(colorGroups).forEach(color => {
                    const colorId = Date.now() + Math.random();
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'color-section';
                    colorDiv.id = `color-${colorId}`;
                    colorDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h5>Cor</h5>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeColorVariation(${colorId})"><i class="fas fa-trash"></i> Remover Cor</button>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" value="${color}" onchange="updateVariationSummary()" data-color-input="${colorId}">
                        </div>
                        <div class="sizes-container" id="sizes-${colorId}">
                            <button type="button" class="btn btn-info btn-sm" onclick="addSizeVariation(${colorId})"><i class="fas fa-plus"></i> Adicionar Tamanho</button>
                        </div>
                    `;
                    document.getElementById('colorVariations').appendChild(colorDiv);
                    
                    colorGroups[color].forEach(variation => {
                        const sizeId = Date.now() + Math.random();
                        const sizeDiv = document.createElement('div');
                        sizeDiv.className = 'size-row';
                        sizeDiv.id = `size-${sizeId}`;
                        sizeDiv.innerHTML = `
                            <input type="text" class="form-control" value="${variation.size}" onchange="updateVariationSummary()">
                            <input type="number" class="form-control" value="${variation.stock}" min="0" onchange="updateVariationSummary()">
                            <input type="number" class="form-control" value="${variation.price || ''}" step="0.01" min="0" placeholder="Preço (opcional)" onchange="updateVariationSummary()">
                            <input type="text" class="form-control" value="${variation.sku}" placeholder="SKU (opcional)" onchange="updateVariationSummary()">
                            <div class="variation-image-container">
                                <img class="variation-image" ${variation.image ? `src="${variation.image}" data-image="${variation.image}" style="display: block;"` : 'style="display: none;"'} onclick="selectVariationImage(${sizeId})">
                                <button type="button" class="btn btn-info btn-sm" onclick="selectVariationImage(${sizeId})" title="${variation.image ? 'Alterar' : 'Adicionar'} imagem"><i class="fas fa-camera"></i></button>
                                <input type="file" id="variationImage-${sizeId}" accept="image/*" style="display: none;" onchange="handleVariationImageUpload(event, ${sizeId})">
                            </div>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSizeVariation(${sizeId})"><i class="fas fa-trash"></i></button>
                        `;
                        const sizesContainer = document.getElementById(`sizes-${colorId}`);
                        sizesContainer.insertBefore(sizeDiv, sizesContainer.lastElementChild);
                    });
                });
            }
            updateVariationSummary();
        }

        // --- Dados de Exemplo (Usado apenas se o DB estiver vazio) ---
        function initializeSampleData() {
            appData.products = [
                { 
                    id: 1, 
                    name: "Camiseta Básica", 
                    sku: "CAM-BAS-001", 
                    category: "Vestuário", 
                    price: 29.90, 
                    stock: 0, 
                    description: "Camiseta básica de algodão 100%", 
                    image: '',
                    hasVariations: true,
                    variations: [
                        { id: 1, color: 'Branco', size: 'P', stock: 10, price: null, sku: 'CAM-BAS-001-BR-P', active: true },
                        { id: 2, color: 'Branco', size: 'M', stock: 15, price: null, sku: 'CAM-BAS-001-BR-M', active: true },
                        { id: 3, color: 'Branco', size: 'G', stock: 12, price: null, sku: 'CAM-BAS-001-BR-G', active: true },
                        { id: 4, color: 'Preto', size: 'P', stock: 8, price: null, sku: 'CAM-BAS-001-PR-P', active: true },
                        { id: 5, color: 'Preto', size: 'M', stock: 20, price: null, sku: 'CAM-BAS-001-PR-M', active: true }
                    ]
                },
                { id: 2, name: "Smartphone X Pro", sku: "SMP-XP-2023", category: "Eletrônicos", price: 2499.00, stock: 3, description: "Smartphone de última geração", image: '', hasVariations: false, variations: [] },
                { id: 3, name: "Livro: A Arte da Guerra", sku: "LIV-ART-077", category: "Livros", price: 39.90, stock: 15, description: "Clássico da literatura estratégica", image: '', hasVariations: false, variations: [] },
                { id: 4, name: "Fones Bluetooth", sku: "FON-BT-045", category: "Acessórios", price: 149.90, stock: 28, description: "Fones sem fio com cancelamento de ruído", image: '', hasVariations: false, variations: [] }
            ];

            // Ajuste nas datas de exemplo para simular situações de atraso/pendente
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            appData.sales = [
                { 
                    id: 1, 
                    date: yesterday.toISOString().split('T')[0], // Venda de ontem
                    customer: "Maria Silva", 
                    amount: 389.90, 
                    payment: "Parcelado (3x)", 
                    paymentMethod: "installment",
                    installments: 3,
                    interest: 5,
                    status: "pending", // Será atualizado para 'overdue' se a parcela 1 estiver atrasada
                    items: [
                        { productId: 1, name: "Camiseta Básica Branca", quantity: 3, price: 29.90 },
                        { productId: 4, name: "Fones Bluetooth", quantity: 1, price: 149.90 }
                    ],
                    installmentList: [ 
                        { number: 1, dueDate: yesterday.toLocaleDateString('pt-BR'), amount: (389.90 * 1.05) / 3, status: 'pending', paymentDate: null }, // Vencida
                        { number: 2, dueDate: tomorrow.toLocaleDateString('pt-BR'), amount: (389.90 * 1.05) / 3, status: 'pending', paymentDate: null }, // Futura
                        { number: 3, dueDate: new Date(tomorrow.getFullYear(), tomorrow.getMonth() + 1, tomorrow.getDate()).toLocaleDateString('pt-BR'), amount: (389.90 * 1.05) / 3, status: 'pending', paymentDate: null } // Futura
                    ]
                },
                { 
                    id: 2, 
                    date: today.toISOString().split('T')[0], // Venda de hoje
                    customer: "Carlos Oliveira", 
                    amount: 2499.00, 
                    payment: "À Vista", 
                    paymentMethod: "cash",
                    status: "paid", 
                    items: [
                        { productId: 2, name: "Smartphone X Pro", quantity: 1, price: 2499.00 }
                    ]
                },
                { 
                    id: 3, 
                    date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 5).toISOString().split('T')[0], // Venda de 5 dias atrás
                    customer: "Loja Central", 
                    amount: 1280.50, 
                    payment: "Crédito", 
                    paymentMethod: "credit",
                    status: "paid", 
                    items: [
                        { productId: 1, name: "Camiseta Básica Branca", quantity: 10, price: 29.90 },
                        { productId: 3, name: "Livro: A Arte da Guerra", quantity: 15, price: 39.90 }
                    ]
                },
                { 
                    id: 4, 
                    date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 2).toISOString().split('T')[0], // Venda de 2 dias atrás
                    customer: "Ana Paula", 
                    amount: 150.00, 
                    payment: "Parcelado (2x)", 
                    paymentMethod: "installment",
                    installments: 2,
                    interest: 0,
                    status: "pending", 
                    items: [
                        { productId: 1, name: "Camiseta Básica Branca", quantity: 5, price: 29.90 }
                    ],
                    installmentList: [ 
                        { number: 1, dueDate: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 7).toLocaleDateString('pt-BR'), amount: 75.00, status: 'pending', paymentDate: null }, // Futura
                        { number: 2, dueDate: new Date(today.getFullYear(), today.getMonth() + 1, today.getDate() + 7).toLocaleDateString('pt-BR'), amount: 75.00, status: 'pending', paymentDate: null } // Futura
                    ]
                }
            ];
            showMessage('info', 'Dados de exemplo carregados pois o banco de dados estava vazio.');
        }

        // --- Gerenciamento de Produtos ---
        function renderProducts() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            
            const filteredProducts = applyProductFilters(appData.products);

            const productsEmptyState = document.getElementById('productsEmptyState');
            if (filteredProducts.length === 0) {
                productsEmptyState.style.display = 'block';
                return;
            } else {
                productsEmptyState.style.display = 'none';
            }

            if (appData.currentView === 'catalog') {
                // Modo Catálogo
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.innerHTML = renderCatalogCard(product);
                    productsList.appendChild(productCard.firstElementChild);
                });
            } else {
                // Modo Lista (original)
                filteredProducts.forEach(product => {
                    const totalStock = getTotalProductStock(product);
                    const isLowStock = totalStock < 5;
                    const variationsInfo = product.hasVariations ? 
                        `${product.variations.filter(v => v.active).length} variações` : 
                        'Produto simples';
                    
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card fade-in';
                    productCard.innerHTML = `
                        <div class="product-image">
                            ${getProductDisplayImage(product) ? 
                                `<img src="${getProductDisplayImage(product)}" alt="${product.name}">` : 
                                `<i class="${getProductIcon(product.category)}"></i>`
                            }
                            <div class="upload-icon" onclick="openProductModal(${product.id})">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="product-info">
                            <div class="product-title" title="${product.name}">${product.name}</div>
                            <div class="product-sku" title="SKU: ${product.sku}">SKU: ${product.sku}</div>
                            <div>Categoria: ${product.category}</div>
                            <div style="font-size: 0.75rem; color: var(--secondary);">${variationsInfo}</div>
                            <div class="product-meta">
                                <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                                <div class="product-stock ${isLowStock ? 'low' : ''}">Estoque: ${totalStock}</div>
                            </div>
                            <div class="product-actions">
                                <button class="action-btn btn-edit" onclick="openProductModal(${product.id})" aria-label="Editar ${product.name}"><i class="fas fa-edit"></i> Editar</button>
                                <button class="action-btn btn-delete" onclick="confirmDeleteProduct(${product.id}, '${product.name}')" aria-label="Excluir ${product.name}"><i class="fas fa-trash"></i> Excluir</button>
                            </div>
                        </div>
                    `;
                    productsList.appendChild(productCard);
                });
            }
            
            updateDashboard();
        }
        
        function getTotalProductStock(product) {
            if (product.hasVariations && product.variations) {
                return product.variations
                    .filter(v => v.active)
                    .reduce((sum, v) => sum + (v.stock || 0), 0);
            }
            return product.stock || 0;
        }

        function getProductIcon(category) {
            switch(category) {
                case 'Vestuário': return 'fas fa-tshirt';
                case 'Eletrônicos': return 'fas fa-mobile-alt';
                case 'Livros': return 'fas fa-book';
                case 'Acessórios': return 'fas fa-headphones';
                default: return 'fas fa-box';
            }
        }
        
        function getProductDisplayImage(product) {
            // Prioridade: primeira imagem da galeria, depois imagem antiga
            if (product.images && product.images.length > 0) {
                return product.images[0];
            }
            return product.image || null;
        }

        function applyProductFilters(products) {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('productCategoryFilter').value;
            const stockFilter = document.getElementById('productStockFilter').value;

            return products.filter(product => {
                const name = product.name.toLowerCase();
                const sku = product.sku.toLowerCase();
                const category = product.category.toLowerCase();
                
                const matchesSearch = name.includes(searchTerm) || sku.includes(searchTerm) || category.includes(searchTerm);
                const matchesCategory = categoryFilter === '' || category === categoryFilter.toLowerCase();
                const matchesStock = stockFilter === '' || (stockFilter === 'low' && product.stock < 5);

                return matchesSearch && matchesCategory && matchesStock;
            });
        }

        function filterProducts() {
            renderProducts(); // Renderiza novamente com os filtros aplicados
        }

        function openProductModal(editId = null) {
            resetProductForm(); // Sempre reseta antes de abrir
            populateCategoryDropdowns(); // Garante que as categorias estão atualizadas
            
            const elements = {
                productModalTitle: document.getElementById('productModalTitle'),
                productName: document.getElementById('productName'),
                productSku: document.getElementById('productSku'),
                productCategory: document.getElementById('productCategory'),
                productPrice: document.getElementById('productPrice'),
                productStock: document.getElementById('productStock'),
                productDescription: document.getElementById('productDescription'),
                saveProductBtn: document.getElementById('saveProductBtn'),
                hasVariations: document.getElementById('hasVariations'),
                imagePreview: document.getElementById('imagePreview')
            };
            
            if (editId !== null) {
                const product = appData.products.find(p => p.id === editId);
                if (product) {
                    if (elements.productModalTitle) elements.productModalTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Produto';
                    if (elements.productName) elements.productName.value = product.name;
                    if (elements.productSku) elements.productSku.value = product.sku;
                    if (elements.productCategory) elements.productCategory.value = product.category;
                    if (elements.productPrice) elements.productPrice.value = product.price;
                    if (elements.productStock) elements.productStock.value = product.stock;
                    if (elements.productDescription) elements.productDescription.value = product.description || '';
                    if (elements.saveProductBtn) elements.saveProductBtn.innerText = 'Atualizar Produto';
                    appData.editingProductId = editId;
                    
                    // Configura variações
                    if (product.hasVariations && elements.hasVariations) {
                        elements.hasVariations.checked = true;
                        toggleVariations();
                        loadVariationsToForm(product.variations);
                    }
                    
                    // Carrega imagens do produto
                    appData.productImages = product.images || [];
                    updateImageGallery();
                    
                    if (product.image && elements.imagePreview) {
                        elements.imagePreview.innerHTML = `<img src="${product.image}" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px;">`;
                        appData.uploadedImage = product.image;
                    }
                }
            } else {
                if (elements.productModalTitle) elements.productModalTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Novo Produto';
                if (elements.saveProductBtn) elements.saveProductBtn.innerText = 'Salvar Produto';
                appData.editingProductId = null;
                
                // Gera SKU automático quando o nome for preenchido
                if (elements.productName && elements.productSku) {
                    elements.productName.addEventListener('blur', function() {
                        if (!elements.productSku.value.trim() && this.value.trim()) {
                            elements.productSku.value = generateAutoSku(this.value.trim());
                        }
                    });
                }
            }
            openModal('productModal');
        }

        async function saveProduct() {
            const elements = {
                productName: document.getElementById('productName'),
                productSku: document.getElementById('productSku'),
                productCategory: document.getElementById('productCategory'),
                productPrice: document.getElementById('productPrice'),
                productStock: document.getElementById('productStock'),
                productDescription: document.getElementById('productDescription'),
                hasVariations: document.getElementById('hasVariations')
            };
            
            if (!elements.productName || !elements.productSku || !elements.productCategory || 
                !elements.productPrice || !elements.productStock || !elements.productDescription || 
                !elements.hasVariations) {
                showMessage('error', 'Erro: Elementos do formulário não encontrados.');
                return;
            }
            
            const name = elements.productName.value.trim();
            let sku = elements.productSku.value.trim();
            const category = elements.productCategory.value;
            const price = parseFloat(elements.productPrice.value);
            const stock = parseInt(elements.productStock.value);
            const description = elements.productDescription.value.trim();
            const hasVariations = elements.hasVariations.checked;
            
            // Gera SKU automaticamente se estiver vazio
            if (!sku && name) {
                sku = generateAutoSku(name);
                elements.productSku.value = sku;
            }
            
            if (!name || !sku || !category || isNaN(price) || price < 0) {
                showMessage('error', 'Por favor, preencha todos os campos obrigatórios com valores válidos.');
                return;
            }
            
            if (!hasVariations && (isNaN(stock) || stock < 0)) {
                showMessage('error', 'Por favor, informe um estoque válido para produtos sem variações.');
                return;
            }

            // Verifica se o SKU já existe
            const isSkuTaken = appData.products.some(p => p.sku === sku && p.id !== appData.editingProductId);
            if (isSkuTaken) {
                showMessage('error', 'O SKU inserido já existe para outro produto. Por favor, use um SKU único.');
                return;
            }
            
            let variations = [];
            if (hasVariations) {
                variations = collectVariationsFromForm();
                if (variations.length === 0) {
                    showMessage('error', 'Adicione pelo menos uma variação para produtos com variações.');
                    return;
                }
                
                // Verifica SKUs únicos das variações
                const variationSkus = variations.map(v => v.sku).filter(s => s);
                const duplicateSkus = variationSkus.filter((sku, index) => variationSkus.indexOf(sku) !== index);
                if (duplicateSkus.length > 0) {
                    showMessage('error', `SKUs duplicados nas variações: ${duplicateSkus.join(', ')}`);
                    return;
                }
            }
            
            let productToSave;
            if (appData.editingProductId) {
                const index = appData.products.findIndex(p => p.id === appData.editingProductId);
                if (index !== -1) {
                    productToSave = {
                        ...appData.products[index],
                        name,
                        sku,
                        category,
                        price,
                        stock: hasVariations ? 0 : stock,
                        description,
                        hasVariations,
                        variations,
                        image: appData.uploadedImage || appData.products[index].image,
                        images: appData.productImages.length > 0 ? [...appData.productImages] : appData.products[index].images || []
                    };
                    appData.products[index] = productToSave;
                    await saveDataToIndexedDB('products', productToSave);
                    showMessage('success', 'Produto atualizado com sucesso!');
                }
            } else {
                const newId = await getNextId('products');
                productToSave = {
                    id: newId,
                    name,
                    sku,
                    category,
                    price,
                    stock: hasVariations ? 0 : stock,
                    description,
                    hasVariations,
                    variations,
                    image: appData.uploadedImage,
                    images: [...appData.productImages]
                };
                const addedId = await saveDataToIndexedDB('products', productToSave);
                productToSave.id = addedId;
                appData.products.push(productToSave);
                showMessage('success', 'Produto adicionado com sucesso!');
            }
            
            renderProducts();
            populateProductDropdown();
            closeModal();
            await performAutomaticLocalBackup();
        }

        function confirmDeleteProduct(id, name) {
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').textContent = `Tem certeza que deseja excluir o produto "${name}"? Esta ação não pode ser desfeita.`;
            document.getElementById('confirmActionBtn').onclick = () => deleteProduct(id);
        }

        async function deleteProduct(id) {
            appData.products = appData.products.filter(product => product.id !== id);
            await deleteDataFromIndexedDB('products', id);
            showMessage('success', 'Produto excluído com sucesso!');
            closeModal(); // Fecha o modal de confirmação
            renderProducts();
            // CHAMA O BACKUP AUTOMÁTICO APENAS UMA VEZ AQUI
            await performAutomaticLocalBackup();
        }

        function resetProductForm() {
            const elements = {
                productName: document.getElementById('productName'),
                productSku: document.getElementById('productSku'),
                productCategory: document.getElementById('productCategory'),
                productPrice: document.getElementById('productPrice'),
                productStock: document.getElementById('productStock'),
                productDescription: document.getElementById('productDescription'),
                imagePreview: document.getElementById('imagePreview'),
                productImage: document.getElementById('productImage'),
                hasVariations: document.getElementById('hasVariations'),
                variationsSection: document.getElementById('variationsSection'),
                colorVariations: document.getElementById('colorVariations')
            };
            
            if (elements.productName) elements.productName.value = '';
            if (elements.productSku) elements.productSku.value = '';
            if (elements.productCategory) elements.productCategory.value = '';
            if (elements.productPrice) elements.productPrice.value = '';
            if (elements.productStock) {
                elements.productStock.value = '';
                elements.productStock.disabled = false;
            }
            if (elements.productDescription) elements.productDescription.value = '';
            if (elements.imagePreview) elements.imagePreview.innerHTML = '';
            if (elements.productImage) elements.productImage.value = '';
            if (elements.hasVariations) elements.hasVariations.checked = false;
            if (elements.variationsSection) elements.variationsSection.style.display = 'none';
            if (elements.colorVariations) elements.colorVariations.innerHTML = '';
            
            appData.uploadedImage = null;
            appData.productImages = [];
            appData.currentProductVariations = [];
            updateImageGallery();
        }

        // --- Gerenciamento de Vendas ---
        function renderSales() {
            const salesTableBody = document.getElementById('salesTableBody');
            salesTableBody.innerHTML = '';
            
            const filteredSales = applySaleFilters(appData.sales);

            if (filteredSales.length === 0) {
                document.getElementById('salesEmptyState').style.display = 'block';
                return;
            } else {
                document.getElementById('salesEmptyState').style.display = 'none';
            }

            filteredSales.sort((a, b) => new Date(b.date + 'T00:00:00') - new Date(a.date + 'T00:00:00')).forEach(sale => { // CORREÇÃO AQUI
                const row = document.createElement('tr');
                
                let statusBadge;
                let currentSaleStatus = sale.status; // Começa com o status salvo

                // Lógica para determinar o status real da venda, especialmente para parceladas
                if (sale.paymentMethod === 'installment' && sale.installmentList) {
                    const hasOverdueInstallment = sale.installmentList.some(inst => 
                        inst.status === 'pending' && new Date(inst.dueDate.split('/').reverse().join('-') + 'T00:00:00') < new Date() // CORREÇÃO AQUI
                    );
                    const allInstallmentsPaid = sale.installmentList.every(inst => inst.status === 'paid');

                    if (hasOverdueInstallment) {
                        currentSaleStatus = 'overdue';
                    } else if (allInstallmentsPaid) {
                        currentSaleStatus = 'paid';
                    } else {
                        currentSaleStatus = 'pending';
                    }
                }

                // Atualiza o status da venda no objeto appData.sales se ele mudou
                if (sale.status !== currentSaleStatus) {
                    sale.status = currentSaleStatus;
                    // Salva o status atualizado no DB imediatamente (sem disparar backup automático para evitar loop)
                    saveDataToIndexedDB('sales', sale); 
                }

                switch(currentSaleStatus) {
                    case 'paid': statusBadge = '<span class="status-badge status-paid">Pago</span>'; break;
                    case 'pending': statusBadge = '<span class="status-badge status-pending">Pendente</span>'; break;
                    case 'overdue': statusBadge = '<span class="status-badge status-overdue">Atrasado</span>'; break;
                    default: statusBadge = '<span class="status-badge">Desconhecido</span>';
                }
                
                row.innerHTML = `
                    <td>#V${sale.id.toString().padStart(4, '0')}</td>
                    <td>${new Date(sale.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td> <!-- CORREÇÃO AQUI -->
                    <td>${sale.customer}</td>
                    <td>R$ ${sale.amount.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="action-btn btn-info" onclick="openSaleDetailsModal(${sale.id})" aria-label="Ver detalhes da venda ${sale.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-edit" onclick="openSaleModal(${sale.id})" aria-label="Editar venda ${sale.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="confirmDeleteSale(${sale.id})" aria-label="Excluir venda ${sale.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
            
            updateDashboard();
        }

        function applySaleFilters(sales) {
            const searchTerm = document.getElementById('saleSearch').value.toLowerCase();
            const startDate = document.getElementById('saleDateFilterStart').value;
            const endDate = document.getElementById('saleDateFilterEnd').value;
            const statusFilter = document.getElementById('saleStatusFilter').value;

            return sales.filter(sale => {
                const customer = sale.customer.toLowerCase();
                const id = `#v${sale.id.toString().padStart(4, '0')}`.toLowerCase();
                const saleDate = new Date(sale.date + 'T00:00:00'); // CORREÇÃO AQUI
                
                const matchesSearch = customer.includes(searchTerm) || id.includes(searchTerm);
                const matchesDate = (!startDate || saleDate >= new Date(startDate + 'T00:00:00')) && (!endDate || saleDate <= new Date(endDate + 'T23:59:59')); // Ajuste para incluir o dia inteiro
                
                let currentSaleStatus = sale.status;
                if (sale.paymentMethod === 'installment' && sale.installmentList) {
                    const hasOverdueInstallment = sale.installmentList.some(inst => 
                        inst.status === 'pending' && new Date(inst.dueDate.split('/').reverse().join('-') + 'T00:00:00') < new Date() // CORREÇÃO AQUI
                    );
                    const allInstallmentsPaid = sale.installmentList.every(inst => inst.status === 'paid');

                    if (hasOverdueInstallment) {
                        currentSaleStatus = 'overdue';
                    } else if (allInstallmentsPaid) {
                        currentSaleStatus = 'paid';
                    } else {
                        currentSaleStatus = 'pending';
                    }
                }
                const matchesStatus = statusFilter === '' || currentSaleStatus === statusFilter;

                return matchesSearch && matchesDate && matchesStatus;
            });
        }

        function filterSales() {
            renderSales();
        }

        /**
         * Abre o modal de registro/edição de venda.
         * @param {number|null} editId O ID da venda a ser editada, ou null para nova venda.
         */
        function openSaleModal(editId = null) {
            resetSaleForm(); // Sempre reseta antes de abrir
            populateProductDropdown(); // Popula o dropdown de produtos

            if (editId !== null) {
                const sale = appData.sales.find(s => s.id === editId);
                if (sale) {
                    appData.currentSale.id = sale.id;
                    appData.currentSale.customer = sale.customer;
                    appData.currentSale.paymentMethod = sale.paymentMethod;
                    appData.currentSale.installments = sale.installments || 1;
                    appData.currentSale.interest = sale.interest || 0;
                    appData.currentSale.items = JSON.parse(JSON.stringify(sale.items)); // Deep copy
                    appData.currentSale.originalItems = JSON.parse(JSON.stringify(sale.items)); // Salva os itens originais para ajuste de estoque

                    document.getElementById('saleModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Venda';
                    document.getElementById('saleCustomer').value = sale.customer;
                    document.getElementById('paymentMethod').value = sale.paymentMethod;
                    document.getElementById('installmentCount').value = sale.installments || 2;
                    document.getElementById('installmentInterest').value = sale.interest || 0;
                    document.getElementById('finalizeSaleBtn').innerText = 'Atualizar Venda';

                    if (sale.paymentMethod === 'installment') {
                        document.getElementById('installmentFields').style.display = 'block';
                    } else {
                        installmentFields.style.display = 'none';
                    }
                    renderSaleItems();
                    updateSaleTotal();
                }
            } else {
                document.getElementById('saleModalTitle').innerHTML = '<i class="fas fa-cash-register"></i> Registrar Nova Venda';
                document.getElementById('finalizeSaleBtn').innerText = 'Finalizar Venda';
                appData.currentSale.id = null; // Garante que é uma nova venda
            }
            openModal('saleModal');
        }

        function confirmDeleteSale(id) {
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').textContent = `Tem certeza que deseja excluir a venda #V${id.toString().padStart(4, '0')}? Esta ação não pode ser desfeita e o estoque não será restaurado.`;
            document.getElementById('confirmActionBtn').onclick = () => deleteSale(id);
        }

        async function deleteSale(id) {
            const saleToDelete = appData.sales.find(s => s.id === id);
            if (saleToDelete) {
                // Ao excluir uma venda, o estoque dos itens vendidos deve ser restaurado.
                for (const item of saleToDelete.items) {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        if (item.variationId && product.hasVariations) {
                            const variation = product.variations.find(v => v.id === item.variationId);
                            if (variation) {
                                variation.stock += item.quantity;
                            }
                        } else {
                            product.stock += item.quantity;
                        }
                        await saveDataToIndexedDB('products', product);
                    }
                }
            }

            appData.sales = appData.sales.filter(sale => sale.id !== id);
            await deleteDataFromIndexedDB('sales', id);
            showMessage('success', 'Venda excluída com sucesso! Estoque restaurado.');
            closeModal(); // Fecha o modal de confirmação
            renderSales();
            renderProducts(); // Atualiza a lista de produtos para refletir mudanças no estoque
            // CHAMA O BACKUP AUTOMÁTICO APENAS UMA VEZ AQUI
            await performAutomaticLocalBackup();
        }

        function populateProductDropdown(searchTerm = '') {
            const select = document.getElementById('saleProduct');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecione um produto</option>';
            
            const filteredProducts = appData.products.filter(product => {
                if (!searchTerm) return true;
                const searchLower = searchTerm.toLowerCase();
                return product.name.toLowerCase().includes(searchLower) || 
                       product.sku.toLowerCase().includes(searchLower) ||
                       product.category.toLowerCase().includes(searchLower);
            });
            
            filteredProducts.forEach(product => {
                const totalStock = getTotalProductStock(product);
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - R$ ${product.price.toFixed(2)} (Estoque: ${totalStock})`;
                select.appendChild(option);
            });
        }
        
        function filterProductDropdown() {
            const searchTerm = document.getElementById('productSearchInput').value;
            populateProductDropdown(searchTerm);
        }
        
        function loadProductVariations() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const variationSelection = document.getElementById('variationSelection');
            const variationSelect = document.getElementById('saleVariation');
            
            if (!productId) {
                variationSelection.style.display = 'none';
                return;
            }
            
            const product = appData.products.find(p => p.id === productId);
            if (!product || !product.hasVariations || !product.variations) {
                variationSelection.style.display = 'none';
                return;
            }
            
            variationSelection.style.display = 'block';
            variationSelect.innerHTML = '<option value="">Selecione uma variação</option>';
            
            product.variations.filter(v => v.active && v.stock > 0).forEach(variation => {
                const option = document.createElement('option');
                option.value = variation.id;
                const price = variation.price || product.price;
                option.textContent = `${variation.color} - ${variation.size} (R$ ${price.toFixed(2)}, Estoque: ${variation.stock})`;
                variationSelect.appendChild(option);
            });
        }

        function addSaleItem() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const variationId = document.getElementById('saleVariation').value;
            
            if (!productId || isNaN(quantity) || quantity <= 0) {
                showMessage('error', 'Selecione um produto e informe uma quantidade válida!');
                return;
            }
            
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            let variation = null;
            let availableStock = 0;
            let itemPrice = product.price;
            let itemName = product.name;
            let itemKey = `${productId}`;
            
            if (product.hasVariations) {
                if (!variationId) {
                    showMessage('error', 'Selecione uma variação para este produto!');
                    return;
                }
                
                variation = product.variations.find(v => v.id == variationId);
                if (!variation || !variation.active) {
                    showMessage('error', 'Variação inválida!');
                    return;
                }
                
                availableStock = variation.stock;
                itemPrice = variation.price || product.price;
                itemName = `${product.name} (${variation.color} - ${variation.size})`;
                itemKey = `${productId}-${variationId}`;
            } else {
                availableStock = product.stock;
            }
            
            // Calcula o estoque disponível considerando o que já está na venda atual
            const currentQuantityInSale = appData.currentSale.items.find(item => item.itemKey === itemKey)?.quantity || 0;
            if (availableStock < (quantity + currentQuantityInSale)) {
                showMessage('error', `Estoque insuficiente! Disponível: ${availableStock - currentQuantityInSale}`);
                return;
            }

            // Verifica se o item já existe na venda atual, se sim, atualiza a quantidade
            const existingItem = appData.currentSale.items.find(item => item.itemKey === itemKey);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                appData.currentSale.items.push({
                    productId: product.id,
                    variationId: variation ? variation.id : null,
                    name: itemName,
                    quantity: quantity,
                    price: itemPrice,
                    itemKey: itemKey
                });
            }
            
            // Limpa a seleção
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleVariation').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('variationSelection').style.display = 'none';
            
            renderSaleItems();
            updateSaleTotal();
        }

        function renderSaleItems() {
            const saleItemsList = document.getElementById('saleItemsList');
            saleItemsList.innerHTML = '';
            
            if (appData.currentSale.items.length === 0) {
                saleItemsList.innerHTML = '<p style="text-align: center; color: var(--secondary); padding: 1rem;">Nenhum item adicionado</p>';
                return;
            }
            
            appData.currentSale.items.forEach((item, index) => {
                const product = appData.products.find(p => p.id === item.productId);
                const productImage = getProductDisplayImage(product);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sale-item';
                itemDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.8rem; flex: 1;">
                        <div style="width: 40px; height: 40px; border-radius: 5px; overflow: hidden; background: var(--primary-light); display: flex; align-items: center; justify-content: center;">
                            ${productImage ? 
                                `<img src="${productImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                `<i class="${getProductIcon(product?.category || '')}" style="color: var(--primary); font-size: 1.2rem;"></i>`
                            }
                        </div>
                        <div class="sale-item-info">
                            <div>${item.name}</div>
                            <div style="font-size: 0.85rem; color: var(--secondary);">${item.quantity} x R$ ${item.price.toFixed(2)} = R$ ${(item.quantity * item.price).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="sale-item-actions">
                        <button class="action-btn btn-danger" onclick="removeSaleItem(${index})" aria-label="Remover item ${item.name}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                saleItemsList.appendChild(itemDiv);
            });
        }

        function removeSaleItem(index) {
            appData.currentSale.items.splice(index, 1);
            renderSaleItems();
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const total = appData.currentSale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('saleTotal').textContent = total.toFixed(2);
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            if (paymentMethod === 'installment') {
                const count = parseInt(document.getElementById('installmentCount').value) || 1;
                const interest = parseFloat(document.getElementById('installmentInterest').value) || 0;
                
                const interestFactor = 1 + (interest / 100);
                const installmentValue = (total * interestFactor) / count;
                document.getElementById('installmentValue').textContent = installmentValue.toFixed(2);
            } else {
                document.getElementById('installmentValue').textContent = '0.00';
            }
        }

        document.getElementById('paymentMethod').addEventListener('change', function() {
            const installmentFields = document.getElementById('installmentFields');
            if (this.value === 'installment') {
                installmentFields.style.display = 'block';
            } else {
                installmentFields.style.display = 'none';
            }
            updateSaleTotal();
        });

        document.getElementById('installmentCount').addEventListener('change', updateSaleTotal);
        document.getElementById('installmentInterest').addEventListener('change', updateSaleTotal);

        /**
         * Retorna a data atual no formato 'YYYY-MM-DD' no fuso horário local.
         * @returns {string} Data formatada.
         */
        function getLocalDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Meses são 0-indexados
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function finalizeSale() {
            const customer = document.getElementById('saleCustomer').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;
            const installmentCount = parseInt(document.getElementById('installmentCount').value) || 1;
            const interest = parseFloat(document.getElementById('installmentInterest').value) || 0;
            
            if (appData.currentSale.items.length === 0) {
                showMessage('error', 'Adicione pelo menos um item à venda!');
                return;
            }
            
            if (!customer) {
                showMessage('error', 'Informe o nome do cliente!');
                return;
            }
            
            const total = appData.currentSale.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalWithInterest = paymentMethod === 'installment' ? total * (1 + interest/100) : total;
            
            // Lógica de ajuste de estoque para edição de venda
            if (appData.currentSale.id) { // Editando venda existente
                // Reverte o estoque dos itens originais
                for (const originalItem of appData.currentSale.originalItems) {
                    const product = appData.products.find(p => p.id === originalItem.productId);
                    if (product) {
                        if (originalItem.variationId && product.hasVariations) {
                            const variation = product.variations.find(v => v.id === originalItem.variationId);
                            if (variation) {
                                variation.stock += originalItem.quantity;
                            }
                        } else {
                            product.stock += originalItem.quantity;
                        }
                        await saveDataToIndexedDB('products', product);
                    }
                }
                // Aplica o estoque dos novos (ou modificados) itens
                for (const newItem of appData.currentSale.items) {
                    const product = appData.products.find(p => p.id === newItem.productId);
                    if (product) {
                        if (newItem.variationId && product.hasVariations) {
                            const variation = product.variations.find(v => v.id === newItem.variationId);
                            if (variation) {
                                variation.stock -= newItem.quantity;
                            }
                        } else {
                            product.stock -= newItem.quantity;
                        }
                        await saveDataToIndexedDB('products', product);
                    }
                }
            } else { // Nova venda
                // Atualiza o estoque para uma nova venda
                for (const item of appData.currentSale.items) {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        if (item.variationId && product.hasVariations) {
                            const variation = product.variations.find(v => v.id === item.variationId);
                            if (variation) {
                                variation.stock -= item.quantity;
                            }
                        } else {
                            product.stock -= item.quantity;
                        }
                        await saveDataToIndexedDB('products', product);
                    }
                }
            }
            
            let saleToSave;
            if (appData.currentSale.id) { // Editando venda existente
                saleToSave = appData.sales.find(s => s.id === appData.currentSale.id);
                if (saleToSave) {
                    saleToSave = {
                        ...saleToSave,
                        customer: customer,
                        amount: totalWithInterest,
                        payment: paymentMethod === 'cash' ? 'À Vista' : 
                                 paymentMethod === 'credit' ? 'Crédito' : 
                                 `Parcelado (${installmentCount}x)`,
                        paymentMethod: paymentMethod,
                        installments: installmentCount,
                        interest: interest,
                        status: paymentMethod === 'cash' || paymentMethod === 'credit' ? 'paid' : 'pending',
                        items: [...appData.currentSale.items]
                    };
                    // Atualiza a venda existente no array appData.sales
                    const index = appData.sales.findIndex(s => s.id === saleToSave.id);
                    if (index !== -1) appData.sales[index] = saleToSave;
                }
            } else { // Nova venda
                const newId = await getNextId('sales');
                saleToSave = {
                    id: newId,
                    date: getLocalDateString(), // Usando a função para obter a data local
                    customer: customer,
                    amount: totalWithInterest,
                    payment: paymentMethod === 'cash' ? 'À Vista' : 
                             paymentMethod === 'credit' ? 'Crédito' : 
                             `Parcelado (${installmentCount}x)`,
                    paymentMethod: paymentMethod,
                    installments: installmentCount,
                    interest: interest,
                    status: paymentMethod === 'cash' || paymentMethod === 'credit' ? 'paid' : 'pending',
                    items: [...appData.currentSale.items]
                };
                appData.sales.push(saleToSave);
            }

            // Gera a lista de parcelas se o pagamento for parcelado e ainda não gerado ou se a venda foi editada e as parcelas precisam ser recalculadas
            if (saleToSave.paymentMethod === 'installment') {
                saleToSave.installmentList = []; // Recria a lista de parcelas para garantir consistência
                // Ao criar a data para cálculo das parcelas, garanta que seja interpretada como local
                const saleDateForInstallment = new Date(saleToSave.date + 'T00:00:00'); 
                const installmentValue = saleToSave.amount / saleToSave.installments;
                
                for (let i = 1; i <= saleToSave.installments; i++) {
                    const dueDate = new Date(saleDateForInstallment); // Clona a data para evitar mutação
                    dueDate.setMonth(saleDateForInstallment.getMonth() + i);
                    
                    saleToSave.installmentList.push({
                        number: i,
                        dueDate: dueDate.toLocaleDateString('pt-BR'), // Formato de exibição
                        amount: installmentValue,
                        status: 'pending',
                        paymentDate: null
                    });
                }
            } else {
                saleToSave.installmentList = []; // Garante que não há lista de parcelas para vendas não parceladas
            }
            
            await saveDataToIndexedDB('sales', saleToSave); // Salva a nova/atualizada venda no DB
            
            // Limpa o carrinho se a venda foi criada a partir dos itens do carrinho
            if (!appData.currentSale.id && appData.cart.length > 0) {
                appData.cart = [];
                updateCartDisplay();
            }
            
            showMessage('success', `Venda ${appData.currentSale.id ? 'atualizada' : 'registrada'} com sucesso!`);
            closeModal();
            renderProducts(); // Renderiza novamente os produtos para mostrar o estoque atualizado
            renderSales();
            renderStockMovements(); // Atualiza o relatório de movimentação de estoque
            renderFinancialReport(); // Atualiza o relatório financeiro
            // CHAMA O BACKUP AUTOMÁTICO APENAS UMA VEZ AQUI
            await performAutomaticLocalBackup();
        }

        function resetSaleForm() {
            appData.currentSale = {
                id: null,
                items: [],
                originalItems: [],
                customer: '',
                paymentMethod: 'cash',
                installments: 1,
                interest: 0
            };
            
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('installmentCount').value = '2';
            document.getElementById('installmentInterest').value = '0';
            document.getElementById('saleTotal').textContent = '0.00';
            document.getElementById('installmentValue').textContent = '0.00';
            
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) searchInput.value = '';
            
            document.getElementById('installmentFields').style.display = 'none';
            renderSaleItems();
        }

        /**
         * Abre o modal de detalhes da venda (substitui o modal de parcelas).
         * @param {number} saleId O ID da venda para exibir os detalhes.
         */
        async function openSaleDetailsModal(saleId) {
            // Recarrega as vendas do IndexedDB para garantir dados atualizados
            appData.sales = await loadDataFromIndexedDB('sales');
            const sale = appData.sales.find(s => s.id === saleId);
            if (!sale) return;
            
            appData.currentSaleDetails = sale; // Define a venda atual para detalhes
            
            // Preenche o resumo da venda
            document.getElementById('saleOverviewDetails').innerHTML = `
                <div><strong>ID:</strong> #V${sale.id.toString().padStart(4, '0')}</div>
                <div><strong>Data:</strong> ${new Date(sale.date + 'T00:00:00').toLocaleDateString('pt-BR')}</div> <!-- CORREÇÃO AQUI -->
                <div><strong>Cliente:</strong> ${sale.customer}</div>
                <div><strong>Total:</strong> R$ ${sale.amount.toFixed(2)}</div>
                <div><strong>Forma de Pagamento:</strong> ${sale.payment}</div>
                ${sale.paymentMethod === 'installment' ? `
                    <div><strong>Parcelas:</strong> ${sale.installments}x</div>
                    <div><strong>Juros:</strong> ${sale.interest}%</div>
                ` : ''}
                <div><strong>Status:</strong> ${sale.status === 'paid' ? 'Pago' : sale.status === 'pending' ? 'Pendente' : 'Atrasado'}</div>
            `;

            // Preenche os itens da venda
            const saleItemsDetailList = document.getElementById('saleItemsDetailList');
            saleItemsDetailList.innerHTML = '';
            if (sale.items && sale.items.length > 0) {
                sale.items.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${item.name} (${item.quantity}x)</span>
                        <span class="item-price">R$ ${(item.quantity * item.price).toFixed(2)}</span>
                    `;
                    saleItemsDetailList.appendChild(li);
                });
            } else {
                saleItemsDetailList.innerHTML = '<li>Nenhum item registrado para esta venda.</li>';
            }

            // Preenche e exibe as parcelas (se for venda parcelada)
            const saleInstallmentsDetailSection = document.getElementById('saleInstallmentsDetailSection');
            const paymentHistorySection = document.getElementById('paymentHistorySection');

            if (sale.paymentMethod === 'installment' && sale.installmentList) {
                saleInstallmentsDetailSection.style.display = 'block';
                paymentHistorySection.style.display = 'block';
                renderInstallments(sale); // Passa a venda para a função de renderização
                renderPaymentHistory(sale); // Passa a venda para a função de histórico
            } else {
                saleInstallmentsDetailSection.style.display = 'none';
                paymentHistorySection.style.display = 'none';
            }
            
            openModal('saleDetailsModal');
        }

        /**
         * Renderiza as parcelas no modal de detalhes da venda.
         * @param {Object} sale A venda cujas parcelas serão renderizadas.
         */
        function renderInstallments(sale) {
            const installmentListEl = document.getElementById('installmentList');
            installmentListEl.innerHTML = '';
            
            if (!sale || !sale.installmentList) return;

            const today = new Date();
            let allInstallmentsPaid = true;

            sale.installmentList.forEach((installment, index) => {
                const row = document.createElement('tr');
                
                let statusBadge;
                let actualStatus = installment.status;

                // Verifica o status de atraso
                // Converte a data de vencimento para um objeto Date para comparação
                const dueDateParts = installment.dueDate.split('/');
                const dueDateObject = new Date(parseInt(dueDateParts[2]), parseInt(dueDateParts[1]) - 1, parseInt(dueDateParts[0]));
                
                if (actualStatus === 'pending' && dueDateObject < today) {
                    actualStatus = 'overdue';
                }

                if (actualStatus !== 'paid') {
                    allInstallmentsPaid = false;
                }

                switch(actualStatus) {
                    case 'paid': statusBadge = '<span class="status-badge status-paid">Pago</span>'; break;
                    case 'pending': statusBadge = '<span class="status-badge status-pending">Pendente</span>'; break;
                    case 'overdue': statusBadge = '<span class="status-badge status-overdue">Atrasado</span>'; break;
                    default: statusBadge = '<span class="status-badge">Desconhecido</span>';
                }
                
                row.innerHTML = `
                    <td>${installment.number}</td>
                    <td>${installment.dueDate}</td>
                    <td>R$ ${installment.amount.toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${installment.status === 'pending' ? 
                            `<button class="action-btn btn-success" onclick="payInstallment(${sale.id}, ${index})" aria-label="Pagar parcela ${installment.number}">
                                <i class="fas fa-check"></i> Pagar
                            </button>` : 
                            `<span>Pago em ${installment.paymentDate}</span>`
                        }
                    </td>
                `;
                installmentListEl.appendChild(row);
            });

            // Atualiza o status da venda principal se todas as parcelas estiverem pagas
            if (allInstallmentsPaid && sale.status !== 'paid') {
                sale.status = 'paid';

                // Atualiza a venda no array appData.sales para manter a consistência
                const saleIndex = appData.sales.findIndex(s => s.id === sale.id);
                if (saleIndex !== -1) {
                    appData.sales[saleIndex] = { ...sale };
                }

                saveDataToIndexedDB('sales', sale); // Esta chamada não vai disparar backup automático agora
                renderSales(); // Renderiza novamente a tabela de vendas principal para mostrar o status atualizado
            } else if (!allInstallmentsPaid && sale.status === 'paid') {
                // Este cenário lida se uma parcela paga for de alguma forma "despaga", embora a UI atual não permita
                // Verifica se há alguma parcela pendente ou atrasada para reverter o status para 'pending'
                const hasUnpaidInstallments = sale.installmentList.some(inst => inst.status !== 'paid');
                if (hasUnpaidInstallments) {
                    sale.status = 'pending'; // Ou 'overdue' se houver atrasadas, mas a renderSales já cuida disso
                }
                

                // Atualiza a venda no array appData.sales para manter a consistência
                const saleIndex = appData.sales.findIndex(s => s.id === sale.id);
                if (saleIndex !== -1) {
                    appData.sales[saleIndex] = { ...sale };
                }

                saveDataToIndexedDB('sales', sale); // Esta chamada não vai disparar backup automático agora
                renderSales();
            }
            
            // Não chame renderPaymentHistory() aqui, pois já é chamado por openSaleDetailsModal
        }

        /**
         * Marca uma parcela como paga.
         * @param {number} saleId O ID da venda à qual a parcela pertence.
         * @param {number} installmentIndex O índice da parcela na lista.
         */
        async function payInstallment(saleId, installmentIndex) {
            // Recarrega a venda específica para garantir que estamos trabalhando com os dados mais recentes
            const sale = appData.sales.find(s => s.id === saleId);
            if (!sale || !sale.installmentList || !sale.installmentList[installmentIndex]) return;
            
            const today = new Date();
            const paymentDate = today.toLocaleDateString('pt-BR');
            
            sale.installmentList[installmentIndex].status = 'paid';
            sale.installmentList[installmentIndex].paymentDate = paymentDate;

            // Atualiza a venda no IndexedDB
            await saveDataToIndexedDB('sales', sale);

            // Recarrega todas as vendas para garantir que appData.sales esteja sincronizado
            appData.sales = await loadDataFromIndexedDB('sales');
            // Atualiza appData.currentSaleDetails para refletir a alteração no modal aberto
            appData.currentSaleDetails = appData.sales.find(s => s.id === saleId);

            showMessage('success', `Parcela ${installmentIndex + 1} marcada como paga!`);
            renderInstallments(appData.currentSaleDetails); // Renderiza novamente as parcelas no modal
            renderPaymentHistory(appData.currentSaleDetails); // Atualiza o histórico de pagamento
            
            updateDashboard(); // Atualiza o dashboard para recalcular a receita pendente
            // CHAMA O BACKUP AUTOMÁTICO APENAS UMA VEZ AQUI
            await performAutomaticLocalBackup();
        }

        /**
         * Renderiza o histórico de pagamentos no modal de detalhes da venda.
         * @param {Object} sale A venda cujo histórico de pagamentos será renderizado.
         */
        function renderPaymentHistory(sale) {
            const paymentHistory = document.getElementById('paymentHistory');
            paymentHistory.innerHTML = '';
            
            if (!sale || !sale.installmentList) {
                paymentHistory.innerHTML = '<p>Nenhum histórico de pagamento disponível.</p>';
                return;
            }

            const payments = sale.installmentList.filter(i => i.status === 'paid');
            
            if (payments.length === 0) {
                paymentHistory.innerHTML = '<p style="text-align: center; color: var(--secondary); padding: 1rem;">Nenhum pagamento registrado ainda.</p>';
            } else {
                payments.forEach(payment => {
                    const paymentDiv = document.createElement('div');
                    paymentDiv.className = 'sale-item';
                    paymentDiv.innerHTML = `
                        <div><strong>Parcela ${payment.number}:</strong> R$ ${payment.amount.toFixed(2)}</div>
                        <div><strong>Data de pagamento:</strong> ${payment.paymentDate}</div>
                    `;
                    paymentHistory.appendChild(paymentDiv);
                });
            }
        }

        // --- Backup (Simulado) - Mantido para a seção de backup original, mas as novas funções são para backup local real ---
        function openBackupModal() {
            updateBackupHistoryDisplay();
            openModal('backupModal');
        }

        async function performBackup() {
            const now = new Date();
            const backupTime = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const service = document.getElementById('backupService').value;

            // Simula o cálculo do tamanho (estimativa muito aproximada)
            const dataSize = JSON.stringify(appData.products).length + JSON.stringify(appData.sales).length;
            const sizeMB = (dataSize / (1024 * 1024)).toFixed(2);

            const backupRecord = {
                id: appData.backupHistory.length > 0 ? Math.max(...appData.backupHistory.map(b => b.id)) + 1 : 1,
                date: backupTime,
                size: sizeMB + 'MB',
                service: service
            };
            appData.backupHistory.push(backupRecord);
            await saveDataToIndexedDB('backupHistory', backupRecord); // Esta chamada não vai disparar backup automático agora

            document.getElementById('backupTime').textContent = backupTime;
            document.getElementById('storageUsage').textContent = `${sizeMB}MB`;
            
            showMessage('success', 'Backup realizado com sucesso!');
            updateBackupHistoryDisplay();
            closeModal();
        }

        function updateBackupHistoryDisplay() {
            const backupHistoryList = document.getElementById('backupHistory');
            backupHistoryList.innerHTML = '';
            if (appData.backupHistory.length === 0) {
                backupHistoryList.innerHTML = '<li>Nenhum backup registrado ainda.</li>';
            } else {
                appData.backupHistory.sort((a, b) => new Date(b.date.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00')) - new Date(a.date.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:00'))).forEach(backup => {
                    const li = document.createElement('li');
                    li.textContent = `${backup.date} - ${backup.size} (${backup.service})`;
                    backupHistoryList.appendChild(li);
                });
            }
        }

        // --- Funções de Exportação/Importação/Backup Automático Local ---

        /**
         * Exporta todos os dados do IndexedDB para um arquivo JSON.
         * @param {string} [filenamePrefix='angeli_data'] Prefixo para o nome do arquivo.
         */
        async function exportAllData(filenamePrefix = 'angeli_data') {
            try {
                // REMOVIDO: showMessage('info', 'Preparando dados para exportação...'); para evitar duplicação
                const allProducts = await loadDataFromIndexedDB('products');
                const allSales = await loadDataFromIndexedDB('sales');
                const allCategories = await loadDataFromIndexedDB('categories');
                const allAppSettings = await loadDataFromIndexedDB('appSettings');
                const allBackupHistory = await loadDataFromIndexedDB('backupHistory');
                const allStockMovements = await loadDataFromIndexedDB('stockMovements');

                const dataToExport = {
                    products: allProducts,
                    sales: allSales,
                    categories: allCategories,
                    appSettings: allAppSettings,
                    backupHistory: allBackupHistory,
                    stockMovements: allStockMovements
                };

                const jsonString = JSON.stringify(dataToExport, null, 2); // Formata com indentação para legibilidade
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.-]/g, ''); // YYYY-MM-DDTHH:mm:ss.sssZ -> YYYYMMDDTHHmmss
                a.download = `${filenamePrefix}_${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // showMessage('success', 'Dados exportados com sucesso!'); // REMOVIDO: para evitar duplicação
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showMessage('error', 'Falha ao exportar dados. Verifique o console para detalhes.');
            }
        }

        /**
         * Lida com a seleção do arquivo JSON para importação.
         * @param {Event} event O evento de mudança do input de arquivo.
         */
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (file.name.toLowerCase().endsWith('.zip')) {
                await handleZipImport(file);
                return;
            }
            
            if (file.type !== 'application/json') {
                showMessage('error', 'Por favor, selecione um arquivo JSON válido.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    confirmImportData(importedData);
                } catch (error) {
                    console.error('Erro ao ler ou analisar o arquivo JSON:', error);
                    showMessage('error', 'Erro ao ler o arquivo. Certifique-se de que é um JSON válido.');
                }
            };
            reader.readAsText(file);
        }
        
        async function handleZipImport(file) {
            try {
                showMessage('info', 'Processando arquivo ZIP...');
                
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                
                const dataFile = zipContent.file('dados.json');
                if (!dataFile) {
                    showMessage('error', 'Arquivo ZIP inválido: dados.json não encontrado.');
                    return;
                }
                
                const jsonData = await dataFile.async('text');
                const importedData = JSON.parse(jsonData);
                
                const imagesFolder = zipContent.folder('imagens');
                const imageMap = {};
                
                if (imagesFolder) {
                    for (const [filename, fileObj] of Object.entries(imagesFolder.files)) {
                        if (!fileObj.dir) {
                            const imageData = await fileObj.async('base64');
                            const mimeType = filename.toLowerCase().endsWith('.png') ? 'image/png' : 'image/jpeg';
                            imageMap[filename] = `data:${mimeType};base64,${imageData}`;
                        }
                    }
                }
                
                if (importedData.products) {
                    importedData.products.forEach(product => {
                        const mainImageKey = `produto_${product.id}_principal.jpg`;
                        if (imageMap[mainImageKey]) {
                            product.image = imageMap[mainImageKey];
                            console.log(`Imagem principal restaurada para produto ${product.id}`);
                        }
                        
                        product.images = product.images || [];
                        let galleryIndex = 1;
                        while (true) {
                            const galleryKey = `produto_${product.id}_galeria_${galleryIndex}.jpg`;
                            if (imageMap[galleryKey]) {
                                if (!product.images) product.images = [];
                                product.images.push(imageMap[galleryKey]);
                                console.log(`Imagem da galeria ${galleryIndex} restaurada para produto ${product.id}`);
                                galleryIndex++;
                            } else {
                                break;
                            }
                        }
                        
                        if (product.variations) {
                            product.variations.forEach((variation, vIndex) => {
                                const variationKey = `produto_${product.id}_variacao_${vIndex + 1}.jpg`;
                                if (imageMap[variationKey]) {
                                    variation.image = imageMap[variationKey];
                                    console.log(`Imagem da variação ${vIndex + 1} restaurada para produto ${product.id}`);
                                }
                            });
                        }
                    });
                }
                
                // Salva os produtos com imagens no banco de dados imediatamente
                if (importedData.products) {
                    for (const product of importedData.products) {
                        await saveDataToIndexedDB('products', product);
                    }
                }
                
                confirmImportData(importedData);
                const imageCount = Object.keys(imageMap).length;
                showMessage('success', `Backup ZIP processado! ${imageCount} imagens restauradas.`);
                
                // Força a renderização dos produtos para mostrar as imagens
                setTimeout(() => {
                    renderProducts();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao importar ZIP:', error);
                showMessage('error', 'Erro ao importar ZIP. Verifique se o arquivo é válido.');
            }
        }

        /**
         * Exibe um modal de confirmação antes de importar os dados.
         * @param {Object} data Os dados JSON a serem importados.
         */
        function confirmImportData(data) {
            document.getElementById('confirmationModal').classList.add('active');
            document.getElementById('confirmationMessage').innerHTML = `
                Tem certeza que deseja importar estes dados?
                <br>
                <strong>Isso substituirá todos os seus dados atuais (Produtos, Vendas, Configurações).</strong>
                <br>
                Recomendamos que você <span style="font-weight: bold; color: var(--info);">exporte seus dados atuais</span> antes de prosseguir.
            `;
            document.getElementById('confirmActionBtn').onclick = () => importData(data);
            document.getElementById('confirmActionBtn').classList.remove('btn-danger');
            document.getElementById('confirmActionBtn').classList.add('btn-warning');
            document.getElementById('confirmActionBtn').textContent = 'Sim, Importar';
        }

        /**
         * Importa os dados para o IndexedDB após confirmação.
         * @param {Object} importedData Os dados JSON a serem importados.
         */
        async function importData(importedData) {
            closeModal(); // Fecha o modal de confirmação
            showMessage('info', 'Iniciando importação de dados...');

            try {
                // Limpa os object stores existentes
                await clearObjectStore('products');
                await clearObjectStore('sales');
                await clearObjectStore('categories');
                await clearObjectStore('appSettings');
                await clearObjectStore('backupHistory');
                await clearObjectStore('stockMovements');

                // Insere os novos dados
                if (importedData.products && Array.isArray(importedData.products)) {
                    for (const product of importedData.products) {
                        await saveDataToIndexedDB('products', product);
                    }
                }
                if (importedData.sales && Array.isArray(importedData.sales)) {
                    for (const sale of importedData.sales) {
                        await saveDataToIndexedDB('sales', sale);
                    }
                }
                if (importedData.categories && Array.isArray(importedData.categories)) {
                    for (const category of importedData.categories) {
                        await saveDataToIndexedDB('categories', category);
                    }
                }
                if (importedData.appSettings && Array.isArray(importedData.appSettings)) {
                    for (const setting of importedData.appSettings) {
                        await saveDataToIndexedDB('appSettings', setting);
                    }
                }
                if (importedData.backupHistory && Array.isArray(importedData.backupHistory)) {
                    for (const backup of importedData.backupHistory) {
                        await saveDataToIndexedDB('backupHistory', backup);
                    }
                }
                if (importedData.stockMovements && Array.isArray(importedData.stockMovements)) {
                    for (const movement of importedData.stockMovements) {
                        await saveDataToIndexedDB('stockMovements', movement);
                    }
                }

                // Recarrega todos os dados e renderiza a UI
                await loadAllDataAndRender();
                showMessage('success', 'Dados importados com sucesso!');
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                showMessage('error', 'Falha ao importar dados. Alguns dados podem estar corrompidos.');
            } finally {
                // Limpa o input de arquivo para permitir nova seleção
                document.getElementById('importFileInput').value = '';
                // Restaura o botão de confirmação
                document.getElementById('confirmActionBtn').classList.remove('btn-warning');
                document.getElementById('confirmActionBtn').classList.add('btn-danger');
                document.getElementById('confirmActionBtn').textContent = 'Confirmar';
            }
        }

        /**
         * Ativa/Desativa o backup automático local.
         */
        function toggleAutoBackup() {
            const isEnabled = document.getElementById('autoBackupToggle').checked;
            saveAppSetting('autoBackupEnabled', isEnabled);
            if (isEnabled) {
                showMessage('info', 'Backup automático local ativado. Um arquivo será baixado para o seu dispositivo após cada alteração.');
            } else {
                showMessage('info', 'Backup automático local desativado.');
            }
        }

        /**
         * Realiza um backup automático local se a opção estiver ativada.
         */
        // --- Exportação ZIP Completa ---
        async function exportBackupZip() {
            try {
                showMessage('info', 'Preparando backup completo...');
                
                const zip = new JSZip();
                
                // Adiciona dados JSON
                const allData = {
                    products: appData.products,
                    sales: appData.sales,
                    categories: appData.categories,
                    settings: appData.settings,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                zip.file('dados.json', JSON.stringify(allData, null, 2));
                
                // Adiciona fotos dos produtos
                const imagesFolder = zip.folder('imagens');
                let imageCount = 0;
                
                for (const product of appData.products) {
                    // Imagem principal
                    if (product.image) {
                        const imageData = product.image.split(',')[1];
                        imagesFolder.file(`produto_${product.id}_principal.jpg`, imageData, {base64: true});
                        imageCount++;
                    }
                    
                    // Galeria de imagens
                    if (product.images && product.images.length > 0) {
                        product.images.forEach((img, index) => {
                            const imageData = img.split(',')[1];
                            imagesFolder.file(`produto_${product.id}_galeria_${index + 1}.jpg`, imageData, {base64: true});
                            imageCount++;
                        });
                    }
                    
                    // Imagens das variações
                    if (product.variations && product.variations.length > 0) {
                        product.variations.forEach((variation, vIndex) => {
                            if (variation.image) {
                                const imageData = variation.image.split(',')[1];
                                imagesFolder.file(`produto_${product.id}_variacao_${vIndex + 1}.jpg`, imageData, {base64: true});
                                imageCount++;
                            }
                        });
                    }
                }
                
                // Gera o arquivo ZIP
                const content = await zip.generateAsync({type: 'blob'});
                
                // Download do arquivo
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `angeli_backup_completo_${timestamp}.zip`;
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                showMessage('success', `Backup completo criado! ${imageCount} imagens incluídas.`);
                
            } catch (error) {
                console.error('Erro ao criar backup ZIP:', error);
                showMessage('error', 'Erro ao criar backup ZIP. Verifique o console.');
            }
        }
        
        async function performAutomaticLocalBackup() {
            if (appData.settings.autoBackupEnabled) {
                console.log('Realizando backup automático local...');
                // Usamos um pequeno atraso para não sobrecarregar o navegador com downloads muito rápidos
                // e para dar tempo para a operação principal do IndexedDB ser concluída.
                setTimeout(async () => { // Adicionado async aqui para o await
                    await exportAllData('angeli_auto_backup'); // Aguarda a exportação
                    showMessage('info', 'Backup automático local realizado.');
                }, 500); 
            }
        }

        // --- Exportação para CSV ---
        async function exportAllToCSV() {
            try {
                showMessage('info', 'Preparando dados para exportação CSV...');

                const allProducts = await loadDataFromIndexedDB('products');
                const allSales = await loadDataFromIndexedDB('sales');

                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.-]/g, '');

                // 1. Exportar Produtos para CSV
                let productsCsv = "ID Produto,Nome,SKU,Categoria,Preço,Estoque,Descrição\n";
                allProducts.forEach(p => {
                    productsCsv += `${p.id},"${p.name.replace(/"/g, '""')}","${p.sku.replace(/"/g, '""')}","${p.category.replace(/"/g, '""')}",${p.price.toFixed(2)},${p.stock},"${(p.description || '').replace(/"/g, '""')}"\n`;
                });
                downloadCSV(productsCsv, `angeli_produtos_${timestamp}.csv`);

                // 2. Exportar Resumo de Vendas para CSV
                let salesSummaryCsv = "ID Venda,Data,Cliente,Valor Total,Forma Pagamento,Status,Num. Parcelas,Juros (%),Num. Itens\n";
                allSales.forEach(s => {
                    const numItems = s.items ? s.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
                    salesSummaryCsv += `${s.id},${new Date(s.date + 'T00:00:00').toLocaleDateString('pt-BR')},"${s.customer.replace(/"/g, '""')}",${s.amount.toFixed(2)},"${s.payment.replace(/"/g, '""')}",${s.status},${s.installments || 1},${s.interest || 0},${numItems}\n`; // CORREÇÃO AQUI
                });
                downloadCSV(salesSummaryCsv, `angeli_vendas_resumo_${timestamp}.csv`);

                // 3. Exportar Detalhes de Itens de Venda para CSV
                let salesItemsCsv = "ID Venda,Nome Produto,Quantidade,Preco Unitario,Preco Total Item\n";
                allSales.forEach(s => {
                    if (s.items) {
                        s.items.forEach(item => {
                            salesItemsCsv += `${s.id},"${item.name.replace(/"/g, '""')}",${item.quantity},${item.price.toFixed(2)},${(item.quantity * item.price).toFixed(2)}\n`;
                        });
                    }
                });
                downloadCSV(salesItemsCsv, `angeli_vendas_detalhes_itens_${timestamp}.csv`);

                // 4. Exportar Parcelas Pendentes para CSV
                let pendingInstallmentsCsv = "ID Venda,Cliente,Num. Parcela,Vencimento,Valor Parcela,Status\n";
                allSales.forEach(s => {
                    if (s.paymentMethod === 'installment' && s.installmentList) {
                        s.installmentList.forEach(installment => {
                            if (installment.status !== 'paid') { // Apenas parcelas não pagas
                                pendingInstallmentsCsv += `${s.id},"${s.customer.replace(/"/g, '""')}",${installment.number},${installment.dueDate},${installment.amount.toFixed(2)},${installment.status}\n`;
                            }
                        });
                    }
                });
                downloadCSV(pendingInstallmentsCsv, `angeli_parcelas_pendentes_${timestamp}.csv`);

                showMessage('success', 'Dados exportados para CSV com sucesso! Verifique sua pasta de downloads.');

            } catch (error) {
                console.error('Erro ao exportar para CSV:', error);
                showMessage('error', 'Falha ao exportar para CSV. Verifique o console para detalhes.');
            }
        }

        /**
         * Função auxiliar para baixar um arquivo CSV.
         * @param {string} csvString O conteúdo CSV.
         * @param {string} filename O nome do arquivo.
         */
        function downloadCSV(csvString, filename) {
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Geração de Relatórios ---
        function generateReport() {
            showMessage('info', 'Gerando relatório... Isso pode levar alguns segundos.');
            initCharts(); // Garante que os gráficos sejam atualizados com os dados mais recentes
            renderStockMovements(); // Renderiza o relatório de movimentação de estoque
            renderFinancialReport(); // Renderiza o relatório financeiro
            // Em um aplicativo real, isso pode acionar um relatório do lado do servidor ou uma agregação mais complexa do lado do cliente
            setTimeout(() => {
                showMessage('success', 'Relatório gerado com sucesso!');
            }, 1000); // Simula algum tempo de processamento
        }

        async function exportPDF() {
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            exportPdfBtn.innerHTML = '<span class="spinner"></span> Gerando...';
            exportPdfBtn.disabled = true;

            const reportsSection = document.getElementById('reportsSection');
            
            try {
                const canvas = await html2canvas(reportsSection, { scale: 2 }); // Escala maior para melhor qualidade
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 297; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`relatorio-angeli-${new Date().toISOString().split('T')[0]}.pdf`);
                showMessage('success', 'PDF gerado e salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showMessage('error', 'Erro ao gerar o PDF. Tente novamente.');
            } finally {
                exportPdfBtn.innerHTML = '<i class="fas fa-file-export"></i> Exportar PDF';
                exportPdfBtn.disabled = false;
            }
        }

        /**
         * Exporta todos os relatórios para um arquivo Excel (.xlsx) com múltiplas abas.
         */
        async function exportAllToExcel() {
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            exportExcelBtn.innerHTML = '<span class="spinner"></span> Gerando...';
            exportExcelBtn.disabled = true;
            showMessage('info', 'Preparando dados para exportação Excel...');

            try {
                const workbook = XLSX.utils.book_new();
                const today = new Date();
                
                // === ABA 1: DASHBOARD EXECUTIVO ===
                const totalVendas = appData.sales.reduce((sum, sale) => sum + sale.amount, 0);
                const totalProdutos = appData.products.length;
                const totalClientes = [...new Set(appData.sales.map(s => s.customer))].length;
                const ticketMedio = totalVendas / (appData.sales.length || 1);
                
                const dashboardData = [
                    ['DASHBOARD EXECUTIVO', '', '', ''],
                    ['Período:', new Date().toLocaleDateString('pt-BR'), '', ''],
                    ['', '', '', ''],
                    ['KPIs PRINCIPAIS', '', '', ''],
                    ['Total Vendas:', `R$ ${totalVendas.toFixed(2)}`, '', ''],
                    ['Número Vendas:', appData.sales.length, '', ''],
                    ['Ticket Médio:', `R$ ${ticketMedio.toFixed(2)}`, '', ''],
                    ['Total Produtos:', totalProdutos, '', ''],
                    ['Total Clientes:', totalClientes, '', ''],
                    ['Estoque Baixo:', appData.products.filter(p => getTotalProductStock(p) < 5).length, '', '']
                ];
                
                const wsDashboard = XLSX.utils.aoa_to_sheet(dashboardData);
                XLSX.utils.book_append_sheet(workbook, wsDashboard, 'Dashboard Executivo');
                
                // === ABA 2: ANÁLISE DE CLIENTES ===
                const clientAnalysis = {};
                appData.sales.forEach(sale => {
                    if (!clientAnalysis[sale.customer]) {
                        clientAnalysis[sale.customer] = { totalCompras: 0, valorTotal: 0, ultimaCompra: sale.date };
                    }
                    clientAnalysis[sale.customer].totalCompras++;
                    clientAnalysis[sale.customer].valorTotal += sale.amount;
                    if (new Date(sale.date) > new Date(clientAnalysis[sale.customer].ultimaCompra)) {
                        clientAnalysis[sale.customer].ultimaCompra = sale.date;
                    }
                });
                
                const clientsData = Object.entries(clientAnalysis)
                    .map(([name, data]) => ({
                        'Cliente': name,
                        'Total Compras': data.totalCompras,
                        'Valor Total': data.valorTotal,
                        'Ticket Médio': data.valorTotal / data.totalCompras,
                        'Última Compra': new Date(data.ultimaCompra).toLocaleDateString('pt-BR'),
                        'Classificação': data.valorTotal > ticketMedio * 2 ? 'VIP' : data.valorTotal > ticketMedio ? 'Premium' : 'Regular'
                    }))
                    .sort((a, b) => b['Valor Total'] - a['Valor Total']);
                
                const wsClients = XLSX.utils.json_to_sheet(clientsData);
                XLSX.utils.book_append_sheet(workbook, wsClients, 'Análise Clientes');
                
                // === ABA 3: ANÁLISE DE PRODUTOS ===
                const productAnalysis = {};
                appData.sales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productAnalysis[item.name]) {
                            const product = appData.products.find(p => p.id === item.productId);
                            productAnalysis[item.name] = {
                                categoria: product?.category || 'N/A',
                                quantidadeVendida: 0,
                                receitaTotal: 0,
                                estoqueAtual: getTotalProductStock(product || {})
                            };
                        }
                        productAnalysis[item.name].quantidadeVendida += item.quantity;
                        productAnalysis[item.name].receitaTotal += (item.quantity * item.price);
                    });
                });
                
                const productsAnalysisData = Object.entries(productAnalysis)
                    .map(([name, data]) => ({
                        'Produto': name,
                        'Categoria': data.categoria,
                        'Qtd Vendida': data.quantidadeVendida,
                        'Receita Total': data.receitaTotal,
                        'Estoque Atual': data.estoqueAtual,
                        'Giro Estoque': data.estoqueAtual > 0 ? (data.quantidadeVendida / data.estoqueAtual).toFixed(2) : 'N/A',
                        'Status': data.estoqueAtual < 5 ? 'CRÍTICO' : data.estoqueAtual < 10 ? 'BAIXO' : 'OK'
                    }))
                    .sort((a, b) => b['Receita Total'] - a['Receita Total']);
                
                const wsProductsAnalysis = XLSX.utils.json_to_sheet(productsAnalysisData);
                XLSX.utils.book_append_sheet(workbook, wsProductsAnalysis, 'Análise Produtos');

                // --- Aba de Produtos ---
                const productsData = appData.products.map(p => ({
                    'ID Produto': p.id,
                    'Nome': p.name,
                    'SKU': p.sku,
                    'Categoria': p.category,
                    'Preço': p.price,
                    'Estoque': p.stock,
                    'Descrição': p.description
                }));
                const productsSheet = XLSX.utils.json_to_sheet(productsData);
                XLSX.utils.book_append_sheet(workbook, productsSheet, 'Produtos');

                // --- Aba de Resumo de Vendas ---
                const salesSummaryData = appData.sales.map(s => {
                    const numItems = s.items ? s.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
                    return {
                        'ID Venda': s.id,
                        'Data': new Date(s.date + 'T00:00:00').toLocaleDateString('pt-BR'), // CORREÇÃO AQUI
                        'Cliente': s.customer,
                        'Valor Total': s.amount,
                        'Forma Pagamento': s.payment,
                        'Status': s.status,
                        'Num. Parcelas': s.installments || 1,
                        'Juros (%)': s.interest || 0,
                        'Num. Itens': numItems
                    };
                });
                const salesSummarySheet = XLSX.utils.json_to_sheet(salesSummaryData);
                XLSX.utils.book_append_sheet(workbook, salesSummarySheet, 'Vendas Resumo');

                // --- Aba de Valores a Receber ---
                const receivablesData = [];
                
                appData.sales.forEach(sale => {
                    if (sale.paymentMethod === 'installment' && sale.installmentList) {
                        sale.installmentList.forEach(installment => {
                            if (installment.status === 'pending') {
                                const dueDate = new Date(installment.dueDate.split('/').reverse().join('-'));
                                const isOverdue = dueDate < today;
                                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                                
                                receivablesData.push({
                                    'ID Venda': `#V${sale.id.toString().padStart(4, '0')}`,
                                    'Cliente': sale.customer,
                                    'Parcela': `${installment.number}/${sale.installments}`,
                                    'Valor': installment.amount,
                                    'Vencimento': installment.dueDate,
                                    'Status': isOverdue ? 'EM ATRASO' : 'PENDENTE',
                                    'Dias': isOverdue ? `${Math.abs(daysDiff)} dias em atraso` : `${daysDiff} dias para vencer`,
                                    'Data Venda': new Date(sale.date + 'T00:00:00').toLocaleDateString('pt-BR')
                                });
                            }
                        });
                    }
                });
                
                receivablesData.sort((a, b) => {
                    const dateA = new Date(a.Vencimento.split('/').reverse().join('-'));
                    const dateB = new Date(b.Vencimento.split('/').reverse().join('-'));
                    return dateA - dateB;
                });
                
                const receivablesSheet = XLSX.utils.json_to_sheet(receivablesData);
                XLSX.utils.book_append_sheet(workbook, receivablesSheet, 'Valores a Receber');
                
                // --- Aba de Movimentação de Estoque ---
                const allStockMovements = generateStockMovementsData(true);
                const stockMovementsData = allStockMovements.map(m => ({
                    'Data': new Date(m.date + 'T00:00:00').toLocaleDateString('pt-BR'),
                    'Tipo': m.type,
                    'Produto': `${m.productName} (${m.productSku})`,
                    'Quantidade': m.quantity,
                    'Valor Unitário': m.unitValue,
                    'Valor Total': m.totalValue,
                    'Estoque Final': m.finalStock,
                    'Cliente/Obs': m.clientOrNotes
                }));
                const stockMovementsSheet = XLSX.utils.json_to_sheet(stockMovementsData);
                XLSX.utils.book_append_sheet(workbook, stockMovementsSheet, 'Movimentação Estoque');

                // --- Aba de Relatório Financeiro Completo ---
                const allFinancialData = generateFinancialReportData(true); // Gera todos os dados financeiros para exportação
                const financialReportData = allFinancialData.map(f => ({
                    'Data Venda': new Date(f.saleDate + 'T00:00:00').toLocaleDateString('pt-BR'), // CORREÇÃO AQUI
                    'Cliente': f.customer,
                    'Produtos Vendidos': f.productsSold,
                    'Forma Pagamento': f.paymentMethod,
                    'Valor Total Venda': f.totalSaleValue,
                    'Parcelado?': f.isInstallment ? 'Sim' : 'Não',
                    'Qtd Parcelas': f.installmentCount,
                    'Valor Parcela': f.installmentValue,
                    'Juros Aplicados': f.interestApplied,
                    'Valor Já Recebido': f.amountReceived,
                    'Valor Pendente': f.amountPending,
                    'Status Venda': f.saleStatus
                }));
                const financialReportSheet = XLSX.utils.json_to_sheet(financialReportData);
                XLSX.utils.book_append_sheet(workbook, financialReportSheet, 'Relatório Financeiro');

                // Salva o arquivo Excel
                const timestamp = today.toISOString().replace(/[:.-]/g, '');
                XLSX.writeFile(workbook, `relatorio_avancado_${timestamp}.xlsx`);

                showMessage('success', 'Relatório Excel avançado gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                showMessage('error', 'Falha ao exportar para Excel. Verifique o console para detalhes.');
            } finally {
                exportExcelBtn.innerHTML = '<i class="fas fa-file-excel"></i> Exportar Excel';
                exportExcelBtn.disabled = false;
            }
        }


        // --- Atualização do Painel ---
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = appData.products.length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthSales = appData.sales
                .filter(sale => {
                    const saleDate = new Date(sale.date + 'T00:00:00'); // CORREÇÃO AQUI
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((sum, sale) => sum + sale.amount, 0);
            document.getElementById('monthSales').textContent = `R$ ${monthSales.toFixed(2)}`;
            
            const lowStock = appData.products.filter(product => {
                const totalStock = getTotalProductStock(product);
                return totalStock < 5;
            }).length;
            document.getElementById('lowStock').textContent = lowStock;
            
            // Calcula a receita pendente somando apenas as parcelas *não pagas* de vendas parceladas
            const pendingRevenue = appData.sales
                .filter(sale => sale.paymentMethod === 'installment') // Apenas vendas parceladas
                .reduce((totalPending, sale) => {
                    // Soma o valor das parcelas que ainda estão 'pending' ou 'overdue'
                    const salePendingAmount = sale.installmentList.reduce((sum, installment) => {
                        if (installment.status !== 'paid') {
                            return sum + installment.amount;
                        }
                        return sum;
                    }, 0);
                    return totalPending + salePendingAmount;
                }, 0);

            document.getElementById('pendingRevenue').textContent = `R$ ${pendingRevenue.toFixed(2)}`;
            
            const lastMonthSales = appData.sales
                .filter(sale => {
                    const saleDate = new Date(sale.date + 'T00:00:00'); // CORREÇÃO AQUI
                    const prevMonth = new Date();
                    prevMonth.setMonth(currentMonth - 1); // Obtém a data do mês anterior
                    return saleDate.getMonth() === prevMonth.getMonth() && saleDate.getFullYear() === prevMonth.getFullYear();
                })
                .reduce((sum, sale) => sum + sale.amount, 0);
            
            let salesTrend = 0;
            if (lastMonthSales > 0) {
                salesTrend = Math.round(((monthSales - lastMonthSales) / lastMonthSales) * 100);
            } else if (monthSales > 0) {
                salesTrend = 100; // Se o mês passado foi zero, mas o mês atual tem vendas, é um aumento de 100%
            }
                
            document.getElementById('salesTrend').textContent = `${salesTrend >= 0 ? '+' : ''}${salesTrend}%`;
            document.getElementById('salesTrend').className = salesTrend >= 0 ? 'trend-up' : 'trend-down';
        }

        // --- Inicialização de Gráficos ---
        let salesChart, topProductsChart, categoryChart; // Variáveis globais de gráficos para destruir os existentes

        function initCharts() {
            // Obtém dados de vendas por mês
            const salesByMonth = Array(6).fill(0);
            const monthLabels = Array.from({length: 6}, (_, i) => {
                const month = new Date();
                month.setMonth(month.getMonth() - (5 - i));
                return month.toLocaleString('pt-BR', { month: 'short' });
            });
            const currentDate = new Date();
            
            appData.sales.forEach(sale => {
                const saleDate = new Date(sale.date + 'T00:00:00'); // CORREÇÃO AQUI
                const monthDiff = (currentDate.getFullYear() - saleDate.getFullYear()) * 12 + 
                                (currentDate.getMonth() - saleDate.getMonth());
                
                if (monthDiff >= 0 && monthDiff < 6) {
                    salesByMonth[5 - monthDiff] += sale.amount;
                }
            });
            
            // Obtém os produtos mais vendidos
            const productSales = {};
            appData.sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = 0;
                    }
                    productSales[item.name] += item.quantity;
                });
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topProductNames = sortedProducts.map(p => p[0]);
            const topProductSales = sortedProducts.map(p => p[1]);
            
            // Obtém vendas por categoria
            const salesByCategory = {};
            // Inicializa com todas as categorias existentes dos produtos
            const allCategories = [...new Set(appData.products.map(p => p.category))];
            allCategories.forEach(cat => salesByCategory[cat] = 0);

            appData.sales.forEach(sale => {
                sale.items.forEach(item => {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product && salesByCategory[product.category] !== undefined) {
                        salesByCategory[product.category] += item.quantity * item.price;
                    }
                });
            });
            
            const categories = Object.keys(salesByCategory).filter(cat => salesByCategory[cat] > 0);
            const categorySales = categories.map(cat => salesByCategory[cat]);

            // Gráfico de Vendas
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) salesChart.destroy();
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: salesByMonth,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });

            // Gráfico dos Produtos Mais Vendidos
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            if (topProductsChart) topProductsChart.destroy();
            topProductsChart = new Chart(topProductsCtx, {
                type: 'bar',
                data: {
                    labels: topProductNames,
                    datasets: [{
                        label: 'Unidades Vendidas',
                        data: topProductSales,
                        backgroundColor: Array(topProductNames.length).fill(getComputedStyle(document.body).getPropertyValue('--primary').replace(')', ', 0.7)')),
                        borderColor: getComputedStyle(document.body).getPropertyValue('--primary-dark'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        y: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });

            // Gráfico por Categoria
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Vendas por Categoria',
                        data: categorySales,
                        backgroundColor: categories.map((_, i) => 
                            `hsl(${i * 360 / categories.length}, 70%, 60%)`
                        ),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
        }

        // --- Relatório de Movimentação de Estoque ---

        /**
         * Gera e retorna os dados de movimentação de estoque.
         * @param {boolean} includeAll - Se true, retorna todos os movimentos sem aplicar filtros de UI.
         * @returns {Array<Object>} Lista de objetos de movimentação de estoque.
         */
        function generateStockMovementsData(includeAll = false) {
            let movements = [];

            // Adiciona movimentos de venda (redução de estoque)
            appData.sales.forEach(sale => {
                sale.items.forEach(item => {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        // Para vendas, o estoque final é o estoque do produto ANTES desta venda
                        // Isso é um pouco complexo de rastrear historicamente com a estrutura atual.
                        // Para simplificar, o "Estoque Final" aqui representa o estoque atual do produto.
                        // Em um sistema real, você teria um log de estoque com snapshots.
                        movements.push({
                            date: sale.date,
                            type: "Venda",
                            productId: item.productId,
                            productName: product.name,
                            productSku: product.sku,
                            quantity: -item.quantity, // Quantidade negativa para saída
                            unitValue: item.price,
                            totalValue: item.quantity * item.price,
                            finalStock: product.stock + item.quantity, // Estoque antes desta venda
                            clientOrNotes: `Venda para ${sale.customer} (ID: #V${sale.id.toString().padStart(4, '0')})`
                        });
                    }
                });
            });

            // Adiciona movimentos simulados (Entrada, Ajuste, Devolução)
            appData.simulatedStockMovements.forEach(movement => {
                const product = appData.products.find(p => p.id === movement.productId);
                if (product) {
                    movements.push({
                        date: movement.date,
                        type: movement.type,
                        productId: movement.productId,
                        productName: product.name,
                        productSku: product.sku,
                        quantity: movement.quantity,
                        unitValue: movement.unitValue,
                        totalValue: Math.abs(movement.quantity) * movement.unitValue,
                        finalStock: movement.finalStock,
                        clientOrNotes: movement.clientOrNotes
                    });
                }
            });

            // Ordena os movimentos por data
            movements.sort((a, b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00')); // CORREÇÃO AQUI

            if (includeAll) {
                return movements;
            } else {
                return applyStockMovementFilters(movements);
            }
        }

        function applyStockMovementFilters(movements) {
            const startDate = document.getElementById('stockMoveDateFilterStart').value;
            const endDate = document.getElementById('stockMoveDateFilterEnd').value;
            const searchTerm = document.getElementById('stockMoveProductSearch').value.toLowerCase();
            const typeFilter = document.getElementById('stockMoveTypeFilter').value;

            return movements.filter(move => {
                const moveDate = new Date(move.date + 'T00:00:00'); // CORREÇÃO AQUI
                const matchesDate = (!startDate || moveDate >= new Date(startDate + 'T00:00:00')) && (!endDate || moveDate <= new Date(endDate + 'T23:59:59'));
                const matchesProduct = searchTerm === '' || move.productName.toLowerCase().includes(searchTerm) || move.productSku.toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === '' || move.type === typeFilter;

                return matchesDate && matchesProduct && matchesType;
            });
        }

        function renderStockMovements() {
            const stockMovementsTableBody = document.getElementById('stockMovementsTableBody');
            stockMovementsTableBody.innerHTML = '';
            
            const filteredMovements = generateStockMovementsData(); // Já aplica os filtros

            if (filteredMovements.length === 0) {
                document.getElementById('stockMovementsEmptyState').style.display = 'block';
                return;
            } else {
                document.getElementById('stockMovementsEmptyState').style.display = 'none';
            }

            filteredMovements.forEach(move => {
                const row = document.createElement('tr');
                const quantityClass = move.quantity < 0 ? 'text-danger' : 'text-success'; // Para estilizar quantidades
                const quantitySign = move.quantity > 0 ? '+' : '';

                row.innerHTML = `
                    <td>${new Date(move.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td> <!-- CORREÇÃO AQUI -->
                    <td>${move.type}</td>
                    <td>${move.productName} (${move.productSku})</td>
                    <td class="${quantityClass}">${quantitySign}${move.quantity}</td>
                    <td>R$ ${move.unitValue.toFixed(2)}</td>
                    <td>R$ ${move.totalValue.toFixed(2)}</td>
                    <td>${move.finalStock}</td>
                    <td>${move.clientOrNotes || '-'}</td>
                `;
                stockMovementsTableBody.appendChild(row);
            });
        }

        function filterStockMovements() {
            renderStockMovements();
        }

        // --- Relatório Financeiro Completo ---

        /**
         * Gera e retorna os dados para o relatório financeiro completo.
         * @param {boolean} includeAll - Se true, retorna todos os dados sem aplicar filtros de UI.
         * @returns {Array<Object>} Lista de objetos de dados financeiros.
         */
        function generateFinancialReportData(includeAll = false) {
            let financialData = [];

            appData.sales.forEach(sale => {
                const productsSoldList = sale.items.map(item => `${item.name} (${item.quantity}x)`).join(', ');
                
                let amountReceived = 0;
                let amountPending = sale.amount; // Começa com o valor total da venda
                let currentSaleStatus = sale.status;

                if (sale.paymentMethod === 'installment' && sale.installmentList) {
                    amountReceived = sale.installmentList
                        .filter(inst => inst.status === 'paid')
                        .reduce((sum, inst) => sum + inst.amount, 0);
                    amountPending = sale.amount - amountReceived;

                    const hasOverdueInstallment = sale.installmentList.some(inst => 
                        inst.status === 'pending' && new Date(inst.dueDate.split('/').reverse().join('-') + 'T00:00:00') < new Date() // CORREÇÃO AQUI
                    );
                    const allInstallmentsPaid = sale.installmentList.every(inst => inst.status === 'paid');

                    if (hasOverdueInstallment) {
                        currentSaleStatus = 'Atrasado';
                    } else if (allInstallmentsPaid) {
                        currentSaleStatus = 'Pago';
                    } else {
                        currentSaleStatus = 'Pendente';
                    }
                } else {
                    // Para vendas à vista ou crédito, o valor recebido é o total e o pendente é zero
                    amountReceived = sale.amount;
                    amountPending = 0;
                    currentSaleStatus = 'Pago';
                }

                financialData.push({
                    saleDate: sale.date,
                    customer: sale.customer,
                    productsSold: productsSoldList,
                    paymentMethod: sale.payment,
                    totalSaleValue: sale.amount,
                    isInstallment: sale.paymentMethod === 'installment',
                    installmentCount: sale.installments || 1,
                    installmentValue: sale.paymentMethod === 'installment' && sale.installments > 0 ? (sale.amount / sale.installments) : sale.amount,
                    interestApplied: sale.interest || 0,
                    amountReceived: amountReceived,
                    amountPending: amountPending,
                    saleStatus: currentSaleStatus
                });
            });

            // Ordena os dados financeiros por data da venda
            financialData.sort((a, b) => new Date(a.saleDate + 'T00:00:00') - new Date(b.saleDate + 'T00:00:00')); // CORREÇÃO AQUI

            if (includeAll) {
                return financialData;
            } else {
                return applyFinancialReportFilters(financialData);
            }
        }

        function applyFinancialReportFilters(data) {
            const startDate = document.getElementById('financeReportDateFilterStart').value;
            const endDate = document.getElementById('financeReportDateFilterEnd').value;
            const statusFilter = document.getElementById('financeReportStatusFilter').value;

            return data.filter(item => {
                const saleDate = new Date(item.saleDate + 'T00:00:00'); // CORREÇÃO AQUI
                const matchesDate = (!startDate || saleDate >= new Date(startDate + 'T00:00:00')) && (!endDate || saleDate <= new Date(endDate + 'T23:59:59'));
                const matchesStatus = statusFilter === '' || item.saleStatus.toLowerCase() === statusFilter;

                return matchesDate && matchesStatus;
            });
        }

        function renderFinancialReport() {
            const financialReportTableBody = document.getElementById('financialReportTableBody');
            financialReportTableBody.innerHTML = '';
            
            const filteredFinancialData = generateFinancialReportData(); // Já aplica os filtros

            if (filteredFinancialData.length === 0) {
                document.getElementById('financialReportEmptyState').style.display = 'block';
                return;
            } else {
                document.getElementById('financialReportEmptyState').style.display = 'none';
            }

            filteredFinancialData.forEach(item => {
                const row = document.createElement('tr');
                let statusBadgeClass = '';
                switch(item.saleStatus) {
                    case 'Pago': statusBadgeClass = 'status-paid'; break;
                    case 'Pendente': statusBadgeClass = 'status-pending'; break;
                    case 'Atrasado': statusBadgeClass = 'status-overdue'; break;
                }

                row.innerHTML = `
                    <td>${new Date(item.saleDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td> <!-- CORREÇÃO AQUI -->
                    <td>${item.customer}</td>
                    <td>${item.productsSold}</td>
                    <td>${item.paymentMethod}</td>
                    <td>R$ ${item.totalSaleValue.toFixed(2)}</td>
                    <td>${item.isInstallment ? 'Sim' : 'Não'}</td>
                    <td>${item.installmentCount}</td>
                    <td>R$ ${item.installmentValue.toFixed(2)}</td>
                    <td>${item.interestApplied.toFixed(1)}%</td>
                    <td>R$ ${item.amountReceived.toFixed(2)}</td>
                    <td>R$ ${item.amountPending.toFixed(2)}</td>
                    <td><span class="status-badge ${statusBadgeClass}">${item.saleStatus}</span></td>
                `;
                financialReportTableBody.appendChild(row);
            });
        }

        function filterFinancialReport() {
            renderFinancialReport();
        }
        
        // --- Geração de Catálogo PDF ---
        async function generateCatalogPDF() {
            try {
                showMessage('info', 'Gerando catálogo PDF...');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                // Cores do tema rosa
                const primaryColor = [255, 105, 180]; // #ff69b4
                const primaryDark = [209, 58, 131];   // #d13a83
                const lightColor = [248, 240, 244];   // #f8f0f4
                
                // Cabeçalho com design rosa
                pdf.setFillColor(...primaryColor);
                pdf.rect(0, 0, 210, 40, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                const storeName = appData.settings.storeName || 'Catálogo de Produtos';
                pdf.text(storeName, 20, 25);
                
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 35);
                
                let yPosition = 60;
                const pageHeight = pdf.internal.pageSize.height;
                
                // Agrupa produtos por categoria
                const productsByCategory = {};
                appData.products.forEach(product => {
                    const category = product.category || 'Sem Categoria';
                    if (!productsByCategory[category]) {
                        productsByCategory[category] = [];
                    }
                    productsByCategory[category].push(product);
                });
                
                // Gera o catálogo por categoria
                for (const [category, products] of Object.entries(productsByCategory)) {
                    // Título da categoria com fundo rosa
                    if (yPosition > pageHeight - 100) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.setFillColor(...lightColor);
                    pdf.rect(15, yPosition - 5, 180, 15, 'F');
                    
                    pdf.setTextColor(...primaryDark);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(category, 20, yPosition + 5);
                    yPosition += 25;
                    
                    // Produtos da categoria em grid 2x1
                    let productIndex = 0;
                    for (const product of products) {
                        const isLeftColumn = productIndex % 2 === 0;
                        const xPosition = isLeftColumn ? 20 : 110;
                        
                        if (!isLeftColumn || yPosition > pageHeight - 80) {
                            if (!isLeftColumn) {
                                // Produto da direita, mesma linha
                            } else {
                                // Nova página
                                pdf.addPage();
                                yPosition = 20;
                            }
                        }
                        
                        // Caixa do produto
                        pdf.setDrawColor(...primaryColor);
                        pdf.setLineWidth(0.5);
                        pdf.rect(xPosition - 5, yPosition - 5, 85, 70, 'S');
                        
                        // Foto do produto (se existir)
                        const productImage = getProductDisplayImage(product);
                        if (productImage) {
                            try {
                                pdf.addImage(productImage, 'JPEG', xPosition, yPosition, 30, 30);
                            } catch (e) {
                                // Se não conseguir adicionar a imagem, mostra ícone
                                pdf.setTextColor(...primaryColor);
                                pdf.setFontSize(20);
                                pdf.text('■', xPosition + 10, yPosition + 20);
                            }
                        } else {
                            // Ícone placeholder
                            pdf.setTextColor(...primaryColor);
                            pdf.setFontSize(20);
                            pdf.text('■', xPosition + 10, yPosition + 20);
                        }
                        
                        // Informações do produto
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFont(undefined, 'bold');
                        pdf.setFontSize(11);
                        const productName = product.name.length > 20 ? product.name.substring(0, 20) + '...' : product.name;
                        pdf.text(productName, xPosition + 35, yPosition + 8);
                        
                        pdf.setFont(undefined, 'normal');
                        pdf.setFontSize(9);
                        pdf.text(`SKU: ${product.sku}`, xPosition + 35, yPosition + 16);
                        
                        // Preço em destaque
                        pdf.setTextColor(...primaryDark);
                        pdf.setFont(undefined, 'bold');
                        pdf.setFontSize(12);
                        pdf.text(`R$ ${product.price.toFixed(2)}`, xPosition + 35, yPosition + 26);
                        
                        // Aviso de últimas unidades se estoque baixo
                        const totalStock = getTotalProductStock(product);
                        if (totalStock > 0 && totalStock < 5) {
                            pdf.setTextColor(220, 53, 69); // Vermelho
                            pdf.setFontSize(8);
                            pdf.text('⚠ Últimas unidades!', xPosition + 35, yPosition + 34);
                        }
                        
                        // Descrição
                        if (product.description) {
                            pdf.setTextColor(100, 100, 100);
                            pdf.setFont(undefined, 'normal');
                            pdf.setFontSize(8);
                            const description = product.description.length > 35 ? 
                                product.description.substring(0, 35) + '...' : product.description;
                            pdf.text(description, xPosition, yPosition + 45);
                        }
                        
                        productIndex++;
                        
                        // Avança linha apenas quando termina a dupla
                        if (productIndex % 2 === 0) {
                            yPosition += 80;
                        }
                    }
                    
                    // Se terminou com produto ímpar, avança linha
                    if (products.length % 2 !== 0) {
                        yPosition += 80;
                    }
                    
                    yPosition += 10;
                }
                
                // Rodapé com informações de contato
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFillColor(...primaryColor);
                    pdf.rect(0, pageHeight - 20, 210, 20, 'F');
                    
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(9);
                    
                    let contactInfo = [];
                    if (appData.settings.storePhone) contactInfo.push(`Tel: ${appData.settings.storePhone}`);
                    if (appData.settings.storeInstagram) contactInfo.push(`${appData.settings.storeInstagram}`);
                    if (appData.settings.storeFacebook) contactInfo.push(`${appData.settings.storeFacebook}`);
                    if (appData.settings.storeWebsite) contactInfo.push(`${appData.settings.storeWebsite}`);
                    
                    const contactText = contactInfo.length > 0 ? contactInfo.join(' | ') : 'Entre em contato para pedidos!';
                    pdf.text(contactText, 20, pageHeight - 10);
                    pdf.text(`Página ${i} de ${totalPages}`, 160, pageHeight - 10);
                }
                
                pdf.save('catalogo-produtos.pdf');
                showMessage('success', 'Catálogo PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao gerar catálogo PDF:', error);
                showMessage('error', 'Erro ao gerar catálogo PDF.');
            }
        }
        
        // --- Histórico do Cliente ---
        function searchCustomerHistory() {
            const searchTerm = document.getElementById('customerHistorySearch').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('customerHistoryResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const customerSales = appData.sales.filter(sale => 
                sale.customer.toLowerCase().includes(searchTerm)
            );
            
            if (customerSales.length === 0) {
                resultsDiv.innerHTML = '<p style="padding: 1rem; text-align: center; color: var(--secondary);">Nenhuma compra encontrada para este cliente.</p>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Agrupa produtos comprados pelo cliente
            const purchasedProducts = {};
            let totalSpent = 0;
            
            customerSales.forEach(sale => {
                totalSpent += sale.amount;
                sale.items.forEach(item => {
                    if (!purchasedProducts[item.productId]) {
                        purchasedProducts[item.productId] = {
                            name: item.name,
                            totalQuantity: 0,
                            totalSpent: 0,
                            lastPurchase: sale.date
                        };
                    }
                    purchasedProducts[item.productId].totalQuantity += item.quantity;
                    purchasedProducts[item.productId].totalSpent += (item.quantity * item.price);
                    
                    if (new Date(sale.date) > new Date(purchasedProducts[item.productId].lastPurchase)) {
                        purchasedProducts[item.productId].lastPurchase = sale.date;
                    }
                });
            });
            
            let html = `
                <div style="padding: 1rem; border: 1px solid #eee; border-radius: var(--radius); background: var(--card-bg);">
                    <h4>Histórico de ${customerSales[0].customer}</h4>
                    <p><strong>Total de compras:</strong> ${customerSales.length}</p>
                    <p><strong>Valor total gasto:</strong> R$ ${totalSpent.toFixed(2)}</p>
                    <p><strong>Ticket médio:</strong> R$ ${(totalSpent / customerSales.length).toFixed(2)}</p>
                    
                    <h5 style="margin-top: 1rem;">Produtos mais comprados:</h5>
                    <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            Object.values(purchasedProducts)
                .sort((a, b) => b.totalQuantity - a.totalQuantity)
                .slice(0, 10)
                .forEach(product => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f5f5f5;">
                            <div>
                                <strong>${product.name}</strong><br>
                                <small>Qtd total: ${product.totalQuantity} | Última compra: ${new Date(product.lastPurchase).toLocaleDateString('pt-BR')}</small>
                            </div>
                            <div style="text-align: right;">
                                <strong>R$ ${product.totalSpent.toFixed(2)}</strong>
                            </div>
                        </div>
                    `;
                });
            
            html += `
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="suggestReorders('${customerSales[0].customer}')">
                        <i class="fas fa-sync"></i> Sugerir Reposição
                    </button>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function suggestReorders(customerName) {
            const customerSales = appData.sales.filter(sale => sale.customer === customerName);
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            const recentPurchases = {};
            customerSales.forEach(sale => {
                if (new Date(sale.date) >= thirtyDaysAgo) {
                    sale.items.forEach(item => {
                        if (!recentPurchases[item.productId]) {
                            recentPurchases[item.productId] = {
                                name: item.name,
                                quantity: 0
                            };
                        }
                        recentPurchases[item.productId].quantity += item.quantity;
                    });
                }
            });
            
            if (Object.keys(recentPurchases).length === 0) {
                showMessage('info', 'Nenhuma compra recente encontrada para sugestões.');
                return;
            }
            
            let message = `*Sugestão de Reposição para ${customerName}*\n\n`;
            message += `Olá! Com base no seu histórico de compras dos últimos 30 dias, sugerimos:\n\n`;
            
            Object.values(recentPurchases).forEach(product => {
                message += `• ${product.name} (comprou ${product.quantity}x recentemente)\n`;
            });
            
            message += `\nGostaria de fazer um novo pedido? Entre em contato!`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        async function saveStoreInfo() {
            const storeInfo = {
                storeName: document.getElementById('storeName').value.trim(),
                storePhone: document.getElementById('storePhone').value.trim(),
                storeInstagram: document.getElementById('storeInstagram').value.trim(),
                storeFacebook: document.getElementById('storeFacebook').value.trim(),
                storeWebsite: document.getElementById('storeWebsite').value.trim()
            };
            
            for (const [key, value] of Object.entries(storeInfo)) {
                appData.settings[key] = value;
                await saveAppSetting(key, value);
            }
            
            showMessage('success', 'Informações da loja salvas!');
        }
        
        function loadStoreInfo() {
            document.getElementById('storeName').value = appData.settings.storeName || '';
            document.getElementById('storePhone').value = appData.settings.storePhone || '';
            document.getElementById('storeInstagram').value = appData.settings.storeInstagram || '';
            document.getElementById('storeFacebook').value = appData.settings.storeFacebook || '';
            document.getElementById('storeWebsite').value = appData.settings.storeWebsite || '';
        }
        



        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', async function() {
            // Nota importante: Para que o IndexedDB funcione corretamente e persista os dados,
            // este arquivo HTML deve ser servido por um servidor web (mesmo que local),
            // e não aberto diretamente do sistema de arquivos (ex: file:///C:/...).
            // Se você estiver vendo erros de IndexedDB ou dados não persistindo,
            // use ferramentas como o Live Server (para VS Code) ou `python -m http.server`
            // para servir o arquivo via HTTP.
            await openIndexedDB();
            await loadAllDataAndRender(); // Carrega os dados do DB e então renderiza a UI
            
            // Define a data atual para os filtros de data
            const today = getLocalDateString(); // Usando a função para obter a data local
            document.getElementById('saleDateFilterEnd').value = today;
            document.getElementById('stockMoveDateFilterEnd').value = today;
            document.getElementById('financeReportDateFilterEnd').value = today;

            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            document.getElementById('saleDateFilterStart').value = sixMonthsAgo.toISOString().split('T')[0];
            document.getElementById('stockMoveDateFilterStart').value = sixMonthsAgo.toISOString().split('T')[0];
            document.getElementById('financeReportDateFilterStart').value = sixMonthsAgo.toISOString().split('T')[0];
        });
    </script>

    <!-- Footer -->
    <footer style="
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        padding: 2rem 1rem 1rem;
        margin-top: 3rem;
        text-align: center;
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
        box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
    ">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 1.5rem;">
                <p style="font-size: 0.95rem; margin-bottom: 1.5rem; opacity: 0.9; font-weight: 500;">
                    O sistema de gestão completo para pequenos e médios negócios que buscam eficiência, controle e crescimento.
                </p>
                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; font-size: 0.85rem; margin-bottom: 1.5rem;">
                    <a href="#" onclick="openLegalModal('privacy')" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.3s ease; cursor: pointer;" 
                       onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">
                        Política de Privacidade
                    </a>
                    <a href="#" onclick="openLegalModal('terms')" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.3s ease; cursor: pointer;"
                       onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">
                        Termos de Uso
                    </a>
                    <a href="#" onclick="openLegalModal('security')" style="color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: color 0.3s ease; cursor: pointer;"
                       onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255, 255, 255, 0.8)'">
                        Segurança de Dados
                    </a>
                </div>
                <p style="font-size: 0.9rem; opacity: 0.9;">
                    © 2025 Angeli - Sistema de Gestão de Vendas e Estoque. Todos os direitos reservados.
                </p>
            </div>
        </div>
    </footer>
</body>
</html>
